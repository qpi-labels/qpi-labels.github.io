<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>QISS - Mac OS 8</title>
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google CSE -->
    <script async src="https://cse.google.com/cse.js?cx=b794e851ac2524ee7"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>

    <style>
        /* ----------------------------------------------------------------
           MAC OS 8/9 (PLATINUM THEME)
           ---------------------------------------------------------------- */
        :root {
            --plat-bg: #DDDDDD; /* The classic Mac gray */
            --plat-border-light: #FFFFFF;
            --plat-border-dark: #555555;
            --plat-border-black: #000000;
            --plat-blue: #0000CC; /* Mac Link Blue */
            --plat-purple: #660099;
            --plat-highlight: #CCCCFF; /* Selected text/item color */
        }

        @font-face {
            font-family: 'Charcoal';
            src: local('Charcoal'), local('Geneva'), local('Verdana'), local('Sans-serif');
        }

        body {
            /* Classic "Desktop" Pattern (Bondi Blueish or just Pattern) */
            background-color: #6699CC;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 1px, rgba(255,255,255,0.2) 1px, rgba(255,255,255,0.2) 2px),
                linear-gradient(to bottom, #6699CC, #336699);
            font-family: "Charcoal", "Geneva", "Verdana", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: black;
        }

        /* 메인 윈도우 프레임 */
        .window {
            width: 90%;
            max-width: 950px;
            background: var(--plat-bg);
            border: 1px solid var(--plat-border-black);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.3); /* Hard shadow */
            display: flex;
            flex-direction: column;
            margin: 20px 0;
            padding: 3px; /* Frame spacing */
        }

        /* 윈도우 내부 베벨 효과 */
        .window-inner {
            border-top: 1px solid var(--plat-border-light);
            border-left: 1px solid var(--plat-border-light);
            border-right: 1px solid var(--plat-border-dark);
            border-bottom: 1px solid var(--plat-border-dark);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* 타이틀 바 (Platinum Pinstripes) */
        .title-bar {
            background-color: #DDD;
            /* The stripes */
            background-image: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0,0,0,0.1) 50%
            );
            background-size: 100% 2px;
            
            height: 20px;
            display: flex;
            justify-content: space-between; /* Spread controls */
            align-items: center;
            padding: 2px 4px;
            border-bottom: 1px solid #999;
            margin-bottom: 2px;
        }

        /* 타이틀 텍스트 (흰색 배경 위에) */
        .title-bar-text {
            background: var(--plat-bg);
            padding: 0 10px;
            font-weight: bold;
            font-size: 13px;
            color: black;
            position: relative;
            top: -1px;
        }

        /* 윈도우 컨트롤 (박스형) */
        .title-btn {
            width: 12px;
            height: 12px;
            background: var(--plat-bg);
            border: 1px solid var(--plat-border-black);
            box-shadow: inset 1px 1px 0 var(--plat-border-light), 
                        inset -1px -1px 0 var(--plat-border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }
        
        .title-btn:active {
            box-shadow: inset 1px 1px 0 var(--plat-border-black);
        }

        /* Close Box Icon */
        .close-box::after { content: ""; display: block; width: 6px; height: 6px; border: 1px solid black; }
        
        /* Collapse/Zoom Box Icon */
        .zoom-box { margin-left: 2px; }
        .collapse-box { display: flex; align-items: center; justify-content: center; }
        .collapse-box::after { content: ""; display: block; width: 6px; height: 2px; background: black; }
        .zoom-box::after { content: ""; display: block; width: 4px; height: 4px; border: 1px solid black; }
        
        .right-controls { display: flex; gap: 3px; }

        /* 메인 컨텐츠 영역 */
        .viewport {
            padding: 20px;
            background: white;
            border: 1px solid var(--plat-border-black);
            /* Inset look */
            box-shadow: inset 1px 1px 0 #000, inset 2px 2px 0 #888; 
            min-height: 70vh;
            overflow-y: auto;
            margin: 5px;
        }

        h1.page-title {
            font-size: 32px;
            text-align: center;
            margin: 10px 0 20px 0;
            font-weight: bold;
            font-family: "Impact", "Charcoal", sans-serif;
            letter-spacing: 1px;
        }

        /* Platinum Buttons */
        button {
            background: var(--plat-bg);
            border: 1px solid var(--plat-border-black);
            border-radius: 4px;
            box-shadow: inset 1px 1px 0 var(--plat-border-light),
                        inset -1px -1px 0 var(--plat-border-dark),
                        1px 1px 1px rgba(0,0,0,0.15); /* Drop shadow */
            color: black;
            padding: 4px 14px;
            font-family: "Charcoal", "Geneva", sans-serif;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            min-width: 70px;
        }
        
        button:active {
            background: #aaa;
            box-shadow: inset 1px 1px 0 var(--plat-border-black),
                        inset 2px 2px 0 #888;
        }

        button:disabled {
            color: #888;
            text-shadow: 1px 1px 0 white;
            cursor: wait;
        }
        
        button.primary-btn {
            border: 2px solid var(--plat-border-black); /* Default button emphasis */
            padding: 3px 13px;
        }

        /* Inputs */
        input[type="text"], input[type="password"] {
            border: 1px solid var(--plat-border-black);
            box-shadow: inset 1px 1px 0 #888;
            padding: 4px;
            font-family: "Geneva", sans-serif;
            font-size: 13px;
            border-radius: 0;
            background: white;
        }

        /* Mode Toggle */
        #mode-toggle { display: block; margin: 0 auto; width: 140px; font-weight: bold; }
        
        /* Search Box Wrapper */
        .search-wrapper {
            background: #eee;
            border: 1px solid #aaa;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: inset 1px 1px 0 white;
        }

        #custom-search { text-align: center; }
        .search-bar { width: 70%; max-width: 500px; }
        #search-buttons { margin-top: 10px; display: flex; gap: 5px; justify-content: center; }

        /* ==========================================================================
           GOOGLE CSE OVERRIDES (Platinum Style)
           ========================================================================== */
        .gsc-control-cse {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            font-family: "Geneva", sans-serif !important;
        }
        
        .gsc-search-box { margin-bottom: 15px !important; }
        .gsc-input-box {
            border: 1px solid black !important;
            border-radius: 0 !important;
            background: white !important;
            box-shadow: inset 1px 1px 0 #888 !important;
        }
        input.gsc-input { padding: 4px !important; font-size: 13px !important; }
        
        .gsc-search-button-v2 {
            background: var(--plat-bg) !important;
            border: 1px solid black !important;
            border-radius: 4px !important;
            padding: 5px 15px !important;
            box-shadow: inset 1px 1px 0 white, inset -1px -1px 0 #555 !important;
            margin-left: 8px !important;
        }
        .gsc-search-button-v2 svg { fill: black !important; }
        .gsc-search-button-v2:active {
             background: #aaa !important;
             box-shadow: inset 1px 1px 0 black !important;
        }

        /* Search Results */
        .gsc-webResult.gsc-result {
            background: transparent !important;
            border-bottom: 1px dotted #999 !important;
            padding: 15px 0 !important;
            margin: 0 !important;
        }

        /* Titles (Classic Mac Web) */
        .gs-title {
            height: auto !important;
            overflow: visible !important;
            line-height: normal !important;
            margin-bottom: 3px !important;
        }
        .gs-title a {
            color: var(--plat-blue) !important;
            font-family: "Geneva", "Verdana", sans-serif !important;
            font-size: 14px !important;
            font-weight: bold !important;
            text-decoration: underline !important;
        }
        .gs-title a:visited { color: var(--plat-purple) !important; }

        /* Snippet */
        .gs-snippet {
            font-family: "Geneva", sans-serif !important;
            font-size: 12px !important;
            color: black !important;
            line-height: 1.4 !important;
        }
        
        /* URL */
        .gsc-url-top, .gs-visibleUrl {
            color: #006600 !important;
            font-family: "Geneva", sans-serif !important;
            font-size: 10px !important;
        }

        /* Images (Standard) */
        .gs-image-box { margin-right: 10px !important; }
        img.gs-image { border: 1px solid black !important; }

        /* Pagination */
        .gsc-cursor-box { margin-top: 20px !important; text-align: center !important; }
        .gsc-cursor-page {
            color: black !important;
            margin: 0 2px !important;
            padding: 2px 6px !important;
            text-decoration: none !important;
            background: var(--plat-bg) !important;
            border: 1px solid black !important;
            font-size: 11px !important;
        }
        .gsc-cursor-current-page {
            color: white !important;
            background: black !important;
            font-weight: bold !important;
        }

        .gsc-adBlock, .gsc-above-wrapper-area { display: none !important; }
        
        /* ========================================================================== */

        /* AI Summary (SimpleText / Stickies) */
        #gemini-summary-container { display: none; margin: 20px 0; }
        #gemini-summary {
            background: #FFFFCC; /* Stickies Yellow or SimpleText White */
            background: white;
            border: 1px solid black;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            font-family: "Monaco", "Courier New", monospace;
        }
        .summary-header {
            background: #DDD;
            padding: 4px 8px;
            font-size: 11px;
            border-bottom: 1px solid black;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #gemini-summary-content {
            padding: 15px;
            font-size: 12px;
            line-height: 1.5;
            color: black;
        }
        
        /* Modal (Standard Mac Dialog) */
        #api-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.0); z-index: 9999; align-items: center; justify-content: center; }
        #api-modal.show { display: flex; }

        .modal-window {
            background: var(--plat-bg);
            width: 350px;
            border: 2px solid black; /* Dialogs had thick borders */
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
            padding: 3px;
        }
        
        .modal-inner {
            border: 1px solid #888;
            padding: 15px;
            text-align: center;
        }

        /* Trust Result */
        .trust-result {
            background: #F0F0F0;
            border: 1px solid black;
            padding: 6px;
            font-size: 11px;
            margin-top: 5px;
        }
        .trust-score.high { color: #009900; font-weight: bold; }
        .trust-score.medium { color: #CC9900; font-weight: bold; }
        .trust-score.low { color: #CC0000; font-weight: bold; }

        /* Footer */
        #current-time { font-size: 11px; font-family: "Monaco", monospace; margin-top: 15px; }
        #credit { font-size: 10px; color: #555; }
        
        /* Mac OS 8 Scrollbar */
        ::-webkit-scrollbar { width: 16px; background: white; background-image: radial-gradient(#999 15%, transparent 16%); background-size: 4px 4px; }
        ::-webkit-scrollbar-thumb {
            background: #DDD;
            border: 1px solid #555;
            box-shadow: inset 1px 1px 0 white;
        }
        ::-webkit-scrollbar-button {
            background: #DDD;
            border: 1px solid #555;
            height: 16px;
            box-shadow: inset 1px 1px 0 white;
        }

        #api-settings-btn { position: fixed; bottom: 30px; right: 30px; width: 36px; height: 36px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; z-index: 100; border-radius: 4px; }
        
    </style>
</head>
<body>

    <div class="window">
        <div class="window-inner">
            <!-- Mac OS 8 Title Bar -->
            <div class="title-bar">
                <div class="title-btn close-box" onclick="window.close()" title="Close"></div>
                <div class="title-bar-text">QISS Internet Search</div>
                <div class="right-controls">
                    <div class="title-btn zoom-box" title="Zoom"></div>
                    <div class="title-btn collapse-box" title="Collapse"></div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="viewport">
                
                <!-- Happy Mac / Finder Icon -->
                <div style="text-align:center; margin-bottom:10px; margin-top:10px;">
                    <svg viewBox="0 0 100 100" width="48" height="48">
                        <rect x="10" y="10" width="80" height="80" rx="10" fill="#DDD" stroke="black" stroke-width="2"/>
                        <path d="M30 35 L30 45" stroke="black" stroke-width="3"/>
                        <path d="M70 35 L70 45" stroke="black" stroke-width="3"/>
                        <path d="M35 65 Q50 75 65 65" fill="none" stroke="black" stroke-width="3"/>
                        <line x1="50" y1="35" x2="50" y2="50" stroke="black" stroke-width="2"/>
                    </svg>
                </div>

                <h1 class="page-title">QISS</h1>
                
                <div class="search-wrapper">
                    <button id="mode-toggle" onclick="toggleMode()">
                        <span class="qiss-text">QISS</span><span class="search-text">&nbsp;Search</span>
                    </button>
                    <br>
                    <div id="custom-search" style="display:none;">
                        <input type="text" id="search-bar" class="search-bar" placeholder="Enter query..." onkeydown="handleEnter(event)">
                        <div id="search-buttons">
                            <button onclick="searchInNaver()">Naver</button>
                            <button onclick="searchInDBpia()">DBpia</button>
                            <button onclick="searchInGs()">Scholar</button>
                        </div>
                    </div>
                </div>

                <!-- Google CSE -->
                <div id="cse-search" class="gcse-search" data-enableImageSearch="true"></div>

                <!-- AI Summary (SimpleText) -->
                <div id="gemini-summary-container">
                    <div id="gemini-summary">
                        <div class="summary-header">
                            <span>Untitled 1 (Summary)</span>
                            <div class="title-btn close-box" style="width:10px; height:10px;" onclick="document.getElementById('gemini-summary-container').style.display='none'"></div>
                        </div>
                        <div id="gemini-summary-content">
                            <div id="gemini-summary-text"></div>
                            <p style="font-size: 10px; color: #555; margin-top: 20px; font-family:'Geneva';">
                                *AI generated content may contain errors.
                            </p>
                        </div>
                        <div style="padding:5px; text-align:right; border-top:1px solid #000; background:#eee;">
                            <button id="btn-generate-summary" onclick="triggerSummary()">Summarize</button>
                        </div>
                    </div>
                </div>

                <br><br>
                <div style="text-align:center;">
                    <div id="current-time">Loading...</div>
                    <div id="credit">© 2025 QuarterPie</div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Modal (Standard Dialog) -->
    <div id="api-modal">
        <div class="modal-window">
            <div class="window-inner">
                <div class="title-bar">
                    <div class="title-btn close-box" onclick="closeApiModal()"></div>
                    <div class="title-bar-text">Settings</div>
                    <div class="title-btn collapse-box"></div>
                </div>
                <div class="modal-inner">
                    <img src="https://win98icons.alexmeub.com/icons/png/key_padlock-0.png" width="32" style="float:left; margin-right:15px;">
                    <h4 style="margin:0 0 10px 0; text-align:left;">API Key Required</h4>
                    <p style="font-size:12px; text-align:left; margin-bottom:10px;">Please enter your Groq API key to enable AI features.</p>
                    <input type="password" id="api-key-input" style="width:100%; box-sizing:border-box;">
                    <div id="api-status-indicator" style="margin-top:10px; font-size:11px; text-align:left;"></div>
                    <div style="margin-top:20px; text-align:right;">
                        <button onclick="closeApiModal()">Cancel</button>
                        <button onclick="saveApiKey()" class="primary-btn">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button id="api-settings-btn" onclick="openApiModal()" title="Preferences">
        <img src="https://win98icons.alexmeub.com/icons/png/settings_gear-0.png" width="20" height="20">
    </button>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const GROQ_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct'; 
        let isCSE = true;
        let currentSearchQuery = '';
        let lastProcessedQuery = '';
        let currentSummaryData = null;

        // Marked.js 옵션
        marked.setOptions({ breaks: true, gfm: true });

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        function toggleMode() {
            isCSE = !isCSE;
            const cse = document.getElementById('cse-search');
            const custom = document.getElementById('custom-search');
            const toggleBtn = document.getElementById('mode-toggle');
            
            document.getElementById('gemini-summary-container').style.display = 'none';

            if (isCSE) {
                toggleBtn.querySelector('.search-text').innerText = " Search: Google";
                custom.style.display = 'none';
                cse.style.display = 'block';
            } else {
                toggleBtn.querySelector('.search-text').innerText = " Search: Custom";
                cse.style.display = 'none';
                custom.style.display = 'block';
            }
        }

        // 시간 업데이트
        setInterval(() => {
            const now = new Date();
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('current-time').innerText = now.toLocaleString('en-US', options);
        }, 1000);

        // 검색 엔터 처리
        function handleEnter(event) { if (event.key === 'Enter') searchInGoogle(); }
        function getQuery() { return document.getElementById('search-bar').value.trim(); }
        
        // 검색 함수들
        function searchInGoogle() { const q = getQuery(); if (q) window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank'); }
        function searchInNaver() { const q = getQuery(); if (q) window.open('https://search.naver.com/search.naver?where=nexearch&sm=tab_hty&query=' + encodeURIComponent(q), '_blank'); }
        function searchInDBpia() { const q = getQuery(); if (q) window.open('https://www.dbpia.co.kr/search/topSearch?searchOption=all&query=' + encodeURIComponent(q), '_blank'); }
        function searchInGs() { const q = getQuery(); if (q) window.open('https://scholar.google.com/scholar?hl=ko&as_sdt=0%2C5&q=' + encodeURIComponent(q), '_blank'); }
        
        // ==========================================
        // API & AI FUNCTIONS (Original Prompts Restored)
        // ==========================================
        function updateApiStatus() {
            const apiKey = localStorage.getItem('GROQ_API_KEY');
            const indicator = document.getElementById('api-status-indicator');
            if (apiKey) {
                indicator.innerHTML = 'Status: Key Loaded';
            } else {
                indicator.innerHTML = 'Status: No Key';
            }
        }

        function openApiModal() {
            const modal = document.getElementById('api-modal');
            const input = document.getElementById('api-key-input');
            const savedKey = localStorage.getItem('GROQ_API_KEY');
            if (savedKey) input.value = savedKey;
            modal.classList.add('show');
            updateApiStatus();
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.remove('show');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('GROQ_API_KEY', apiKey);
                alert('Preferences saved.');
                closeApiModal();
                updateApiStatus();
            } else {
                alert('Please enter a key.');
            }
        }

        window.addEventListener('DOMContentLoaded', updateApiStatus);

        function triggerSummary() {
            if (!currentSummaryData) return;
            const btn = document.getElementById('btn-generate-summary');
            const contentDiv = document.getElementById('gemini-summary-content');
            
            btn.disabled = true;
            btn.innerHTML = 'Processing...';
            contentDiv.style.display = 'block';
            
            generateSummary(currentSummaryData.query, currentSummaryData.results);
        }

        async function generateSummary(query, searchResults) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            const summaryText = document.getElementById('gemini-summary-text');
            const btn = document.getElementById('btn-generate-summary');

            if (!GROQ_API_KEY) {
                summaryText.innerHTML = '<span style="color:red">Error: API Key missing.</span>';
                btn.innerHTML = 'Setup Key';
                btn.disabled = false;
                return;
            }

            summaryText.innerHTML = 'Analyzing results...';
            
            try {
                let resultsContext = '검색어: ' + query + '\n\n검색 결과:\n\n';
                searchResults.forEach((result, index) => {
                    resultsContext += `${index + 1}. ${result.title}\n${result.snippet}\n\n`;
                });
                
                // *** ORIGINAL PROMPTS RESTORED ***
                const systemPrompt = `당신은 검색 결과들을 바탕으로 사용자에게 과학적이고 간결한 요약을 제공하는 AI입니다. 다음은 "${query}"에 대한 학술 검색 결과입니다. 이 검색 결과들을 바탕으로 사용자가 알고 싶어하는 정보를 과학적이고 간결하게 요약해주세요. 한국어로 답변해주세요. 마크다운 문법을 자유롭게 사용할 수 있습니다.`;
                
                const userPrompt = `다음 검색 결과들을 종합하여 요약해주세요:\n\n${resultsContext}\n\n요약 시 다음 사항을 지켜주세요:\n1. 핵심 정보를 명확하게 정리 (마크다운 사용 가능)\n2. 검색 결과의 주요 내용을 종합적으로 설명. 마지막에 결론을 낼것.\n3. 객관적이고 중립적, 과학적이고 전문적인 톤 유지\n4. 불필요한 인사말이나 서론 없이 바로 본론으로 시작\n5. 가독성을 위해 적절히 마크다운 문법 활용 (제목, 강조, 리스트 등)`;

                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL, 
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024,
                    })
                });

                if (!response.ok) throw new Error('API Response Error');
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    const summary = data.choices[0].message.content;
                    summaryText.innerHTML = marked.parse(summary);
                    btn.innerHTML = 'Regenerate';
                    btn.disabled = false;
                }
            } catch (error) {
                summaryText.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
                btn.innerHTML = 'Retry';
                btn.disabled = false;
            }
        }

        // ==========================================
        // OBSERVERS (SEARCH & DOM)
        // ==========================================
        function monitorSearchResults() {
            const resultsObserver = new MutationObserver(() => {
                if (!isCSE) return;
                
                const results = document.querySelectorAll('.gsc-webResult.gsc-result');
                const searchInput = document.querySelector('input.gsc-input');
                const query = searchInput ? searchInput.value.trim() : '';

                if (results.length > 0 && query && query !== lastProcessedQuery) {
                    const searchResults = [];
                    results.forEach(result => {
                        const titleElement = result.querySelector('.gs-title');
                        const snippetElement = result.querySelector('.gs-snippet');
                        if (titleElement && snippetElement) {
                            searchResults.push({
                                title: titleElement.textContent.trim(),
                                snippet: snippetElement.textContent.trim()
                            });
                        }
                    });

                    const summaryContainer = document.getElementById('gemini-summary-container');
                    if (searchResults.length > 0) {
                        lastProcessedQuery = query;
                        summaryContainer.style.display = 'block';
                        
                        // Insert above results
                        const wrapper = results[0].closest('.gsc-results-wrapper-visible') || results[0].parentElement.parentElement;
                        if(wrapper) wrapper.insertBefore(summaryContainer, wrapper.firstChild);

                        currentSummaryData = { query: query, results: searchResults.slice(0, 5) };
                        document.getElementById('gemini-summary-content').style.display = 'none'; // Initially hidden
                        document.getElementById('btn-generate-summary').innerHTML = 'Summarize';
                        document.getElementById('btn-generate-summary').disabled = false;
                    }
                }
                addTrustButtons();
            });

            resultsObserver.observe(document.body, { childList: true, subtree: true });
        }
        monitorSearchResults();

        // Trust Analysis Buttons
        function addTrustButtons() {
            if (!isCSE) return;
            const results = document.querySelectorAll('.gsc-webResult.gsc-result');
            results.forEach(result => {
                if (result.querySelector('.trust-button')) return;
                
                const titleLink = result.querySelector('.gs-title a');
                if (!titleLink || !titleLink.href) return;

                const btn = document.createElement('button');
                btn.className = 'trust-button';
                btn.innerHTML = 'Check';
                btn.style.float = 'right';
                btn.style.fontSize = '10px';
                btn.style.padding = '1px 6px';
                btn.style.minWidth = 'auto';
                
                btn.onclick = (e) => {
                    e.stopPropagation();
                    analyzeTrust(titleLink.href, btn, result);
                };
                
                const snippet = result.querySelector('.gs-snippet');
                if(snippet) snippet.parentNode.insertBefore(btn, snippet);
            });
        }

        async function analyzeTrust(url, btn, resultContainer) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            if (!GROQ_API_KEY) { openApiModal(); return; }

            const originalText = btn.innerHTML;
            btn.innerHTML = '...';
            btn.disabled = true;

            const existingResult = resultContainer.querySelector('.trust-result');
            if (existingResult) existingResult.remove();

            try {
                const hostname = new URL(url).hostname;
                const systemPrompt = `You are a security expert.`;
                const userPrompt = `Evaluate domain: ${hostname}\n\nOutput only one word rating: 'Safe', 'Caution', 'Danger'. No other text.`;

                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.1,
                        max_tokens: 10
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const grade = data.choices[0].message.content.trim().replace(/['"]/g, '');
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'trust-result';
                
                let colorClass = 'high';
                if (grade.includes('Caution') || grade.includes('주의')) colorClass = 'medium';
                if (grade.includes('Danger') || grade.includes('위험')) colorClass = 'low';

                resultDiv.innerHTML = `Safety: <span class="trust-score ${colorClass}">${grade}</span> (${hostname})`;
                resultContainer.appendChild(resultDiv);
                
                btn.innerHTML = 'Done';
                btn.disabled = false;
            } catch (error) {
                btn.innerHTML = 'Err';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }
    </script>
</body>
</html>
