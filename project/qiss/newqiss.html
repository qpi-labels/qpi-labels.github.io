<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>QISS - Internet Explorer</title>
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico">
    <meta property="og:url" content="https://qpi.kro.kr">
    <meta property="og:title" content="ì¿¼í„°íŒŒì´">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/logo.png">
    <meta property="og:description" content="ë§Œì¡±ë„ 2ë…„ì—°ì† 1ìœ„! ì¿¼í„°íŒŒì´">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://cse.google.com/cse.js?cx=b794e851ac2524ee7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>

    <style>
        /* Windows 98 Reset & Base Styles */
        :root {
            --win-bg: #008080;
            --win-gray: #c0c0c0;
            --win-gray-light: #dfdfdf;
            --win-gray-dark: #808080;
            --win-black: #000000;
            --win-white: #ffffff;
            --win-blue: #000080;
            --win-blue-grad: #1084d0;
            --c-blue: #000080; /* í˜¸í™˜ì„± ìœ ì§€ */
            --c-text: #000000;
            --c-gray1: #dfdfdf;
            --c-gray2: #808080;
            --c-gray6: #404040;
        }

        body {
            background-color: var(--win-bg);
            color: black;
            font-family: 'Gulim', 'Dotum', 'MS Sans Serif', Tahoma, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* ì°½ ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ body ìŠ¤í¬ë¡¤ ë§‰ìŒ */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 16px;
            background: var(--win-gray);
        }
        ::-webkit-scrollbar-button {
            background: var(--win-gray);
            border: 2px outset #fff;
            display: block;
            height: 16px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0; /* Checkered pattern simulated */
        }
        ::-webkit-scrollbar-thumb {
            background: var(--win-gray);
            border: 2px outset #fff;
        }

        /* Window Container */
        .window-frame {
            width: 95%;
            max-width: 1024px;
            height: 90vh;
            background: var(--win-gray);
            border: 2px solid;
            border-color: #fff #000 #000 #fff; /* Outset 3D */
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--win-blue), var(--win-blue-grad));
            padding: 3px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 18px;
        }

        .title-bar-text {
            color: white;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .title-bar-controls button {
            width: 16px;
            height: 14px;
            background: var(--win-gray);
            border: 1px outset #fff;
            font-size: 9px;
            line-height: 10px;
            padding: 0;
            margin-left: 2px;
            font-weight: bold;
        }

        .menu-bar {
            display: flex;
            gap: 15px;
            padding: 2px 8px;
            border-bottom: 1px solid var(--win-gray-dark);
            font-size: 13px;
        }

        .menu-item {
            cursor: default;
        }
        .menu-item:hover {
            background-color: var(--win-blue);
            color: white;
        }
        .menu-item a {
            text-decoration: none;
            color: inherit;
        }

        .main-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #fff;
            border: 2px inset #fff;
            margin: 4px;
        }

        /* Typography & Layout */
        .page-title {
            font-size: 32px;
            text-align: center;
            margin: 20px 0;
            font-weight: 900;
            letter-spacing: -1px;
            text-shadow: 2px 2px var(--win-gray);
        }

        /* Buttons (Windows 98 Style) */
        button {
            background: var(--win-gray);
            border: 2px solid;
            border-color: #fff #000 #000 #fff; /* Outset */
            color: black;
            padding: 4px 10px;
            font-family: 'Gulim', sans-serif;
            cursor: pointer;
            font-size: 12px;
        }

        button:active {
            border-color: #000 #fff #fff #000; /* Inset */
            padding: 5px 9px 3px 11px; /* Shift text */
        }

        button:hover {
            box-shadow: none;
            transform: none;
        }

        /* Inputs */
        input[type="text"], input[type="password"] {
            border: 2px solid;
            border-color: #404040 #dfdfdf #dfdfdf #404040; /* Inset */
            background: #fff;
            padding: 3px;
            font-family: 'Gulim', sans-serif;
            border-radius: 0;
            outline: none;
        }

        /* Toggle Button Customization */
        #mode-toggle {
            display: block;
            margin: 0 auto 20px auto;
            min-width: 100px;
        }

        /* Search Areas */
        #custom-search {
            text-align: center;
            background: var(--win-gray);
            padding: 20px;
            border: 2px outset #fff;
            width: 80%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .search-bar {
            width: 100%;
            max-width: 400px;
        }

        #search-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }

        /* CSE (Google Search) Overrides - Brutalist Force */
        .gcse-search {
            margin: 0 auto;
            width: 90%;
        }
        
        /* Reset Google's fancy styles */
        .gsc-control-cse {
            background-color: #fff !important;
            border: none !important;
            padding: 0 !important;
            font-family: 'Gulim', sans-serif !important;
        }

        .gsc-input-box {
            border: 2px inset #fff !important;
            background: #fff !important;
            height: auto !important;
            border-radius: 0 !important;
        }

        input.gsc-input {
            background: none !important;
            text-indent: 0 !important;
            padding: 4px !important;
            font-size: 13px !important;
        }

        .gsc-search-button-v2 {
            background-color: var(--win-gray) !important;
            border: 2px outset #fff !important;
            border-radius: 0 !important;
            padding: 6px 15px !important;
            margin-left: 5px !important;
            color: black !important;
            box-shadow: none !important;
        }
        
        .gsc-search-button-v2 svg {
            fill: black !important;
        }

        .gsc-search-button-v2:active {
            border-style: inset !important;
        }

        /* Search Results Styling */
        .gsc-webResult.gsc-result {
            background: #fff !important;
            border-bottom: 1px dashed #808080 !important;
            padding: 10px 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        .gs-title {
            text-decoration: none !important;
            height: auto !important;
        }

        .gs-title a {
            color: #000080 !important; /* Classic Link Blue */
            font-size: 14px !important;
            font-weight: bold !important;
            font-family: 'Gulim', sans-serif !important;
        }
        
        .gs-title a:hover {
            color: red !important;
            text-decoration: underline !important;
        }

        .gs-title a:visited {
            color: #800080 !important;
        }

        .gs-snippet {
            font-size: 12px !important;
            color: black !important;
            font-family: 'Dotum', sans-serif !important;
            line-height: 1.4 !important;
        }

        .gs-visibleUrl {
            color: #008000 !important;
            font-size: 11px !important;
        }

        .gsc-cursor-page {
            color: black !important;
            background: var(--win-gray) !important;
            border: 2px outset #fff !important;
            border-radius: 0 !important;
            margin-right: 2px !important;
        }

        .gsc-cursor-current-page {
            font-weight: bold !important;
            background: #fff !important;
            border: 2px inset #fff !important;
        }

        /* Remove Google Junk */
        .gsc-adBlock, .gsc-above-wrapper-area, .gsc-thumbnail {
            display: none !important;
        }

        /* AI Summary Box (Notepad Style) */
        #gemini-summary-container {
            width: 90%;
            margin: 20px auto;
        }

        #gemini-summary {
            background: #fff;
            border: 2px solid #000;
            padding: 2px;
            box-shadow: 4px 4px 0 var(--win-gray-dark);
        }

        .summary-header {
            background: var(--win-blue);
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-header h3 {
            margin: 0;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #gemini-summary-content {
            padding: 15px;
            font-family: 'Courier New', Courier, monospace; /* Notepad feeling */
            font-size: 13px;
        }

        .summary-button {
            background: var(--win-gray);
            color: black;
            border: 1px outset #fff;
            border-radius: 0;
            font-size: 11px;
            height: 20px;
        }

        /* Modal (Error Message Style) */
        #api-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.1); /* Dotted pattern ideal but alpha ok */
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #api-modal.show { display: flex; }

        .modal-content {
            background: var(--win-gray);
            border: 2px outset #fff;
            padding: 3px;
            width: 400px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
        }

        .modal-header {
            background: var(--win-blue);
            color: white;
            padding: 2px 5px;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .modal-body {
            padding: 15px;
            text-align: center;
        }

        .modal-body p { margin: 10px 0; font-size: 12px; }

        .api-input-group input {
            width: 100%;
            margin-top: 5px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-bottom: 10px;
        }

        /* Floating Settings Button */
        #api-settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Marquee */
        .marquee-container {
            background: #000;
            color: #0f0; /* Matrix green */
            font-family: 'Courier New', monospace;
            border: 2px inset #fff;
            margin-bottom: 10px;
            padding: 2px;
            font-size: 12px;
        }

        /* Trust Button */
        .trust-button {
            float: right;
            margin-left: 10px;
            font-size: 11px;
            padding: 0 5px;
            height: 20px;
        }

        .trust-result {
            background: #ffffe0; /* Info tooltip yellow */
            border: 1px solid #000;
            padding: 5px;
            margin-top: 5px;
            font-size: 11px;
            clear: both;
        }

        /* Footer */
        #current-time, #credit {
            font-size: 12px;
            color: #404040;
            margin-top: 10px;
        }

        /* Icon reset */
        .icon {
            stroke-width: 1.5;
        }
        
        hr {
            border: 0;
            border-top: 1px solid #808080;
            border-bottom: 1px solid #fff;
            margin: 5px 0;
        }

        /* Trust Analysis Score Colors */
        .trust-score.high { color: green; font-weight: bold; }
        .trust-score.medium { color: #808000; font-weight: bold; }
        .trust-score.low { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <!-- Windows 98 Frame -->
    <div class="window-frame">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-text">
                <img src="/logo.ico" onerror="this.src='https://win98icons.alexmeub.com/icons/png/internet_connection_wiz-0.png'" width="16" height="16" alt="Icon">
                QISS - Microsoft Internet Explorer
            </div>
            <div class="title-bar-controls">
                <button>_</button>
                <button>â–¡</button>
                <button onclick="window.close()">X</button>
            </div>
        </div>

        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="menu-item">íŒŒì¼(F)</div>
            <div class="menu-item">í¸ì§‘(E)</div>
            <div class="menu-item">ë³´ê¸°(V)</div>
            <div class="menu-item">ì´ë™(G)</div>
            <div class="menu-item">ì¦ê²¨ì°¾ê¸°(A)</div>
            <div class="menu-item">ë„ì›€ë§(H)</div>
            <div style="flex-grow:1"></div>
            <!-- Old Nav Links moved here -->
            <div class="menu-item"><a href="https://mail.google.com/">ë©”ì¼</a></div>
            <div class="menu-item"><a href="https://drive.google.com/">ë“œë¼ì´ë¸Œ</a></div>
        </div>
        
        <!-- Marquee Banner -->
        <div class="marquee-container">
            <marquee scrolldelay="150">â˜… ë§Œì¡±ë„ 2ë…„ì—°ì† 1ìœ„! ì¿¼í„°íŒŒì´ â˜… QISS ê²€ìƒ‰ ì‹œìŠ¤í…œì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤... Netscape Navigatorë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤...</marquee>
        </div>

        <!-- Main Content Area (White Box) -->
        <div class="main-content">
            <h1 class="page-title">QISS <span style="font-size:14px; font-weight:normal; vertical-align:middle">Web Search</span></h1>
            
            <button id="mode-toggle" onclick="toggleMode()">
                <span class="qiss-text">QISS</span><span class="search-text">&nbsp;ê²€ìƒ‰ ëª¨ë“œ</span>
            </button>

            <hr>

            <div id="custom-search" style="display:none;">
                <p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤:</p>
                <input type="text" id="search-bar" class="search-bar" onkeydown="handleEnter(event)">
                <br><br>
                <div id="search-buttons">
                    <button class="search-button" onclick="searchInNaver()">Naver ê²€ìƒ‰</button>
                    <button class="search-button" onclick="searchInDBpia()">DBpia</button>
                    <button class="search-button" onclick="searchInGs()">Scholar</button>
                    <button class="search-button" onclick="searchInRISS()">RISS</button>
                </div>
            </div>

            <!-- Google CSE -->
            <div id="cse-search" class="gcse-search" data-enableImageSearch="true"></div>

            <!-- Gemini Summary (Notepad Look) -->
            <div id="gemini-summary-container" style="display:none">
                <div id="gemini-summary">
                    <div class="summary-header">
                        <h3>
                            <span>AI ìš”ì•½.txt - ë©”ëª¨ì¥</span>
                        </h3>
                        <button id="btn-generate-summary" class="summary-button" onclick="triggerSummary()">
                            ìš”ì•½ ì‹¤í–‰
                        </button>
                    </div>
                    <div id="gemini-summary-content">
                        <div id="gemini-summary-text"></div>
                        <p style="font-size: 11px; color: #808080; margin-top: 12px; border-top: 1px dashed #ccc; padding-top:5px;">
                            â€» AIëŠ” ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <br>
            <div style="text-align:center;">
                <div id="current-time">Ready</div>
                <div id="credit">Copyright â“’ 2025 ì¿¼í„°íŒŒì´ Corp.</div>
                <img src="https://web.archive.org/web/20091027073238/http://geocities.com/Heartland/Plains/8637/ie_logo.gif" alt="IE Logo" style="margin-top:10px;">
            </div>
        </div>
        
        <!-- Bottom Status Bar -->
        <div style="background:var(--win-gray); border-top:1px solid #fff; padding:2px 5px; font-size:11px; display:flex; gap:10px;">
            <div style="border:1px inset #fff; padding:0 5px; width:100px;">ì¤€ë¹„</div>
            <div style="border:1px inset #fff; padding:0 5px; flex-grow:1;" id="api-status-indicator">ì˜¤í”„ë¼ì¸</div>
            <div style="border:1px inset #fff; padding:0 5px; width:50px;">CAPS</div>
        </div>
    </div>

    <!-- API ì„¤ì • ëª¨ë‹¬ (Error Dialog Style) -->
    <div id="api-modal">
        <div class="modal-content">
            <div class="modal-header">
                ì‹œìŠ¤í…œ ì„¤ì •
                <button onclick="closeApiModal()" style="width:16px; height:14px; font-size:9px; line-height:10px;">X</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; justify-content:center;">
                    <img src="https://win98icons.alexmeub.com/icons/png/key_access-0.png" width="32" height="32">
                    <p style="text-align:left; font-weight:bold;">Groq API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
                </div>
                <p>AI ìš”ì•½ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ í‚¤ë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.</p>
                
                <div class="api-input-group">
                    <label for="api-key-input" style="font-size:12px;">ì•”í˜¸(P):</label>
                    <input type="password" id="api-key-input">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="saveApiKey()">í™•ì¸</button>
                <button class="modal-button secondary" onclick="closeApiModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- API ì„¤ì • ë²„íŠ¼ (Floater) -->
    <button id="api-settings-btn" onclick="openApiModal()" title="ì„¤ì •">
        <img src="https://win98icons.alexmeub.com/icons/png/settings_gear-0.png" width="20" height="20">
    </button>

    <script>
        const GROQ_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct'; 

        let isCSE = true;
        let currentSearchQuery = '';
        let lastProcessedQuery = '';
        let currentSummaryData = null;

        // ì•„ì´ì½˜ì€ í…ìŠ¤íŠ¸ë‚˜ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´í•˜ë¯€ë¡œ SVG ë³€ìˆ˜ëŠ” ìµœì†Œí™”
        const ICONS = {
            spinner: 'â³',
            refresh: 'â†»'
        };

        marked.setOptions({ breaks: true, gfm: true });

        function updateApiStatus() {
            const apiKey = localStorage.getItem('GROQ_API_KEY');
            const indicator = document.getElementById('api-status-indicator');
            if (apiKey) {
                indicator.innerHTML = 'API ì—°ê²°ë¨';
                indicator.style.color = 'black';
            } else {
                indicator.innerHTML = 'API í‚¤ ì—†ìŒ';
                indicator.style.color = '#808080';
            }
        }

        function openApiModal() {
            const modal = document.getElementById('api-modal');
            const input = document.getElementById('api-key-input');
            const savedKey = localStorage.getItem('GROQ_API_KEY');
            if (savedKey) input.value = savedKey;
            modal.classList.add('show');
            updateApiStatus();
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.remove('show');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('GROQ_API_KEY', apiKey);
                alert('ì‹œìŠ¤í…œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeApiModal();
                updateApiStatus();
            } else {
                alert('ê²½ê³ : í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
        }

        window.addEventListener('DOMContentLoaded', updateApiStatus);

        function toggleMode() {
            isCSE = !isCSE;
            const cse = document.getElementById('cse-search');
            const custom = document.getElementById('custom-search');
            const toggleBtn = document.getElementById('mode-toggle');
            
            // UI Reset
            document.getElementById('gemini-summary-container').style.display = 'none';

            if (isCSE) {
                toggleBtn.querySelector('.search-text').innerText = " ëª¨ë“œ: êµ¬ê¸€";
                custom.style.display = 'none';
                cse.style.display = 'block';
            } else {
                toggleBtn.querySelector('.search-text').innerText = " ëª¨ë“œ: ì‚¬ìš©ì";
                cse.style.display = 'none';
                custom.style.display = 'block';
            }
        }

        function handleEnter(event) { if (event.key === 'Enter') searchInGoogle(); }
        function getQuery() { return document.getElementById('search-bar').value.trim(); }
        
        function searchInGoogle() { const q = getQuery(); if (q) window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank'); }
        function searchInNaver() { const q = getQuery(); if (q) window.open('https://search.naver.com/search.naver?where=nexearch&sm=tab_hty&query=' + encodeURIComponent(q), '_blank'); }
        function searchInDBpia() { const q = getQuery(); if (q) window.open('https://www.dbpia.co.kr/search/topSearch?searchOption=all&query=' + encodeURIComponent(q), '_blank'); }
        function searchInGs() { const q = getQuery(); if (q) window.open('https://scholar.google.com/scholar?hl=ko&as_sdt=0%2C5&q=' + encodeURIComponent(q), '_blank'); }
        function searchInRISS() { const q = getQuery(); if (q) window.open('https://www.riss.kr/search/Search.do?colName=all&isDetailSearch=N&searchGubun=true&query=' + encodeURIComponent(q), '_blank'); }

        function triggerSummary() {
            if (!currentSummaryData) return;
            const btn = document.getElementById('btn-generate-summary');
            const contentDiv = document.getElementById('gemini-summary-content');
            
            btn.disabled = true;
            btn.innerText = 'ì²˜ë¦¬ ì¤‘...';
            contentDiv.style.display = 'block';
            generateSummary(currentSummaryData.query, currentSummaryData.results);
        }

        async function generateSummary(query, searchResults) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            const summaryText = document.getElementById('gemini-summary-text');
            const btn = document.getElementById('btn-generate-summary');

            if (!GROQ_API_KEY) {
                summaryText.innerHTML = 'ì˜¤ë¥˜: API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì„¤ì • ë©”ë‰´ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.';
                btn.innerText = 'ì˜¤ë¥˜';
                btn.disabled = false;
                return;
            }

            summaryText.innerHTML = 'ë°ì´í„° ìˆ˜ì‹  ì¤‘...';
            
            try {
                let resultsContext = 'ê²€ìƒ‰ì–´: ' + query + '\n\nê²€ìƒ‰ ê²°ê³¼:\n\n';
                searchResults.forEach((result, index) => {
                    resultsContext += `${index + 1}. ${result.title}\n${result.snippet}\n\n`;
                });
                
                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: GROQ_MODEL, 
                        messages: [
                            { role: 'system', content: "ë‹¹ì‹ ì€ 90ë…„ëŒ€ ì»´í“¨í„° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì •ë³´ë¥¼ ë§¤ìš° ê±´ì¡°í•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ìš”ì•½í•˜ì‹­ì‹œì˜¤." },
                            { role: 'user', content: `ë‹¤ìŒ ì •ë³´ë¥¼ ìš”ì•½í•˜ì‹œì˜¤:\n\n${resultsContext}` }
                        ],
                        temperature: 0.7, max_tokens: 1024
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    summaryText.innerHTML = marked.parse(data.choices[0].message.content);
                    btn.innerText = 'ë‹¤ì‹œ ì‹¤í–‰';
                    btn.disabled = false;
                }
            } catch (error) {
                summaryText.innerHTML = 'ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
                btn.innerText = 'ì¬ì‹œë„';
                btn.disabled = false;
            }
        }

        // Search Monitor (Mutation Observer)
        function monitorSearchResults() {
            const resultsObserver = new MutationObserver(() => {
                if (!isCSE) return;
                const results = document.querySelectorAll('.gsc-webResult.gsc-result');
                const searchInput = document.querySelector('input.gsc-input');
                const query = searchInput ? searchInput.value.trim() : '';

                if (results.length > 0 && query && query !== lastProcessedQuery) {
                    const searchResults = [];
                    results.forEach(result => {
                        const titleEl = result.querySelector('.gs-title');
                        const snippetEl = result.querySelector('.gs-snippet');
                        if (titleEl && snippetEl) {
                            searchResults.push({ title: titleEl.textContent, snippet: snippetEl.textContent });
                        }
                    });

                    if (searchResults.length > 0) {
                        lastProcessedQuery = query;
                        const container = document.getElementById('gemini-summary-container');
                        container.style.display = 'block';
                        
                        // Insert Summary Box at top of results
                        const wrapper = results[0].closest('.gsc-results-wrapper-visible') || results[0].parentElement;
                        if(wrapper) wrapper.insertBefore(container, wrapper.firstChild);
                        
                        currentSummaryData = { query: query, results: searchResults.slice(0, 5) };
                        document.getElementById('gemini-summary-content').style.display = 'none';
                        document.getElementById('btn-generate-summary').innerText = 'ìš”ì•½ ì‹¤í–‰';
                        document.getElementById('btn-generate-summary').disabled = false;
                    }
                }
                addTrustButtons(); // Re-apply buttons
            });

            resultsObserver.observe(document.body, { childList: true, subtree: true });
        }
        monitorSearchResults();

        // Time
        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time').innerText = "í˜„ì¬ ì‹œê°„: " + now.toLocaleString();
        }, 1000);

        // Trust Button Logic
        function addTrustButtons() {
            if (!isCSE) return;
            const results = document.querySelectorAll('.gsc-webResult.gsc-result');
            results.forEach(result => {
                if (result.querySelector('.trust-button')) return;
                const titleLink = result.querySelector('.gs-title a');
                if (!titleLink || !titleLink.href) return;

                const btn = document.createElement('button');
                btn.className = 'trust-button';
                btn.innerText = 'ğŸ›¡ ë³´ì•ˆ ê²€ì‚¬';
                btn.onclick = (e) => { e.stopPropagation(); analyzeTrust(titleLink.href, btn, result); };
                
                // Insert next to title
                const titleContainer = result.querySelector('.gs-title');
                if(titleContainer) titleContainer.appendChild(btn);
            });
        }

        async function analyzeTrust(url, btn, resultContainer) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            if (!GROQ_API_KEY) { openApiModal(); return; }

            const originalText = btn.innerText;
            btn.innerText = 'ê²€ì‚¬ ì¤‘...';
            btn.disabled = true;

            const existing = resultContainer.querySelector('.trust-result');
            if (existing) existing.remove();

            try {
                const hostname = new URL(url).hostname;
                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: 'system', content: "You are a security bot. Reply with one word safety level: 'ì•ˆì „', 'ì£¼ì˜', 'ìœ„í—˜'." },
                            { role: 'user', content: `Domain: ${hostname}` }
                        ],
                        temperature: 0.1, max_tokens: 10
                    })
                });
                
                const data = await response.json();
                const grade = data.choices[0].message.content.trim().replace(/['"]/g, '');
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'trust-result';
                let colorClass = grade.includes('ì•ˆì „') ? 'high' : (grade.includes('ìœ„í—˜') ? 'low' : 'medium');
                
                resultDiv.innerHTML = `ë¶„ì„ ê²°ê³¼: <span class="trust-score ${colorClass}">${grade}</span> (ë„ë©”ì¸: ${hostname})`;
                resultContainer.appendChild(resultDiv);
                
                btn.innerText = 'ì™„ë£Œ';
                btn.disabled = false;
            } catch (e) {
                alert('ê²€ì‚¬ ì‹¤íŒ¨');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
    </html>
