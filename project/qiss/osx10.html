<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>QISS - Mac OS X Aqua</title>
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google CSE -->
    <script async src="https://cse.google.com/cse.js?cx=b794e851ac2524ee7"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>

    <style>
        /* ----------------------------------------------------------------
           MAC OS X 10.0 (AQUA) THEME
           ---------------------------------------------------------------- */
        :root {
            --aqua-blue-top: #6cb3fa;
            --aqua-blue-mid: #1870d1;
            --aqua-blue-bot: #1263bb;
            --aqua-text: #000000;
            --aqua-bg: #f0f0f0;
            --aqua-stripe: rgba(0,0,0,0.03);
            --win-shadow: 0 15px 35px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.1);
        }

        body {
            /* Pinstripe Background (Aqua Signature) */
            background-color: #f2f2f2;
            background-image: linear-gradient(0deg, transparent 50%, var(--aqua-stripe) 50%);
            background-size: 100% 4px;
            font-family: "Lucida Grande", "Lucida Sans Unicode", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* 메인 윈도우 프레임 */
        .window {
            width: 90%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px 10px 5px 5px;
            box-shadow: var(--win-shadow);
            display: flex;
            flex-direction: column;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        /* 타이틀 바 (Licked Plastic Look) */
        .title-bar {
            background: linear-gradient(to bottom, #f9f9f9 0%, #e6e6e6 100%);
            padding: 8px 15px;
            display: flex;
            justify-content: center; /* Title Centered */
            align-items: center;
            border-bottom: 1px solid #b3b3b3;
            position: relative;
            height: 22px;
        }

        .title-bar-text {
            color: #333;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
        }

        /* Traffic Lights (Window Controls) */
        .traffic-lights {
            position: absolute;
            left: 10px;
            display: flex;
            gap: 8px;
        }

        .traffic-btn {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.8), 0 1px 1px rgba(0,0,0,0.1);
        }
        .close-btn { background: radial-gradient(circle at 30% 30%, #ff8c8c, #ff3b30); border-color: #d12e25; }
        .min-btn { background: radial-gradient(circle at 30% 30%, #ffea8c, #ffcc00); border-color: #c9a000; }
        .max-btn { background: radial-gradient(circle at 30% 30%, #8cff99, #28cd41); border-color: #1fad32; }

        /* 메인 컨텐츠 영역 */
        .viewport {
            padding: 20px 40px;
            background: #fff;
            min-height: 70vh;
            overflow-y: auto;
        }

        h1.page-title {
            font-size: 36px;
            text-align: center;
            margin: 20px 0 30px 0;
            font-weight: normal;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #000;
            opacity: 0.8;
        }

        /* Aqua Buttons (The Pill) */
        button {
            /* Complex Aqua Gradient */
            background: linear-gradient(to bottom, #6cb3fa 0%, #1870d1 50%, #0857ac 51%, #1263bb 100%);
            border: 1px solid #084d96;
            border-radius: 20px; /* Pill Shape */
            color: white;
            padding: 6px 18px;
            font-family: "Lucida Grande", sans-serif;
            font-size: 13px;
            cursor: pointer;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 1px 2px rgba(0,0,0,0.2);
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
            transition: all 0.1s;
            outline: none;
            min-width: 80px;
        }
        
        button:active {
            background: linear-gradient(to bottom, #1263bb 0%, #0857ac 49%, #1870d1 50%, #6cb3fa 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: #ccc;
            border-color: #999;
            color: #888;
            box-shadow: none;
        }

        /* Default Button Pulse Animation */
        button.primary-btn {
            animation: aqua-pulse 2s infinite alternate;
        }

        @keyframes aqua-pulse {
            from { box-shadow: 0 0 0 rgba(108, 179, 250, 0); }
            to { box-shadow: 0 0 8px rgba(108, 179, 250, 0.8); }
        }

        /* Inputs (Inset Shadow) */
        input[type="text"], input[type="password"] {
            border: 1px solid #999;
            border-top-color: #777;
            padding: 5px 10px;
            font-family: "Lucida Grande", sans-serif;
            font-size: 14px;
            border-radius: 3px;
            background: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            outline: none;
        }
        input:focus {
            box-shadow: 0 0 0 3px rgba(130, 190, 255, 0.6); /* Focus Ring */
        }

        /* Mode Toggle */
        #mode-toggle { display: block; margin: 0 auto; width: 160px; font-weight: bold; }
        
        /* Search Box Wrapper */
        .search-wrapper {
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        #custom-search { text-align: center; }
        .search-bar { width: 70%; max-width: 500px; padding: 8px !important; border-radius: 20px !important; }
        #search-buttons { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }

        /* ==========================================================================
           GOOGLE CSE OVERRIDES (Aqua Style)
           ========================================================================== */
        .gsc-control-cse {
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
            font-family: "Lucida Grande", sans-serif !important;
        }
        
        .gsc-search-box { margin-bottom: 20px !important; }
        .gsc-input-box {
            border: 1px solid #999 !important;
            border-radius: 20px !important; /* Rounded Search */
            background: white !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1) !important;
            padding: 2px 10px !important;
        }
        input.gsc-input { padding: 6px !important; font-size: 14px !important; }
        
        .gsc-search-button-v2 {
            background: linear-gradient(to bottom, #6cb3fa 0%, #1263bb 100%) !important;
            border: 1px solid #084d96 !important;
            border-radius: 20px !important;
            padding: 8px 20px !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
            margin-left: 10px !important;
        }
        .gsc-search-button-v2 svg { fill: white !important; }

        /* Search Results */
        .gsc-webResult.gsc-result {
            background: transparent !important;
            border-bottom: 1px solid #e0e0e0 !important;
            padding: 20px 0 !important;
            margin: 0 !important;
        }

        /* Titles (Restored) */
        .gs-title {
            height: auto !important;
            overflow: visible !important;
            line-height: 1.4 !important;
            margin-bottom: 4px !important;
        }
        .gs-title a {
            color: #0033cc !important; /* Mac Link Blue */
            font-family: "Lucida Grande", sans-serif !important;
            font-size: 16px !important;
            font-weight: normal !important;
            text-decoration: underline !important;
        }
        .gs-title a:visited { color: #800080 !important; }

        /* Snippet */
        .gs-snippet {
            font-family: "Lucida Grande", sans-serif !important;
            font-size: 13px !important;
            color: #333 !important;
            line-height: 1.5 !important;
        }
        
        /* URL */
        .gsc-url-top, .gs-visibleUrl {
            color: #008000 !important;
            font-family: "Lucida Grande", sans-serif !important;
            font-size: 11px !important;
        }

        /* Images (Standard) */
        .gs-image-box { margin-right: 15px !important; }
        img.gs-image { border-radius: 3px !important; border: 1px solid #ccc !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }

        /* Pagination */
        .gsc-cursor-box { margin-top: 30px !important; text-align: center !important; }
        .gsc-cursor-page {
            color: #333 !important;
            margin: 0 5px !important;
            padding: 5px 10px !important;
            text-decoration: none !important;
            background: #f0f0f0 !important;
            border: 1px solid #ccc !important;
            border-radius: 5px !important;
        }
        .gsc-cursor-current-page {
            color: white !important;
            background: #1870d1 !important;
            border-color: #1263bb !important;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2) !important;
        }

        /* Hide ads/branding */
        .gsc-adBlock, .gsc-above-wrapper-area { display: none !important; }
        
        /* ========================================================================== */

        /* AI Summary (Brushed Metal / TextEdit Look) */
        #gemini-summary-container { display: none; margin: 20px 0; }
        #gemini-summary {
            background: #ffffdd; /* Yellow Note Pad color */
            border: 1px solid #dcdcdc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 0 0 5px 5px;
            overflow: hidden;
        }
        .summary-header {
            background: linear-gradient(to bottom, #dcdcdc 0%, #b4b4b4 100%); /* Brushed Metalish */
            padding: 6px 15px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #999;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        #gemini-summary-content {
            padding: 20px;
            font-family: "Lucida Grande", sans-serif;
            font-size: 13px;
            line-height: 1.6;
            color: #333;
        }
        
        /* Modal (Aqua Sheet) */
        #api-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; align-items: flex-start; justify-content: center; padding-top: 100px; }
        #api-modal.show { display: flex; animation: sheet-down 0.3s ease-out; }
        
        @keyframes sheet-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-window {
            background: rgba(255,255,255,0.95);
            width: 400px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 1px solid #aaa;
            border-top: none;
            overflow: hidden;
        }
        .modal-body { padding: 30px; text-align: center; }
        .modal-buttons { background: #f0f0f0; padding: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ccc; }

        /* Trust Result */
        .trust-result {
            background: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 5px;
            padding: 8px;
            font-size: 12px;
            margin-top: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .trust-score.high { color: #28cd41; font-weight: bold; }
        .trust-score.medium { color: #ffcc00; font-weight: bold; text-shadow: 0 0 1px black; }
        .trust-score.low { color: #ff3b30; font-weight: bold; }

        /* Footer */
        #current-time { font-size: 11px; color: #666; text-shadow: 0 1px 0 white; }
        #credit { font-size: 11px; color: #999; }
        
        /* Scrollbar (Webkit) - Blue Jelly */
        ::-webkit-scrollbar { width: 15px; background: #f0f0f0; border-left: 1px solid #e0e0e0; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #b0d4ff, #6cb3fa, #1870d1);
            border-radius: 10px;
            border: 3px solid #f0f0f0;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.2);
        }

        #api-settings-btn { position: fixed; bottom: 30px; right: 30px; width: 40px; height: 40px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; z-index: 100; }
        
    </style>
</head>
<body>

    <div class="window">
        <!-- Aqua Title Bar -->
        <div class="title-bar">
            <div class="traffic-lights">
                <div class="traffic-btn close-btn" onclick="window.close()" title="Close"></div>
                <div class="traffic-btn min-btn" title="Minimize"></div>
                <div class="traffic-btn max-btn" title="Maximize"></div>
            </div>
            <div class="title-bar-text">QISS Web Search</div>
        </div>

        <!-- Main Content -->
        <div class="viewport">
            
            <!-- Apple Icon (Decorative) -->
            <div style="text-align:center; margin-bottom:10px; opacity:0.15;">
                <svg viewBox="0 0 170 170" width="60" height="60" fill="black"><path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.9 7.07-10.36 12.67-16.39 16.79-5.99 4.12-12.06 6.18-18.18 6.18-3.07 0-6.93-.56-11.59-1.68-4.66-1.12-9.62-1.68-14.88-1.68-4.96 0-9.85.56-14.67 1.68-4.82 1.12-8.83 1.68-12.03 1.68-6.12 0-12.33-2.12-18.64-6.38-6.31-4.26-11.97-10.02-16.96-17.27-9.47-13.68-14.2-29.23-14.2-46.65 0-16.48 4.09-29.47 12.28-38.97 8.19-9.5 19.34-14.25 33.45-14.25 3.35 0 7.21.61 11.57 1.84 4.36 1.23 7.82 1.84 10.39 1.84 2.13 0 5.86-.61 11.17-1.84 5.31-1.23 9.47-1.84 12.49-1.84 13.99 0 25.14 4.41 33.42 13.23-8.02 4.96-12.03 12.28-12.03 21.95 0 9.09 3.32 16.79 9.97 23.09 6.65 6.31 14.69 9.46 24.12 9.46-.24 1.84-.73 4.1-1.47 6.8-.73 2.69-1.47 5.16-2.21 7.42M119.11 20.3c0 9.2-3.32 17.06-9.97 23.61-6.65 6.55-14.72 9.82-24.2 9.82-1.01-15.62 4.66-28.56 16.99-38.82 11.05-9.2 23.11-13.34 36.17-12.42.3 8.32-6.57 14.93-18.99 17.81"/></svg>
            </div>

            <h1 class="page-title">QISS</h1>
            
            <div class="search-wrapper">
                <button id="mode-toggle" onclick="toggleMode()">
                    <span class="qiss-text">QISS</span><span class="search-text">&nbsp;Search</span>
                </button>
                <br>
                <div id="custom-search" style="display:none;">
                    <input type="text" id="search-bar" class="search-bar" placeholder="Enter query..." onkeydown="handleEnter(event)">
                    <div id="search-buttons">
                        <button onclick="searchInNaver()">Naver</button>
                        <button onclick="searchInDBpia()">DBpia</button>
                        <button onclick="searchInGs()">Scholar</button>
                    </div>
                </div>
            </div>

            <!-- Google CSE -->
            <div id="cse-search" class="gcse-search" data-enableImageSearch="true"></div>

            <!-- AI Summary (TextEdit) -->
            <div id="gemini-summary-container">
                <div id="gemini-summary">
                    <div class="summary-header">
                        <span>AI Summary.rtf</span>
                        <button style="background:none; border:none; color:#555; padding:0; min-width:auto; font-weight:bold; box-shadow:none;" onclick="document.getElementById('gemini-summary-container').style.display='none'">x</button>
                    </div>
                    <div id="gemini-summary-content">
                        <div id="gemini-summary-text"></div>
                        <p style="font-size: 11px; color: #888; margin-top: 20px;">
                            Disclaimer: AI generated content may contain errors.
                        </p>
                    </div>
                    <div style="padding:10px; text-align:right; background:#f9f9f9; border-top:1px solid #ddd;">
                        <button id="btn-generate-summary" onclick="triggerSummary()">Summarize</button>
                    </div>
                </div>
            </div>

            <br><br>
            <div style="text-align:center;">
                <div id="current-time">Loading time...</div>
                <div id="credit">© 2025 QuarterPie</div>
            </div>
        </div>
    </div>

    <!-- API Modal (Sheet Style) -->
    <div id="api-modal">
        <div class="modal-window">
            <div class="modal-body">
                <h3 style="margin-top:0; font-family:'Lucida Grande';">API Key Required</h3>
                <p style="font-size:13px; color:#555;">To use the AI summary features, please enter your Groq API key.</p>
                <input type="password" id="api-key-input" placeholder="gsk_..." style="width:80%; margin-top:10px;">
                <div id="api-status-indicator" style="margin-top:10px; font-size:12px;"></div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeApiModal()" style="background:#fff; color:#333; border-color:#ccc;">Cancel</button>
                <button onclick="saveApiKey()" class="primary-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button id="api-settings-btn" onclick="openApiModal()" class="primary-btn" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const GROQ_MODEL = 'meta-llama/llama-4-maverick-17b-128e-instruct'; 
        let isCSE = true;
        let currentSearchQuery = '';
        let lastProcessedQuery = '';
        let currentSummaryData = null;

        // Marked.js 옵션
        marked.setOptions({ breaks: true, gfm: true });

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        function toggleMode() {
            isCSE = !isCSE;
            const cse = document.getElementById('cse-search');
            const custom = document.getElementById('custom-search');
            const toggleBtn = document.getElementById('mode-toggle');
            
            document.getElementById('gemini-summary-container').style.display = 'none';

            if (isCSE) {
                toggleBtn.querySelector('.search-text').innerText = " Search: Google";
                custom.style.display = 'none';
                cse.style.display = 'block';
            } else {
                toggleBtn.querySelector('.search-text').innerText = " Search: Custom";
                cse.style.display = 'none';
                custom.style.display = 'block';
            }
        }

        // 시간 업데이트
        setInterval(() => {
            const now = new Date();
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('current-time').innerText = now.toLocaleString('en-US', options);
        }, 1000);

        // 검색 엔터 처리
        function handleEnter(event) { if (event.key === 'Enter') searchInGoogle(); }
        function getQuery() { return document.getElementById('search-bar').value.trim(); }
        
        // 검색 함수들
        function searchInGoogle() { const q = getQuery(); if (q) window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank'); }
        function searchInNaver() { const q = getQuery(); if (q) window.open('https://search.naver.com/search.naver?where=nexearch&sm=tab_hty&query=' + encodeURIComponent(q), '_blank'); }
        function searchInDBpia() { const q = getQuery(); if (q) window.open('https://www.dbpia.co.kr/search/topSearch?searchOption=all&query=' + encodeURIComponent(q), '_blank'); }
        function searchInGs() { const q = getQuery(); if (q) window.open('https://scholar.google.com/scholar?hl=ko&as_sdt=0%2C5&q=' + encodeURIComponent(q), '_blank'); }
        
        // ==========================================
        // API & AI FUNCTIONS (Original Prompts Restored)
        // ==========================================
        function updateApiStatus() {
            const apiKey = localStorage.getItem('GROQ_API_KEY');
            const indicator = document.getElementById('api-status-indicator');
            if (apiKey) {
                indicator.innerHTML = '<span style="color:#28cd41">●</span> API Connected';
            } else {
                indicator.innerHTML = '<span style="color:#ff3b30">●</span> No API Key';
            }
        }

        function openApiModal() {
            const modal = document.getElementById('api-modal');
            const input = document.getElementById('api-key-input');
            const savedKey = localStorage.getItem('GROQ_API_KEY');
            if (savedKey) input.value = savedKey;
            modal.classList.add('show');
            updateApiStatus();
        }

        function closeApiModal() {
            document.getElementById('api-modal').classList.remove('show');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('GROQ_API_KEY', apiKey);
                alert('Key saved successfully.');
                closeApiModal();
                updateApiStatus();
            } else {
                alert('Please enter a key.');
            }
        }

        window.addEventListener('DOMContentLoaded', updateApiStatus);

        function triggerSummary() {
            if (!currentSummaryData) return;
            const btn = document.getElementById('btn-generate-summary');
            const contentDiv = document.getElementById('gemini-summary-content');
            
            btn.disabled = true;
            btn.innerHTML = 'Thinking...';
            contentDiv.style.display = 'block';
            
            generateSummary(currentSummaryData.query, currentSummaryData.results);
        }

        async function generateSummary(query, searchResults) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            const summaryText = document.getElementById('gemini-summary-text');
            const btn = document.getElementById('btn-generate-summary');

            if (!GROQ_API_KEY) {
                summaryText.innerHTML = '<span style="color:red">Error: API Key missing.</span>';
                btn.innerHTML = 'Setup Key';
                btn.disabled = false;
                return;
            }

            summaryText.innerHTML = 'Analyzing results...';
            
            try {
                let resultsContext = '검색어: ' + query + '\n\n검색 결과:\n\n';
                searchResults.forEach((result, index) => {
                    resultsContext += `${index + 1}. ${result.title}\n${result.snippet}\n\n`;
                });
                
                // *** ORIGINAL PROMPTS RESTORED ***
                const systemPrompt = `당신은 검색 결과들을 바탕으로 사용자에게 과학적이고 간결한 요약을 제공하는 AI입니다. 다음은 "${query}"에 대한 학술 검색 결과입니다. 이 검색 결과들을 바탕으로 사용자가 알고 싶어하는 정보를 과학적이고 간결하게 요약해주세요. 한국어로 답변해주세요. 마크다운 문법을 자유롭게 사용할 수 있습니다.`;
                
                const userPrompt = `다음 검색 결과들을 종합하여 요약해주세요:\n\n${resultsContext}\n\n요약 시 다음 사항을 지켜주세요:\n1. 핵심 정보를 명확하게 정리 (마크다운 사용 가능)\n2. 검색 결과의 주요 내용을 종합적으로 설명. 마지막에 결론을 낼것.\n3. 객관적이고 중립적, 과학적이고 전문적인 톤 유지\n4. 불필요한 인사말이나 서론 없이 바로 본론으로 시작\n5. 가독성을 위해 적절히 마크다운 문법 활용 (제목, 강조, 리스트 등)`;

                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL, 
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1024,
                    })
                });

                if (!response.ok) throw new Error('API Response Error');
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    const summary = data.choices[0].message.content;
                    summaryText.innerHTML = marked.parse(summary);
                    btn.innerHTML = 'Regenerate';
                    btn.disabled = false;
                }
            } catch (error) {
                summaryText.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
                btn.innerHTML = 'Retry';
                btn.disabled = false;
            }
        }

        // ==========================================
        // OBSERVERS (SEARCH & DOM)
        // ==========================================
        function monitorSearchResults() {
            const resultsObserver = new MutationObserver(() => {
                if (!isCSE) return;
                
                const results = document.querySelectorAll('.gsc-webResult.gsc-result');
                const searchInput = document.querySelector('input.gsc-input');
                const query = searchInput ? searchInput.value.trim() : '';

                if (results.length > 0 && query && query !== lastProcessedQuery) {
                    const searchResults = [];
                    results.forEach(result => {
                        const titleElement = result.querySelector('.gs-title');
                        const snippetElement = result.querySelector('.gs-snippet');
                        if (titleElement && snippetElement) {
                            searchResults.push({
                                title: titleElement.textContent.trim(),
                                snippet: snippetElement.textContent.trim()
                            });
                        }
                    });

                    const summaryContainer = document.getElementById('gemini-summary-container');
                    if (searchResults.length > 0) {
                        lastProcessedQuery = query;
                        summaryContainer.style.display = 'block';
                        
                        // Insert above results
                        const wrapper = results[0].closest('.gsc-results-wrapper-visible') || results[0].parentElement.parentElement;
                        if(wrapper) wrapper.insertBefore(summaryContainer, wrapper.firstChild);

                        currentSummaryData = { query: query, results: searchResults.slice(0, 5) };
                        document.getElementById('gemini-summary-content').style.display = 'none'; // Initially hidden
                        document.getElementById('btn-generate-summary').innerHTML = 'Summarize Results';
                        document.getElementById('btn-generate-summary').disabled = false;
                    }
                }
                addTrustButtons();
            });

            resultsObserver.observe(document.body, { childList: true, subtree: true });
        }
        monitorSearchResults();

        // Trust Analysis Buttons
        function addTrustButtons() {
            if (!isCSE) return;
            const results = document.querySelectorAll('.gsc-webResult.gsc-result');
            results.forEach(result => {
                if (result.querySelector('.trust-button')) return;
                
                const titleLink = result.querySelector('.gs-title a');
                if (!titleLink || !titleLink.href) return;

                const btn = document.createElement('button');
                btn.className = 'trust-button';
                btn.innerHTML = 'Check Safety';
                btn.style.float = 'right';
                btn.style.fontSize = '11px';
                btn.style.padding = '2px 8px';
                btn.style.minWidth = 'auto';
                
                btn.onclick = (e) => {
                    e.stopPropagation();
                    analyzeTrust(titleLink.href, btn, result);
                };
                
                const snippet = result.querySelector('.gs-snippet');
                if(snippet) snippet.parentNode.insertBefore(btn, snippet);
            });
        }

        async function analyzeTrust(url, btn, resultContainer) {
            const GROQ_API_KEY = localStorage.getItem('GROQ_API_KEY');
            if (!GROQ_API_KEY) { openApiModal(); return; }

            const originalText = btn.innerHTML;
            btn.innerHTML = 'Scanning...';
            btn.disabled = true;

            const existingResult = resultContainer.querySelector('.trust-result');
            if (existingResult) existingResult.remove();

            try {
                const hostname = new URL(url).hostname;
                const systemPrompt = `You are a security expert.`;
                const userPrompt = `Evaluate domain: ${hostname}\n\nOutput only one word rating: 'Safe', 'Caution', 'Danger'. No other text.`;

                const response = await fetch(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.1,
                        max_tokens: 10
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const grade = data.choices[0].message.content.trim().replace(/['"]/g, '');
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'trust-result';
                
                let colorClass = 'high';
                if (grade.includes('Caution') || grade.includes('주의')) colorClass = 'medium';
                if (grade.includes('Danger') || grade.includes('위험')) colorClass = 'low';

                resultDiv.innerHTML = `Safety: <span class="trust-score ${colorClass}">${grade}</span> (${hostname})`;
                resultContainer.appendChild(resultDiv);
                
                btn.innerHTML = 'Done';
                btn.disabled = false;
            } catch (error) {
                btn.innerHTML = 'Error';
                setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
            }
        }
    </script>
</body>
  </html>
