<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QPI Ambient</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.ico">
    <meta property="og:title" content="기준타 by QPI">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/btog.png"> 
    <meta property="og:description" content="기쁨을 준비하는 타이머">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            background-color: #000;
            --primary: #90caf9;
            --on-primary-container: #003354;
            --sun-x: 50%; --sun-y: 110%;
            --moon-x: 50%; --moon-y: 110%;
            --star-opacity: 0; --star-rot: 0deg;
            --star-mask-y: -50%;
            --atm-opacity: 0;
            
            /* 동적 글래스모피즘 변수 초기값 */
            --glass-bg: rgba(20, 25, 35, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-stack: rgba(255, 255, 255, 0.1);
            --text-main: rgba(255, 255, 255, 0.95);
            --text-sub: rgba(255, 255, 255, 0.6);
            --chip-bg: rgba(255, 255, 255, 0.1);
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Roboto', sans-serif; user-select: none;
            position: fixed; top: 0; left: 0; overscroll-behavior: none;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; }
        
        button { font-family: 'Roboto', sans-serif; }

        .layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; }
        
        .sky-base { z-index: -2; background: #050a19; }
        .sky-layer { 
            position: absolute; inset: 0;
            will-change: background; 
        }

        .atmosphere { z-index: 1; background: radial-gradient(circle at var(--sun-x) var(--sun-y), rgba(255, 240, 200, 0.45) 0%, rgba(255, 180, 100, 0.2) 15%, transparent 70%); mix-blend-mode: screen; opacity: var(--atm-opacity); will-change: opacity; transform: translate3d(0,0,0); }
        .star-container { z-index: 2; top: 50%; left: 50%; width: 200vmax; height: 200vmax; transform: translate(-50%, -50%) rotate(var(--star-rot)) translate3d(0,0,0); opacity: var(--star-opacity); mask-image: linear-gradient(to bottom, #fff calc(var(--star-mask-y) - 40%), transparent calc(var(--star-mask-y) + 40%)); -webkit-mask-image: linear-gradient(to bottom, #fff calc(var(--star-mask-y) - 40%), transparent calc(var(--star-mask-y) + 40%)); will-change: opacity, transform; }
        #starCanvas { width: 100%; height: 100%; }
        
        #satLayer { z-index: 3; }
        .satellite { position: absolute; width: 1.5px; height: 1.5px; z-index: 3; background: #fff; border-radius: 50%; box-shadow: 0 0 3px 1px rgba(255,255,255,0.7); will-change: transform; }

        .celestial { z-index: 4; transform: translate3d(0,0,0); }
        .sun-disk { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 60px; height: 60px; z-index: 100; transform: translate(-50%, -50%); border-radius: 50%; background: #fff; box-shadow: 0 0 60px 20px #fff, 0 0 140px 50px rgba(255, 230, 150, 0.7), 0 0 200px 80px rgba(255, 200, 100, 0.4); will-change: left, top; }
        .moon-disk { position: absolute; left: var(--moon-x); top: var(--moon-y); width: 42px; height: 42px; z-index: 101; transform: translate(-50%, -50%); border-radius: 50%; background: #fff; box-shadow: 0 0 35px 12px #fff, 0 0 80px 25px rgba(200, 230, 255, 0.4); will-change: left, top; }
        .moon-aura { position: absolute; left: var(--moon-x); top: var(--moon-y); width: 100vmax; height: 100vmax; z-index: 90; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(180, 220, 255, 0.2) 0%, transparent 50%); mix-blend-mode: screen; will-change: left, top; }

        .lens-flare-container, .moon-flare-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; mix-blend-mode: screen; will-change: opacity; }
        .flare-ghost { position: absolute; transform: translate(-50%, -50%); border-radius: 50%; will-change: left, top; }
        .flare-halo { background: radial-gradient(circle, transparent 65%, rgba(255, 120, 60, 0.18) 68%, rgba(255, 200, 100, 0.12) 70%, rgba(120, 200, 255, 0.08) 72%, transparent 75%); filter: blur(12px); }
        .ghost-hex { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.09); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); filter: blur(3px); }
        .ghost-rainbow { background: radial-gradient(circle, transparent 35%, rgba(255, 80, 80, 0.09) 42%, rgba(255, 200, 50, 0.07) 47%, rgba(80, 255, 120, 0.06) 52%, rgba(80, 150, 255, 0.08) 57%, transparent 63%); filter: blur(16px); }
        .sun-streak { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 200vw; height: 3px; transform: translate(-50%, -50%) rotate(-3deg); background: linear-gradient(90deg, transparent, rgba(255, 230, 180, 0.5), rgba(255, 255, 255, 0.9), rgba(255, 230, 180, 0.5), transparent); filter: blur(5px); will-change: left, top; }

        .viz-canvas { position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; z-index: 10; pointer-events: none; mask-image: linear-gradient(to top, black 30%, transparent 100%); -webkit-mask-image: linear-gradient(to top, black 30%, transparent 100%); }
        
        .glass-panel-base {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            transition: background 0.5s, border 0.5s, color 0.5s;
            h3, p, span, button {
                transition: color 0.5s;
            }
        }

        .glass-panel-stack {
            background: var(--glass-stack);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            transition: background 0.5s, border 0.5s, color 0.5s;
            h3, p, span, button {
                transition: color 0.5s;
            }
        }

        /* 성능 모드 시 블러 부하 감소 (가시성은 유지) */
        body.perf-active .glass-panel-base {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .bottom-clock { 
            position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%);
            padding: 0;
            background: none; border: 0; color: var(--text-main);
            font-weight: 300; font-size: 16px; letter-spacing: 4px; z-index: 500; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            cursor: pointer; pointer-events: auto; 
            transition: color 0.5s;
        }

        .info-panel { 
            position: fixed; bottom: 90px; left: 50%; right: auto; top: auto;
            width: 320px; padding: 24px; margin: 0; border-radius: 36px;
            transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), background 0.5s, color 0.5s; 
        }
        .info-panel:popover-open {
            opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0);
            @starting-style {
                opacity: 0; transform: translateX(-50%) translateY(20px);
            }
        }
        .info-panel b { background: var(--primary); border-radius: 8px; padding-left: 0.4em; padding-right: 0.4em; color: var(--on-primary-container); font-weight: 500; transition: background 0.5s, color 0.5s; }

        .fab { 
            position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 36px; 
            cursor: pointer; z-index: 500; display: flex; justify-content: center; align-items: center; 
            transition: background 0.5s, border 0.5s;
        }
        
        .popup { 
            position: fixed; 
            bottom: 100px; right: 30px; left: auto; top: auto;
            width: 280px; padding: 28px; margin: 0; border-radius: 36px; 
            transform-origin: bottom right; 
            transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), background 0.5s, color 0.5s; 
        }
        .popup:popover-open {
            opacity: 1; transform: scale(1) translateY(0);
            @starting-style {
                opacity: 0; transform: scale(0.9) translateY(20px);
            }
        }
        
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
        .label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .manual-ui.disabled { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        .speed-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .oldchip { background: var(--chip-bg); border: 1px solid var(--glass-border); color: var(--text-main); border-radius: 8px; padding: 6px 10px; font-size: 11px; cursor: pointer; font-weight: 700; transition: background 0.5s, color 0.5s; }
        .btn-action { width: 100%; padding: 14px; background: var(--primary); color: var(--on-primary-container); border: none; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 8px; transition: background 0.5s, 0.2s; }
        input[type=range] { width: 100%; appearance: none; background: var(--chip-bg); height: 6px; border-radius: 3px; outline: none; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { appearance: none; /* The previous iteration of you has rolled back my change from '-webkit-appearance' to 'appearance'. CSS 'appearance' property is baseline since 2022. It's 2026 now. Please catch up. */ width: 24px; height: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.5s; }
        input[type=range]::-moz-range-thumb { appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: background 0.5s; }
        .switch { position: relative; width: 44px; height: 24px; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-sw { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(100,100,100,0.5); border-radius: 24px; transition: 0.3s; cursor: pointer; }
        .slider-sw:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=checkbox] + .slider-sw { transition: background 0.5s, border 0.5s, color 0.5s; }
        input:checked + .slider-sw { background: var(--primary); }
        input:checked + .slider-sw:before { transform: translateX(20px); background: var(--on-primary-container); }
        hr { border: 0; border-top: 1px solid var(--glass-border); margin-top: 20px; margin-bottom: 20px; }
        
        /* glass */
        .icon-btn,
        .segmented, .seg-btn.active,
        .study-select, .study-toggle,
        .modal input, .modal-btn, .modal .color-input,
        .item, .kpi, .weekday, .calendar, .cal-day, .msub {
            background: var(--glass-stack);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            transition: background 0.5s, border 0.5s, color 0.5s;
            :not(path) {
                transition: color 0.5s;
            }
        }

        /* primary glass */
        .study-hud.goal-hit, .chip.active, .study-toggle.running, .modal-btn.primary, .cal-day.today {
            background: color-mix(in srgb, var(--primary) 18%, transparent);
            border-color: color-mix(in srgb, var(--primary) 35%, transparent);
            color: var(--text-main);
            transition: background 0.5s cubic-bezier(0.15,1,0,1), border 0.5s cubic-bezier(0.15,1,0,1), color 0.5s cubic-bezier(0.15,1,0,1);
        }

        .study-hud {
            position: fixed;
            top: 18px; left: 50%;
            transform: translateX(-50%);
            width: min(90vw, 560px);
            z-index: 200;
            pointer-events: auto;
            border-radius: 32px;
            padding: 14px 14px 12px 14px;
            transition: background 0.5s, border 0.5s, color 0.5s, height 0.5s;
            interpolate-size: allow-keywords;
        }

        .study-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
        #study-row2 { margin-top: 12px; }
        #study-row3 { margin-top: 10px; }

        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 18px;
            cursor: pointer;
            display:flex; align-items:center; justify-content:center;
            color: var(--text-sub);
        }
        .icon-btn:active { transform: scale(0.98); }
        .icon-btn svg * {
            stroke: var(--text-main);
            fill: var(--text-main);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: stroke 0.5s, fill 0.5s;
        }

        .study-time {
            font-size: 34px;
            font-weight: 100;
            letter-spacing: 1.5px;
            color: var(--text-main);
            line-height: 1;
        }
        .study-mini { display:flex; align-items:center; gap:8px; }
        
        .goalbar {
            margin-top: 10px;
            height: 6px; border-radius: 999px;
            background: var(--glass-stack);
            transition: background 0.5s;
            overflow: hidden;
        }
        .goalbar > div {
            height:100%;
            width:0%;
            background: var(--primary);
            transition: background 0.5s, width 0.25s ease;
        }
        /* .study-hud.goal-hit: primary glass */

        .segmented {
            display:flex; gap:6px;
            border-radius: 999px;
            padding: 4px;
        }
        .seg-btn {
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-sub);
            font-size: 12px;
            letter-spacing: 0.8px;
            padding: 8px 10px;
            border-radius: 999px;
            cursor: pointer;
            white-space: nowrap;
        }
        /* .seg-btn.active: glass-panel-stack */

        .select-wrapper {
            flex: 1;
            max-width: 260px;
            display: flex;
            position: relative;
        }
        
        .study-select {
            flex: 1;
            border-radius: 20px;
            padding: 9px 12px;
            outline: none;
            font-size: 12px;
            letter-spacing: 0.5px;
            appearance: none;
        }
        .study-select:disabled { opacity: 0.7; }

        .select-arrow {
            position: absolute;
            stroke: var(--text-main); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
            fill: none;
            right: 0; top: 0; bottom: 0; margin-top: auto; margin-bottom: auto;
            transition: fill 0.5s;
            pointer-events: none;
        }

        .chipbar {
            display:flex;
            flex: 1;
            gap:8px;
            overflow:auto;
            padding-bottom: 2px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            mask-image: linear-gradient(to right, var(--left-mask) 0, black 40px calc(100% - 40px), var(--right-mask) 100%);
            --left-mask: transparent;
            --right-mask: transparent;
        }
        .chipbar::-webkit-scrollbar { display:none; }
        .chip {
            flex: 0 0 auto;
            display:flex; align-items:center; gap:8px;
            border-radius: 999px;
            padding: 9px 12px;
            font-size: 12px;
            letter-spacing: 0.4px;
            color: var(--text-sub);
            background: var(--chip-bg);
            border: 1px solid var(--glass-border);
            transition: background 0.5s, border 0.5s, color 0.5s;
            cursor: pointer;
        }
        /* .chip.active: primary glass */
        .chip .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--chip-bg);
        }
        .chip.active .dot {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        .study-toggle {
            border-radius: 22px;
            padding: 10px 14px;
            cursor: pointer;
            display:flex; align-items:center; gap:10px;
            letter-spacing: 1px;
            font-size: 12px;
        }
        /* .study-toggle.running: primary glass */

        .modal::backdrop {
            backdrop-filter: blur(3px);
            transition: backdrop-filter 0.3s;
            @starting-style {
                backdrop-filter: blur(0);
            }
        }
        .modal {
            width: min(86vw, 420px);
            border-radius: 36px;
            padding: 18px;
        }
        .modal h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.6px;
        }
        .modal p {
            margin: 0 0 14px 0;
            font-size: 12px;
            font-weight: 300;
            color: var(--text-sub);
            line-height: 1.5;
        }
        .modal input {
            width: 100%;
            box-sizing: border-box;
            border-radius: 14px;
            padding: 12px 12px;
            outline: none;
            font-size: 13px;
            letter-spacing: 0.2px;
        }
        .modal-actions {
            margin-top: 14px;
            display:flex; justify-content:flex-end; gap:10px;
        }
        .modal-btn {
            color: var(--text-sub);
            border-radius: 22px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        /* .modal-btn.primary: primary glass */
        .modal-btn.danger {
            color: hsla(from var(--primary) 0 s l / 95%);
            border-color: hsla(from var(--primary) 0 s l / 35%);
            background: hsla(from var(--primary) 0 s l / 18%);
            transition: background 0.5s, border 0.5s, color 0.5s;
        }

        .color-row { margin-top: 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .colors { display:flex; gap:8px; flex-wrap: wrap; }
        .cdot {
            width: 22px; height: 22px; border-radius: 50%;
            border: 1px solid var(--glass-border);
            cursor:pointer;
        }
        .cdot.active { box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 50%, transparent); }
        .modal .color-input {
            width: 42px; height: 34px;
            border-radius: 12px;
            padding: 0 6px;
        }

        .sheet {
            display: flex;
            flex-direction: column;
            overflow-y: hidden;
            visibility: hidden;
            max-height: 0;
            transition: max-height 0.2s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.2s;
            transition-behavior: allow-discrete;
        }
        .sheet.active {
            visibility: visible;
            max-height: min(490px, 100vh - 260px);
            margin-bottom: 2px;
        }
        #panelHR { margin-top: 15px; margin-bottom: 15px; width: 100%; }
        .sheet-header {
            display:flex; align-items:center; justify-content:space-between;
            margin-bottom: 10px;
        }
        .sheet-title {
            font-size: 13px;
            letter-spacing: 0.8px;
            color: var(--text-main);
            font-weight: 400;
            margin-top: 6px;
            margin-left: 11px;
        }
        .sheet-sub {
            font-size: 11px;
            letter-spacing: 0.4px;
            color: var(--text-sub);
            margin-top: 2px;
            margin-left: 11px
        }
        .sheet-scroll {
            scrollbar-width: none;
            overflow-y: scroll;
            mask-image: linear-gradient(to bottom, var(--top-mask), black 15px calc(100% - 15px), var(--bottom-mask) 100%);
            --top-mask: transparent;
            --bottom-mask: transparent;
        }

        .list {
            margin-top: 10px;
            display:flex; flex-direction:column; gap:10px;
            max-height: 38vh;
            overflow:auto;
            -webkit-overflow-scrolling: touch;
        }
        .list#breakDownList { max-height: 30vh; }
        .list#dayDetailList { max-height: 45vh; }
        .list#subjectsManageList { max-height: 40vh; }

        .item {
            border-radius: 22px;
            padding: 12px;
        }
        .item-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .item-name {
            font-size: 12px;
            letter-spacing: 0.4px;
            color: var(--text-main);
            font-weight: 400;
            overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
            max-width: 65%;
        }
        .item-time {
            font-size: 12px;
            letter-spacing: 1px;
            color: var(--text-sub);
            font-weight: 300;
        }
        .bar {
            margin-top: 8px;
            height: 6px;
            border-radius: 999px;
            background: var(--glass-stack);
            transition: background 0.5s;
            overflow:hidden;
        }
        .bar > div { height: 100%; width: 0%; background: var(--primary) 75%; transition: background 0.5s; }
        .sheet-actions {
            bottom: 0;
            margin-top: 12px;
            display:flex; gap:10px; justify-content:space-between; align-items:center;
        }

        .panel-tabs { margin: 10px 0 12px 0; }
        .tab-btn { flex: 1; }

        .tab { display: none; }
        .tab.active { display: block; }

        .kpi {
            flex:1;
            border-radius: 22px;
            padding: 12px;
        }
        .kpi .kpi-label {
            font-size: 11px; letter-spacing: 0.6px;
            color: var(--text-sub);
        }
        .kpi .kpi-value {
            margin-top: 6px;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-main);
            font-weight: 300;
        }
        .kpi .kpi-sub {
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-sub);
        }

        .period-row { margin-top: 10px; }

        .weekday {
            margin-top: 10px;
            border-radius: 22px;
            padding: 12px;
        }
        .week-bars { display: flex; gap: 8px; align-items: flex-end; height: 86px; }
        .week-bar { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .week-bar .barcol {
            width: 100%;
            border-radius: 10px;
            background: var(--glass-stack);
            transition: background 0.5s;
            overflow:hidden;
            height: 64px;
            display:flex; align-items:flex-end;
        }
        .week-bar .barcol > div {
            width: 100%;
            height: 0%;
            background: var(--primary);
        }
        .week-bar.zero .barcol { background: color-mix(in srgb, var(--glass-stack) 50%, transparent); }
        .week-bar .wlabel {
            font-size: 10px;
            letter-spacing: 0.5px;
            color: var(--text-sub);
        }
        .week-bar.zero .wlabel { opacity: 0.35; }

        .calendar {
            margin-top: 8px;
            border-radius: 18px;
            padding: 12px;
        }
        .cal-header { margin-bottom: 8px; }
        .cal-title { font-size: 13px; letter-spacing: 0.8px; color: var(--text-main); }
        .cal-grid {
            display:grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .cal-dow {
            font-size: 10px;
            color: var(--text-sub);
            text-align:center;
            letter-spacing: 0.6px;
            padding: 4px 0;
        }
        .cal-day {
            border-radius: 14px;
            padding: 8px 8px 7px 8px;
            min-height: 52px;
            cursor:pointer;
            display:flex; flex-direction:column; justify-content:space-between;
        }
        .cal-day.off { opacity: 0.3; cursor: default; }
        /* .cal-day.today: primary glass */
        .cal-day .dnum { font-size: 12px; color: var(--text-main); letter-spacing: 0.6px; }
        .cal-day .dtime { font-size: 10px; color: var(--text-sub); letter-spacing: 0.8px; }

        .msub {
            border-radius: 16px;
            padding: 12px;
            display:flex; align-items:center; justify-content:space-between; gap:10px;
        }
        .swatch { width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 0 2px var(--glass-stack); }
        .msub-name { font-size: 12px; color: var(--text-main); letter-spacing: 0.5px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
        .msub-time { font-size: 11px; color: var(--text-sub); letter-spacing: 0.8px; white-space: nowrap; }

        @media (max-width: 420px) {
            .study-time { font-size: 30px; }
            .study-hud { padding: 13px 12px 11px 12px; }
        }
    </style>
    <script src="./tinicolor.js" type="text/javascript"></script>
</head>
<body>
    <div class="layer sky-base"></div>
    <div id="skyLayer" class="layer sky-layer"></div>
    <div class="layer atmosphere"></div>
    <div class="layer star-container"><canvas id="starCanvas"></canvas></div>
    <div id="satLayer" class="layer"></div>
    <div class="layer celestial"><div class="moon-aura"></div><div class="moon-disk"></div><div class="sun-disk"></div></div>

    <div class="lens-flare-container" id="sunFlareCont">
        <div class="sun-streak"></div>
        <div class="flare-ghost flare-halo" id="h-1" style="width: 60vmax; height: 60vmax;"></div>
        <div class="flare-ghost ghost-rainbow" id="r-1" style="width: 500px; height: 500px;"></div>
        <div class="flare-ghost ghost-hex" id="g-1" style="width: 100px; height: 100px;"></div>
        <div class="flare-ghost ghost-hex" id="g-2" style="width: 50px; height: 50px; background: rgba(150, 255, 200, 0.12);"></div>
        <div class="flare-ghost ghost-tiny" id="t-1" style="width: 10px; height: 10px; background: #fff; box-shadow: 0 0 10px #fff;"></div>
    </div>

    <div class="moon-flare-container" id="moonFlareCont">
        <div class="flare-ghost ghost-hex" id="mg-1" style="width: 40px; height: 40px; background: rgba(200, 230, 255, 0.1);"></div>
        <div class="flare-ghost flare-halo" id="mh-1" style="width: 20vmax; height: 20vmax; opacity: 0.2;"></div>
    </div>

    <div class="glass-panel-base study-hud" id="studyHud">
        <div class="study-row" id="study-row1">
            <div class="study-time" id="studyTime">00:00:00</div>
            <div class="study-mini">
                <button class="icon-btn" id="openStatsBtn" aria-label="Stats">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M4 19V10"/><path d="M10 19V5"/><path d="M16 19V13"/><path d="M22 19H2"/>
                    </svg>
                </button>
                <button class="icon-btn" id="addSubjectBtn" aria-label="Add Subject">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19"/><path d="M5 12H19"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="goalbar"><div id="goalBarFill"></div></div>

        <div class="study-row" id="study-row2">
            <div class="segmented" role="tablist" aria-label="Timer View Mode">
                <button class="seg-btn active" id="modeTotalBtn" type="button">오늘 총 공부</button>
                <button class="seg-btn" id="modeSubjectBtn" type="button">과목</button>
            </div>
            <div class="select-wrapper">
                <select class="study-select" id="subjectSelect" aria-label="Subject Select" disabled>
                    <option value="">과목 선택</option>
                </select>
                <svg class="select-arrow" height='24' viewBox='0 0 24 24' width='24'>
                    <path d='M4 10l4 4 4-4'/>
                </svg>
            </div>
        </div>

        <div class="study-row" id="study-row3">
            <div class="chipbar" id="subjectChips" aria-label="Subject Buttons"></div>
            <button class="study-toggle" id="studyToggleBtn" type="button" aria-label="Start/Pause">
                <span id="studyToggleIcon" style="display: flex;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M8 5V19L19 12L8 5Z" fill="var(--text-main)" style="transition: fill 0.5s;"/>
                    </svg>
                </span>
                <span id="studyToggleText">START</span>
            </button>
        </div>
        <div class="sheet" id="panelSheet">
            <hr id="panelHR">
            <div class="sheet-header">
                <div>
                    <div class="sheet-title" id="panelTitle">통계</div>
                    <div class="sheet-sub" id="panelSubtitle">—</div>
                </div>
                <button class="icon-btn" id="closePanelBtn" aria-label="Close Panel">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6L18 18"/><path d="M18 6L6 18"/>
                    </svg>
                </button>
            </div>
            <div class="segmented panel-tabs" role="tablist" aria-label="Panels">
                <button class="seg-btn tab-btn active" id="tabBtnStats" type="button">통계</button>
                <button class="seg-btn tab-btn" id="tabBtnCalendar" type="button">캘린더</button>
                <button class="seg-btn tab-btn" id="tabBtnSubjects" type="button">과목</button>
                <button class="seg-btn tab-btn" id="tabBtnGoal" type="button">목표</button>
            </div>

            <div class="sheet-scroll" id="panelScroll">
                <section class="tab active" id="tabStats">
                    <div class="item-row">
                        <div class="kpi">
                            <div class="kpi-label">오늘</div>
                            <div class="kpi-value" id="kpiToday">00:00:00</div>
                            <div class="kpi-sub" id="kpiTodaySub">목표 —</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">이번 주</div>
                            <div class="kpi-value" id="kpiWeek">00:00:00</div>
                            <div class="kpi-sub" id="kpiWeekSub">평균 —</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">이번 달</div>
                            <div class="kpi-value" id="kpiMonth">00:00:00</div>
                            <div class="kpi-sub" id="kpiMonthSub">평균 —</div>
                        </div>
                    </div>

                    <div class="item-row period-row">
                        <div class="segmented" role="tablist" aria-label="Stats Period">
                            <button class="seg-btn active" id="periodTodayBtn" type="button">오늘</button>
                            <button class="seg-btn" id="periodWeekBtn" type="button">주</button>
                            <button class="seg-btn" id="periodMonthBtn" type="button">달</button>
                        </div>
                        <button class="modal-btn" id="exportBtn" type="button">내보내기</button>
                    </div>

                    <div class="list" id="breakdownList"></div>

                    <div class="weekday">
                        <div class="item-row" style="margin-bottom:10px;">
                            <div class="item-name">요일별 공부량 (이번 주)</div>
                            <div class="item-time" id="focusInfo">최장 집중 —</div>
                        </div>
                        <div class="week-bars" id="weekdayBars"></div>
                    </div>

                    <div class="sheet-actions">
                        <button class="modal-btn danger" id="resetTodayBtn" type="button">오늘 초기화</button>
                        <button class="modal-btn danger" id="resetAllBtn" type="button">전체 초기화</button>
                    </div>
                </section>

                <section class="tab" id="tabCalendar">
                    <div class="calendar">
                        <div class="item-row cal-header">
                            <button class="icon-btn" id="calPrevBtn" aria-label="Prev Month">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M15 6L9 12L15 18"/>
                                </svg>
                            </button>
                            <div class="cal-title" id="calTitle">—</div>
                            <button class="icon-btn" id="calNextBtn" aria-label="Next Month">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 6L15 12L9 18"/>
                                </svg>
                            </button>
                        </div>
                        <div class="cal-grid" id="calDow"></div>
                        <div class="cal-grid" id="calGrid"></div>
                    </div>
                </section>

                <section class="tab" id="tabSubjects">
                    <div class="item" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <div>
                            <div class="item-name">과목 관리</div>
                            <div class="sheet-sub">추가/수정/삭제 · 색상 설정</div>
                        </div>
                        <button class="icon-btn" id="addSubjectBtn2" aria-label="Add Subject">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19"/><path d="M5 12H19"/>
                            </svg>
                        </button>
                    </div>
                    <div class="list" id="subjectsManageList"></div>
                </section>

                <section class="tab" id="tabGoal">
                    <div class="item">
                        <div class="item-row">
                            <div class="item-name">하루 목표 공부 시간</div>
                            <div class="item-time" id="goalNow">—</div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <input id="goalHours" type="number" min="0" max="23" value="2" style="flex:1; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.92); padding:12px; outline:none; font-size:13px;" />
                            <input id="goalMinutes" type="number" min="0" max="59" value="0" style="flex:1; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.92); padding:12px; outline:none; font-size:13px;" />
                        </div>
                        <div class="sheet-sub" style="margin-top:8px;">시간(왼쪽) · 분(오른쪽)</div>
                        <div class="modal-actions" style="margin-top:12px;">
                            <button class="modal-btn" id="goalResetBtn" type="button">기본값</button>
                            <button class="modal-btn primary" id="goalSaveBtn" type="button">저장</button>
                        </div>
                    </div>
                    <div class="item" style="margin-top:10px;">
                        <div class="item-row">
                            <div class="item-name">오늘 달성률</div>
                            <div class="item-time" id="goalProgressText">—</div>
                        </div>
                        <div class="bar" style="margin-top:10px;"><div id="goalProgressBar" style="width:0%"></div></div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <dialog id="subjectModal" class="glass-panel-base modal" role="dialog" aria-modal="true" aria-labelledby="subjectModalTitle">
        <h3 id="subjectModalTitle">과목</h3>
        <p id="subjectModalDesc">과목을 추가/수정하면 과목별 누적 시간이 자동 기록됩니다.</p>
        <input id="subjectNameInput" type="text" placeholder="예) 수학, 물리, 영어" maxlength="24" />
        <div class="color-row">
            <div class="colors" id="colorDots" aria-label="Color Presets"></div>
            <input class="color-input" id="subjectColorInput" type="color" value="#90caf9" aria-label="Custom Color"/>
        </div>
        <div class="modal-actions">
            <button class="modal-btn danger" id="subjectDeleteBtn" type="button" style="display:none">삭제</button>
            <div style="flex:1"></div>
            <button class="modal-btn" id="subjectCancelBtn" type="button">취소</button>
            <button class="modal-btn primary" id="subjectSaveBtn" type="button">저장</button>
        </div>
    </dialog>

    <!-- Day Detail Modal -->
    <dialog id="dayDetailModal" class="glass-panel-base modal" role="dialog" aria-modal="true" aria-labelledby="dayDetailTitle">
        <h3 id="dayDetailTitle">—</h3>
        <p id="dayDetailSub">—</p>
        <div class="list" id="dayDetailList"></div>
        <div class="modal-actions">
            <button class="modal-btn" id="dayDetailCloseBtn" type="button">닫기</button>
        </div>
    </dialog>

    <!-- Confirm Modal -->
    <dialog id="confirmModal" class="glass-panel-base modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
        <h3 id="confirmTitle">확인</h3>
        <p id="confirmText">—</p>
        <div class="modal-actions">
            <button class="modal-btn" id="confirmCancelBtn" type="button">취소</button>
            <button class="modal-btn danger" id="confirmOkBtn" type="button">확인</button>
        </div>
    </dialog>

    <button class="bottom-clock" id="clock" popovertarget="infoPanel" onclick="toggleInfo()"><span id="clockT">00:00:00</span><span style="position: absolute; inset: 0;"></span></button>
    <dialog popover="auto" class="info-panel glass-panel-base" id="infoPanel">
        <div class="row"><span><b>DATE</b> <span id="infoDate">-</span></span></div>
        <div class="row" style="font-size: 10px;"><span><b>RISE</b> <span id="infoRise">-</span></span><span><b>SET</b> <span id="infoSet">-</span></span></div>
        <hr>
        <div class="row"><span class="label">Auto Sync</span><label class="switch"><input type="checkbox" id="autoCheck" checked onchange="handleSyncToggle()"><span class="slider-sw"></span></label></div>
        <div id="manualSection" class="manual-ui disabled">
            <div class="row" style="flex-direction:column; align-items:flex-start; gap:4px;"><span class="label">Time Slider</span><input type="range" id="timeRange" min="0" max="1439.99" step="0.01" value="720"></div>
            <div class="row"><span class="label">Speed (<span id="speedVal">1</span>x)</span><div class="speed-chips"><button class="oldchip" onclick="adjustSpeed(0.5)">x0.5</button><button class="oldchip" onclick="adjustSpeed(2)">x2</button><button class="oldchip" onclick="adjustSpeed(-1)">x-1</button></div></div>
        </div>
    </dialog>
    
    <button class="fab glass-panel-base" popovertarget="popup"><svg style="width:24px;height:24px;fill:var(--text-main); transition:fill 0.5s" viewBox="0 0 24 24"><path d="M 12 15.5 A 3.5 3.5 0 0 1 8.5 12 A 3.5 3.5 0 0 1 12 8.5 A 3.5 3.5 0 0 1 15.5 12 A 3.5 3.5 0 0 1 12 15.5 M 19.43 12.97 C 19.47 12.65 19.5 12.33 19.5 12 C 19.5 11.67 19.47 11.34 19.43 11.03 L 21.54 9.37 C 21.73 9.22 21.78 8.95 21.66 8.73 L 19.66 5.27 C 19.54 5.05 19.27 4.96 19.05 5.05 L 16.56 6.05 C 16.04 5.66 15.47 5.32 14.87 5.07 L 14.5 2.42 C 14.46 2.18 14.25 2 14 2 H 10 C 9.75 2 9.54 2.18 9.5 2.42 L 9.13 5.07 C 8.53 5.32 7.96 5.66 7.44 6.05 L 4.95 5.05 C 4.73 4.96 4.46 5.05 4.34 5.27 L 2.34 8.73 C 2.21 8.95 2.27 9.22 2.46 9.37 L 4.57 11.03 C 4.53 11.34 4.5 12 4.57 11.03 C 4.5 12.33 4.53 12.65 4.57 12.97 L 2.46 14.63 C 2.27 14.78 2.21 15.05 2.34 15.27 L 4.34 18.73 C 4.46 18.95 4.73 19.03 4.95 18.95 L 7.44 17.94 C 7.96 18.34 8.53 18.68 9.13 18.93 L 9.5 21.58 C 9.54 21.82 9.75 22 10 22 H 14 C 14.25 22 14.46 21.82 14.5 21.58 L 14.87 18.93 C 15.47 18.67 16.04 18.34 16.56 17.94 L 19.05 18.95 C 19.27 19.03 19.54 18.95 19.66 18.73 L 21.66 15.27 C 21.78 15.05 21.73 14.78 21.54 14.63 L 19.43 12.97 Z"/></svg></button>
    <dialog popover="auto" class="popup glass-panel-base" id="popup">
        <div class="row"><span class="label">Performance Mode</span><label class="switch"><input type="checkbox" id="perfToggle"><span class="slider-sw"></span></label></div>
        <hr>
        <div class="row"><span class="label">Ambient Night</span><label class="switch"><input type="checkbox" class="soundToggle" value="0"><span class="slider-sw"></span></label></div>
        <div class="row"><span class="label">Ambient Dark</span><label class="switch"><input type="checkbox" class="soundToggle" value="1"><span class="slider-sw"></span></label></div>
        <div class="row"><span class="label">Ambient Ambient</span><label class="switch"><input type="checkbox" class="soundToggle" value="2"><span class="slider-sw"></span></label></div>
        <div class="row" style="flex-direction:column; align-items:flex-start; gap:4px;"><span class="label">Volume</span><input type="range" id="volumeRange" min="0" max="100" step="1" value="50"></div>
        <button class="btn-action" id="btnViz">ENABLE VISUALIZER</button>
    </dialog>
    <canvas id="vizCanvas" class="viz-canvas"></canvas>

    <script>
        const LAT = 36.5, LON = 127.2;
        const root = document.documentElement.style;
        const skyLayer = document.getElementById('skyLayer');
        const clockEl = document.getElementById('clockT');
        const timeRangeEl = document.getElementById('timeRange');
        const autoCheckEl = document.getElementById('autoCheck');
        
        // --- 성능 보간 변수 ---
        const perfToggleEl = document.getElementById('perfToggle');
        let isPerfMode = localStorage.getItem('qpi_perf_mode_v2') === 'true';
        let frameCounter = -1; // 렌더링 스로틀링용, 첫 프레임은 무조건 렌더

        const flareEls = {
            'h-1': document.getElementById('h-1'), 'r-1': document.getElementById('r-1'),
            'g-1': document.getElementById('g-1'), 'g-2': document.getElementById('g-2'),
            't-1': document.getElementById('t-1'), 'mg-1': document.getElementById('mg-1'),
            'mh-1': document.getElementById('mh-1'),
            'sunFC': document.getElementById('sunFlareCont'),
            'moonFC': document.getElementById('moonFlareCont')
        };

        // 초기 성능 설정 적용
        perfToggleEl.checked = isPerfMode;
        if(isPerfMode) document.body.classList.add('perf-active');

        perfToggleEl.onchange = (e) => {
            isPerfMode = e.target.checked;
            localStorage.setItem('qpi_perf_mode_v2', isPerfMode);
            if(isPerfMode) document.body.classList.add('perf-active');
            else document.body.classList.remove('perf-active');
        };

        let manualMinutes = 720, lastTimestamp = performance.now(), currentSpeed = 1;
        let isCatchingUp = false, catchUpStartMinutes = 0, catchUpStartTime = 0;
        const CATCHUP_DURATION = 2000;

        let cachedSunTimes = null, lastCachedDateStr = "";

        function getSunTimes(date) {
            const dateStr = date.toDateString();
            if (cachedSunTimes && lastCachedDateStr === dateStr) return cachedSunTimes;
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const rad = Math.PI / 180;
            const gamma = 2 * Math.PI / 365 * (dayOfYear - 1);
            const eqtime = 229.18 * (0.000075 + 0.001868 * Math.cos(gamma) - 0.032077 * Math.sin(gamma) - 0.014615 * Math.cos(2*gamma) - 0.040849 * Math.sin(2*gamma));
            const decl = 0.006918 - 0.399912 * Math.cos(gamma) + 0.070257 * Math.sin(gamma);
            const ha_rad = Math.acos(Math.cos(90.833 * rad) / (Math.cos(LAT * rad) * Math.cos(decl)) - Math.tan(LAT * rad) * Math.tan(decl));
            const ha = ha_rad / rad;
            lastCachedDateStr = dateStr;
            cachedSunTimes = { sunrise: 720 - 4 * (LON + ha) - eqtime + 540, sunset: 720 - 4 * (LON - ha) - eqtime + 540 };
            return cachedSunTimes;
        }

        const starCanvas = document.getElementById('starCanvas'), sCtx = starCanvas.getContext('2d');
        function initStars() {
            let seed = 277;
            const random = () => { seed = (1664525 * seed + 1013904223) % 4294967296; return seed / 4294967296; };
            starCanvas.width = 4000; starCanvas.height = 4000;
            sCtx.fillStyle = "#fff";
            for(let i=0; i<8000; i++) {
                sCtx.globalAlpha = Math.random(); 
                sCtx.beginPath(); sCtx.arc(random()*4000, random()*4000, random()*1.3+0.3, 0, Math.PI*2); sCtx.fill();
            }
            sCtx.globalAlpha = 1.0;
            sCtx.beginPath(); sCtx.arc(2000, 2000, 1.6, 0, Math.PI*2); sCtx.fill(); 
        }
        initStars();

        function updateOptics(sx, sy, alt, isMoon = false) {
            const cont = isMoon ? flareEls.moonFC : flareEls.sunFC;
            const fadeStart = 0; 
            const visibleRange = 0.3; 
            const rawOpacity = (alt - fadeStart) / visibleRange;
            const finalOpacity = Math.max(0, Math.min(1, rawOpacity));
            
            const maxOpacity = isMoon ? 0.4 : 0.95;
            cont.style.opacity = finalOpacity * maxOpacity;
            
            if (finalOpacity <= 0) return;

            const dx = 50 - sx, dy = 50 - sy;
            const setFP = (id, s) => { 
                const el = flareEls[id];
                if(el){
                    el.style.left = (sx + dx * s) + '%'; 
                    el.style.top = (sy + dy * s) + '%'; 
                }
            };

            if(!isMoon) {
                setFP('h-1', 0.5); setFP('r-1', 1.3); setFP('g-1', 1.6); setFP('g-2', 1.1); setFP('t-1', 0.25);
            } else {
                setFP('mg-1', 1.2); setFP('mh-1', 0.5);
            }
        }

        let lastZenith = "", lastHorizon = "";

        function updateSky(m) {
            const mG = (m % 1440 + 1440) % 1440; 
            const solar = getSunTimes(new Date());
            
            const dawnStart = solar.sunrise - 135;
            const preSunset = solar.sunset - 135;
            const sunsetEnd = solar.sunset + 30;
            
            const kf = [
                { m: -1440, z: [5, 10, 25], hz: [10, 20, 35] },
                { m: dawnStart, z: [5, 10, 25], hz: [10, 20, 35] }, 
                { m: solar.sunrise, z: [40, 80, 140], hz: [255, 150, 100] }, 
                { m: (solar.sunrise + solar.sunset)/2, z: [25, 90, 180], hz: [180, 230, 255] },
                { m: preSunset, z: [25, 90, 180], hz: [180, 230, 255] },
                { m: solar.sunset, z: [20, 30, 80], hz: [245, 125, 75] }, 
                { m: solar.sunset + 15, z: [10, 15, 40], hz: [60, 30, 60] }, 
                { m: sunsetEnd, z: [5, 10, 25], hz: [10, 20, 35] }, 
                { m: 1440, z: [5, 10, 25], hz: [10, 20, 35] }
            ];
            
            let zenith = 'rgb(5, 10, 25)', horizon = 'rgb(10, 20, 35)';
            let brightness = 15;

            for(let i=0; i<kf.length-1; i++){
                if(mG >= kf[i].m && mG < kf[i+1].m){
                    const t = (mG - kf[i].m) / (kf[i+1].m - kf[i].m);
                    const l = (c1, c2) => c1 + (c2-c1)*t;
                    const r = Math.round(l(kf[i].hz[0], kf[i+1].hz[0]));
                    const g = Math.round(l(kf[i].hz[1], kf[i+1].hz[1]));
                    const b = Math.round(l(kf[i].hz[2], kf[i+1].hz[2]));
                    const zr = Math.round(l(kf[i].z[0], kf[i+1].z[0]));
                    const zg = Math.round(l(kf[i].z[1], kf[i+1].z[1]));
                    const zb = Math.round(l(kf[i].z[2], kf[i+1].z[2]));
                    zenith = `rgb(${zr}, ${zg}, ${zb})`;
                    horizon = `rgb(${r}, ${g}, ${b})`;
                    brightness = (r + g + b) / 3;
                    break;
                }
            }
            
            let tContrast = Math.min(1, Math.max(0, (brightness - 22) / 200));
            if (tContrast < 0.5) tContrast *= 0.5;
            if (tContrast > 0.5) tContrast = tContrast * 0.5 + 0.5;
            const dark_colors = [
                20, 25, 35, 0.65,
                255, 255, 255,
                255, 255, 255,
                0x90, 0xca, 0xf9,
                0x00, 0x33, 0x54,
                255, 0.1,
                255, 255, 255, 0.08
            ]
            const bright_colors = [
                235, 245, 255, 0.45,
                0, 20, 40,
                0, 20, 50,
                0x00, 0x7a, 0xff,
                0xfa, 0xfa, 0xfa,
                55, 0.2,
                235, 245, 255, 0.16
            ]
            const colors = dark_colors.map((e,i) => (e*(1-tContrast) + bright_colors[i]*tContrast));
            root.setProperty('--glass-bg', `rgba(${colors[0]}, ${colors[1]}, ${colors[2]}, ${colors[3]})`);
            root.setProperty('--text-main', `rgb(${colors[4]}, ${colors[5]}, ${colors[6]})`);
            root.setProperty('--text-sub', `rgba(${colors[7]}, ${colors[8]}, ${colors[9]}, 0.7)`);
            root.setProperty('--primary', `rgb(${colors[10]}, ${colors[11]}, ${colors[12]})`);
            root.setProperty('--on-primary-container', `rgb(${colors[13]}, ${colors[14]}, ${colors[15]})`);
            root.setProperty('--glass-border', `rgba(${colors[16]}, ${colors[16]}, ${colors[16]}, ${colors[17]})`);
            root.setProperty('--glass-stack', `rgba(${colors[18]}, ${colors[19]}, ${colors[20]}, ${colors[21]})`);
            root.setProperty('--chip-bg', `rgba(${colors[16]}, ${colors[16]}, ${colors[16]}, 0.1)`);

            if (zenith !== lastZenith || horizon !== lastHorizon) {
                skyLayer.style.background = `linear-gradient(to bottom, ${zenith} 0%, ${horizon} 100%)`;
                lastZenith = zenith; lastHorizon = horizon;
            }
            
            const sunMargin = 20;
            if(mG >= solar.sunrise - sunMargin && mG <= solar.sunset + sunMargin){
                const prog = (mG - solar.sunrise) / (solar.sunset - solar.sunrise);
                const sunAlt = Math.sin(prog * Math.PI); 
                const sx = prog * 120 - 10;
                const sy = 100 - sunAlt * 90;
                root.setProperty('--sun-x', sx + '%'); 
                root.setProperty('--sun-y', sy + '%');
                root.setProperty('--atm-opacity', Math.max(0, Math.min(0.85, sunAlt * 1.2)));
                updateOptics(sx, sy, sunAlt, false);
            } else { 
                root.setProperty('--sun-y', '150%'); 
                root.setProperty('--atm-opacity', 0); 
                flareEls.sunFC.style.opacity = 0;
            }
            
            const moonM = (mG + 720) % 1440;
            if(moonM >= solar.sunrise - 140 && moonM <= solar.sunset + 140){
                const prog = (moonM - (solar.sunrise - 120)) / ((solar.sunset + 120) - (solar.sunrise - 120));
                const alt = Math.sin(prog * Math.PI); 
                const mx = prog * 120 - 10;
                const my = 100 - alt * 90;
                root.setProperty('--moon-x', mx + '%'); 
                root.setProperty('--moon-y', my + '%');
                updateOptics(mx, my, alt, true);
            } else { 
                root.setProperty('--moon-y', '150%'); 
                flareEls.moonFC.style.opacity = 0;
            }
            
            let sOp = 0, sMaskY = -50;
            if (mG >= solar.sunset - 180 && mG <= solar.sunset + 30) { sOp = (mG - (solar.sunset - 180)) / 210; sMaskY = -50 + (200 * sOp); } 
            else if (mG >= solar.sunrise - 60 && mG <= solar.sunrise + 180) { sOp = 1 - (mG - (solar.sunrise - 60)) / 240; sMaskY = 150 - (200 * (1 - sOp)); } 
            else if (mG > solar.sunset + 30 || mG < solar.sunrise - 60) { sOp = 1; sMaskY = 150; }
            root.setProperty('--star-opacity', Math.max(0, Math.min(1, sOp))); 
            root.setProperty('--star-mask-y', sMaskY + '%');
            root.setProperty('--star-rot', (mG/4)+'deg');
            
            const hRaw = Math.floor(mG/60), mins = Math.floor(mG%60), secs = Math.round((mG*60)%60);
            const newText = `${hRaw.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            clockEl.textContent = newText;
        }

        function handleSyncToggle() { 
            if (autoCheckEl.checked) { 
                isCatchingUp = true; catchUpStartTime = performance.now(); catchUpStartMinutes = manualMinutes; 
                document.getElementById('manualSection').classList.add('disabled'); 
            } else { 
                isCatchingUp = false; document.getElementById('manualSection').classList.remove('disabled'); 
                const d = new Date(); manualMinutes = d.getHours()*60 + d.getMinutes() + d.getSeconds()/60; 
            } 
        }

        function adjustSpeed(f) {
            let currentSign = ((currentSpeed * f) > 0) ? 1 : -1;
            currentSpeed = currentSign * Math.max(0.5, Math.min(1024, Math.abs(currentSpeed * f))); 
            document.getElementById('speedVal').textContent = currentSpeed; 
        }

        function toggleInfo() { 
            const s = getSunTimes(new Date()); 
            document.getElementById('infoRise').textContent = formatMinutes(s.sunrise); 
            document.getElementById('infoSet').textContent = formatMinutes(s.sunset); 
            document.getElementById('infoDate').textContent = new Date().toLocaleDateString('ko-KR', {month:'short', day:'numeric', weekday:'short'}); 
        }
        function formatMinutes(minutes) { const mSafe = (minutes + 1440) % 1440; return `${Math.floor(mSafe/60).toString().padStart(2,'0')}:${Math.floor(mSafe%60).toString().padStart(2,'0')}`; }

        timeRangeEl.oninput = function() { if (!autoCheckEl.checked) { manualMinutes = parseFloat(this.value); updateSky(manualMinutes); } };

        function loop(now) {
            const dt = now - lastTimestamp; 
            lastTimestamp = now;
            frameCounter++;

            let m; 
            const d = new Date();
            const target = d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
            
            if (autoCheckEl.checked) {
                if (isCatchingUp) {
                    let t = Math.min((now - catchUpStartTime) / CATCHUP_DURATION, 1);
                    let ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
                    let dist = (target - catchUpStartMinutes + 1440) % 1440; 
                    if(dist > 720) dist -= 1440;
                    m = catchUpStartMinutes + (dist * ease); 
                    if (t >= 1) isCatchingUp = false; 
                    manualMinutes = m;
                } else { m = target; manualMinutes = m; }
            } else { 
                manualMinutes += (dt / 60000) * currentSpeed; 
                m = manualMinutes; 
            }

            // 시계와 슬라이더는 부드러움을 위해 매 프레임 업데이트
            const mG = ((m % 1440) + 1440) % 1440;
            timeRangeEl.value = mG;
            const hRaw = Math.floor(mG/60), mins = Math.floor(mG%60), secs = Math.round((mG*60)%60);
            clockEl.textContent = `${hRaw.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;

            requestAnimationFrame(loop);

            // 성능 모드 시 무거운 그래픽 연산 스로틀링 (30프레임당 1회)
            if (isPerfMode) {
                if (isCatchingUp || (!autoCheckEl.checked&&Math.abs(currentSpeed)>2)) {
                    if (frameCounter % 2 !== 0) return;
                } else {
                    if (frameCounter % 30 !== 0) return;
                }
            }
            updateSky(m);
        }
        requestAnimationFrame(loop);

        /* ----------------------------------------------------
           1. 인공위성 / 스타링크 기능
           ---------------------------------------------------- */
        const satLayer = document.getElementById('satLayer');

        function animateObject(isStarlink = false) {
            const solar = getSunTimes(new Date());
            const mG = (manualMinutes % 1440 + 1440) % 1440;
            let tempSunAlt = -1;
            if (mG >= solar.sunrise && mG <= solar.sunset) {
                const prog = (mG - solar.sunrise) / (solar.sunset - solar.sunrise);
                tempSunAlt = Math.sin(prog * Math.PI);
            }
            if (tempSunAlt > 0.05) return; 

            const side = Math.floor(Math.random() * 4);
            let sx, sy, ex, ey;
            if(side === 0) { sx = -15; sy = Math.random()*100; ex = 115; ey = Math.random()*100; }
            else if(side === 1) { sx = 115; sy = Math.random()*100; ex = -15; ey = Math.random()*100; }
            else if(side === 2) { sx = Math.random()*100; sy = -15; ex = Math.random()*100; ey = 115; }
            else { sx = Math.random()*100; sy = 115; ex = Math.random()*100; ey = -15; }
            const duration = (Math.random() * 20000 + 40000) / ((autoCheckEl.checked)?1:Math.min(Math.abs(currentSpeed),256));
            
            // 성능 모드 시 객체 수 최적화
            const count = isStarlink ? (isPerfMode ? 8 : 18) : 1;
            
            for (let i = 0; i < count; i++) {
                const delay = isStarlink ? i * (700 + Math.random() * 400) / ((autoCheckEl.checked)?1:Math.min(Math.abs(currentSpeed),256)) : 0; 
                setTimeout(() => {
                    const sat = document.createElement('div'); sat.className = 'satellite';
                    sat.style.opacity = Math.random() * 0.5 + 0.3;
                    satLayer.appendChild(sat);
                    const startT = performance.now();
                    const move = (now) => {
                        const t = (now - startT) / duration;
                        if (t < 1) { sat.style.transform = `translate(${sx + (ex - sx) * t}vw, ${sy + (ey - sy) * t}vh)`; requestAnimationFrame(move); }
                        else { sat.remove(); }
                    };
                    requestAnimationFrame(move);
                }, delay);
            }
        }
        
        setTimeout(() => {
            const satLoop = () => { animateObject(false); setTimeout(satLoop, (Math.random() * 60000 + 40000) / ((autoCheckEl.checked)?1:Math.abs(currentSpeed))); };
            const starlinkLoop = () => { animateObject(true); setTimeout(starlinkLoop, (Math.random() * 120000 + 120000) / ((autoCheckEl.checked)?1:Math.abs(currentSpeed))); };
            satLoop(); starlinkLoop();
        }, 5000);

        /* ----------------------------------------------------
           2. 오디오 비주얼라이저 기능
           ---------------------------------------------------- */
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination);
        gainNode.gain.value = 0.25;
        const links = [
            './crickets.mp3',
            './creepy_tomb.mp3',
            './so_ambient.mp3'
        ];
        let buffers = null;
        (async () => {
            let promises = [];
            for (let e of links) {
                promises.push((async (e) => {
                    try { return audioCtx.decodeAudioData(await (await fetch(e)).arrayBuffer()); } catch(err) { return null; }
                })(e));
            }
            buffers = await Promise.all(promises);
        })();
        let curAudio = -1;
        let curSource = null;
        async function setAudio(newAudio) {
            if (curAudio === newAudio) return;
            if (curAudio !== -1) {
                try {
                    curSource.stop();
                    curSource.disconnect();
                } catch (e) {}
            }
            curAudio = newAudio;
            if (newAudio === -1 || !buffers || !buffers[newAudio]) return;
            try {
                const source = new AudioBufferSourceNode(audioCtx, {buffer: buffers[newAudio], loop: true});
                source.connect(gainNode); source.start();
                curSource = source;
            } catch(e) {}
        }
        Array.from(document.getElementsByClassName('soundToggle')).forEach((e) => {
            e.onchange = function() {
                if(this.checked) {
                    Array.from(document.getElementsByClassName('soundToggle')).forEach((e)=>{e.checked = false});
                    this.checked = true;
                    setAudio(e.value);
                } else setAudio(-1);
            };
        });
        document.getElementById('volumeRange').oninput = (e) => { if(gainNode) gainNode.gain.value = (e.target.value/100)**2; };
        
        const canvas = document.getElementById('vizCanvas'), ctx = canvas.getContext('2d');
        let analyser, dataArray, isVizActive = false, sampleRate = 48000, smoothHeights = [];
        
        document.getElementById('btnViz').onclick = async () => {
            try {
                let stream = null;
                try {
                    stream = await navigator.mediaDevices.getDisplayMedia({ audio: true });
                } catch (e) {
                    alert("오디오 출력을 캡처할 수 없어 기기 마이크를 사용합니다.")
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                const aCtx = new AudioContext(); sampleRate = aCtx.sampleRate;
                const src = aCtx.createMediaStreamSource(stream);
                analyser = aCtx.createAnalyser(); src.connect(analyser);
                analyser.fftSize = 1024; analyser.smoothingTimeConstant = 0.92;
                dataArray = new Uint8Array(analyser.frequencyBinCount); isVizActive = true; drawViz();
            } catch (e) { alert(`Capture failed.\n${e}`); }
        };

        function drawViz() {
            if (!isVizActive) return; requestAnimationFrame(drawViz);
            analyser.getByteFrequencyData(dataArray);
            canvas.width = window.innerWidth; canvas.height = 200; ctx.clearRect(0, 0, canvas.width, canvas.height);
            const bw = canvas.width / 80;
            const minFreq = 80, maxFreq = 14000, nyquist = sampleRate / 2;
            const tColor = getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim();

            for (let i = 0; i < 80; i++) {
                const freq = minFreq * Math.pow(maxFreq / minFreq, i / 79);
                const dIdx = Math.floor((freq / nyquist) * dataArray.length);
                let raw = dataArray[dIdx] || 0;
                let target = (raw / 255) * canvas.height * (0.6 + (i / 80) * 0.5);
                if (!smoothHeights[i]) smoothHeights[i] = 0;
                if (target > smoothHeights[i]) smoothHeights[i] = target; else smoothHeights[i] *= 0.94;
                const h = Math.min(smoothHeights[i], canvas.height * 0.8);
                ctx.fillStyle = tColor.replace('rgb', 'rgba').replace(')', `, ${Math.max(0.08, raw/255 * 0.4)})`);
                ctx.fillRect(i * bw, canvas.height - h, bw - 1, h);
            }
        }


        // =========================
        // 5. YPT Local Study Timer (offline, localStorage only)
        // =========================
        // 설계 목표:
        // - Date.now 기반으로 오차 최소화(탭 비활성/전환에도 누적 정확)
        // - 자정(로컬) 기준 날짜 자동 분리
        // - 날짜 -> 과목 -> 시간(ms) 구조 유지
        // - 기능별 모듈 분리 + 전역 상태(AppState)로 관리
        // - 네트워크/서버/계정 기능 없음

        const YPT_STORE_KEY_V2 = 'ypt_local_v2';
        const LEGACY_STORE_KEY_V1 = 'studyTracker_v1';

        // ---------- DOM ----------
        const ui = {
            // HUD
            studyHud: document.getElementById('studyHud'),
            studyTime: document.getElementById('studyTime'),
            goalBarFill: document.getElementById('goalBarFill'),
            modeTotalBtn: document.getElementById('modeTotalBtn'),
            modeSubjectBtn: document.getElementById('modeSubjectBtn'),
            subjectSelect: document.getElementById('subjectSelect'),
            subjectChips: document.getElementById('subjectChips'),
            addSubjectBtn: document.getElementById('addSubjectBtn'),
            toggleBtn: document.getElementById('studyToggleBtn'),
            toggleText: document.getElementById('studyToggleText'),
            toggleIcon: document.getElementById('studyToggleIcon'),
            openPanelBtn: document.getElementById('openStatsBtn'),

            // Subject Modal
            subjectModal: document.getElementById('subjectModal'),
            subjectModalTitle: document.getElementById('subjectModalTitle'),
            subjectModalDesc: document.getElementById('subjectModalDesc'),
            subjectNameInput: document.getElementById('subjectNameInput'),
            colorDots: document.getElementById('colorDots'),
            subjectColorInput: document.getElementById('subjectColorInput'),
            subjectCancelBtn: document.getElementById('subjectCancelBtn'),
            subjectSaveBtn: document.getElementById('subjectSaveBtn'),
            subjectDeleteBtn: document.getElementById('subjectDeleteBtn'),

            // Panel
            panelSheet: document.getElementById('panelSheet'),
            panelTitle: document.getElementById('panelTitle'),
            panelSubtitle: document.getElementById('panelSubtitle'),
            panelScroll: document.getElementById('panelScroll'),
            closePanelBtn: document.getElementById('closePanelBtn'),
            tabBtnStats: document.getElementById('tabBtnStats'),
            tabBtnCalendar: document.getElementById('tabBtnCalendar'),
            tabBtnSubjects: document.getElementById('tabBtnSubjects'),
            tabBtnGoal: document.getElementById('tabBtnGoal'),
            tabStats: document.getElementById('tabStats'),
            tabCalendar: document.getElementById('tabCalendar'),
            tabSubjects: document.getElementById('tabSubjects'),
            tabGoal: document.getElementById('tabGoal'),

            // Stats
            kpiToday: document.getElementById('kpiToday'),
            kpiTodaySub: document.getElementById('kpiTodaySub'),
            kpiWeek: document.getElementById('kpiWeek'),
            kpiWeekSub: document.getElementById('kpiWeekSub'),
            kpiMonth: document.getElementById('kpiMonth'),
            kpiMonthSub: document.getElementById('kpiMonthSub'),
            periodTodayBtn: document.getElementById('periodTodayBtn'),
            periodWeekBtn: document.getElementById('periodWeekBtn'),
            periodMonthBtn: document.getElementById('periodMonthBtn'),
            breakdownList: document.getElementById('breakdownList'),
            weekdayBars: document.getElementById('weekdayBars'),
            focusInfo: document.getElementById('focusInfo'),
            exportBtn: document.getElementById('exportBtn'),
            resetTodayBtn: document.getElementById('resetTodayBtn'),
            resetAllBtn: document.getElementById('resetAllBtn'),

            // Calendar
            calPrevBtn: document.getElementById('calPrevBtn'),
            calNextBtn: document.getElementById('calNextBtn'),
            calTitle: document.getElementById('calTitle'),
            calDow: document.getElementById('calDow'),
            calGrid: document.getElementById('calGrid'),

            // Subjects panel
            addSubjectBtn2: document.getElementById('addSubjectBtn2'),
            subjectsManageList: document.getElementById('subjectsManageList'),

            // Goal
            goalNow: document.getElementById('goalNow'),
            goalHours: document.getElementById('goalHours'),
            goalMinutes: document.getElementById('goalMinutes'),
            goalResetBtn: document.getElementById('goalResetBtn'),
            goalSaveBtn: document.getElementById('goalSaveBtn'),
            goalProgressText: document.getElementById('goalProgressText'),
            goalProgressBar: document.getElementById('goalProgressBar'),

            // Day detail
            dayDetailModal: document.getElementById('dayDetailModal'),
            dayDetailTitle: document.getElementById('dayDetailTitle'),
            dayDetailSub: document.getElementById('dayDetailSub'),
            dayDetailList: document.getElementById('dayDetailList'),
            dayDetailCloseBtn: document.getElementById('dayDetailCloseBtn'),

            // Confirm
            confirmModal: document.getElementById('confirmModal'),
            confirmTitle: document.getElementById('confirmTitle'),
            confirmText: document.getElementById('confirmText'),
            confirmCancelBtn: document.getElementById('confirmCancelBtn'),
            confirmOkBtn: document.getElementById('confirmOkBtn'),
        };

        // ---------- Utils ----------
        const pad2 = (n) => String(n).padStart(2, '0');
        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const escapeHtml = (str) => String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');

        function fmtHMS(ms) {
            const sec = Math.max(0, Math.floor(ms / 1000));
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
        }

        function dateKeyLocal(ts) {
            const d = new Date(ts);
            return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        }

        function startOfDayLocal(ts) {
            const d = new Date(ts);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function startOfMonthLocal(ts) {
            const d = new Date(ts);
            d.setDate(1);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function endOfDayLocal(ts) {
            return startOfDayLocal(ts) + 24 * 60 * 60 * 1000;
        }

        function startOfWeekLocal(ts) {
            // 월요일 시작(한국에서 일반적)
            const d = new Date(ts);
            const day = d.getDay(); // 0=Sun
            const diff = (day === 0 ? -6 : 1 - day); // Monday
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function daysInMonthLocal(ts) {
            const d = new Date(ts);
            return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        }

        function uid(prefix='id') {
            return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
        }

        function should_dismiss_dialog(el, e) {
            if (e.target !== el) return false;
            const rect = el.getBoundingClientRect();
            const clickedInDialog = rect.top <= event.clientY &&
            event.clientY <= rect.top + rect.height &&
            rect.left <= event.clientX &&
            event.clientX <= rect.left + rect.width;
            if (clickedInDialog) return false;
            return true;
        }

        // ---------- Storage ----------
        const Storage = (() => {
            const defaultStore = () => ({
                version: 2,
                subjects: [
                    // 기본 과목은 강제하지 않음 (사용자가 +로 추가)
                ],
                settings: {
                    dailyGoalMs: 2 * 60 * 60 * 1000, // 2h default
                    lastSubjectId: '',
                    viewMode: 'total',  // 'total' | 'subject'
                    panelTab: 'stats',  // 'stats' | 'calendar' | 'subjects' | 'goal'
                    statsPeriod: 'today', // 'today' | 'week' | 'month'
                    calendarMonthTs: startOfMonthLocal(Date.now()),
                },
                days: {
                    // "YYYY-MM-DD": { totalMs, subjects: {id: ms}, sessions: [{start,end,subjectId}], longestFocusMs }
                },
                meta: {
                    bestFocusMs: 0,
                }
            });

            function loadRaw(key) {
                try {
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : null;
                } catch { return null; }
            }

            function save(store) {
                localStorage.setItem(YPT_STORE_KEY_V2, JSON.stringify(store));
            }

            function migrateLegacyIfNeeded() {
                const existing = loadRaw(YPT_STORE_KEY_V2);
                if (existing) return existing;

                const legacy = loadRaw(LEGACY_STORE_KEY_V1);
                if (!legacy) return null;

                // legacy schema:
                // { subjects:[{id,name}], days:{[date]:{totalSeconds, unclassifiedSeconds, subjectSeconds}}, meta:{mode, selectedSubjectId} }
                const st = defaultStore();
                try {
                    const colorPresets = ['#90caf9','#a5d6a7','#f48fb1','#ffcc80','#ce93d8','#80cbc4','#fff59d','#b0bec5'];
                    st.subjects = (legacy.subjects || []).map((s, i) => ({
                        id: s.id || uid('s'),
                        name: s.name || '과목',
                        color: colorPresets[i % colorPresets.length],
                        createdAt: Date.now(),
                    }));
                    st.settings.viewMode = legacy.meta?.mode === 'subject' ? 'subject' : 'total';
                    st.settings.lastSubjectId = legacy.meta?.selectedSubjectId || '';
                    const days = legacy.days || {};
                    for (const dk of Object.keys(days)) {
                        const d = days[dk] || {};
                        const subjects = {};
                        for (const sid of Object.keys(d.subjectSeconds || {})) {
                            subjects[sid] = Math.round((d.subjectSeconds[sid] || 0) * 1000);
                        }
                        st.days[dk] = {
                            totalMs: Math.round((d.totalSeconds || 0) * 1000),
                            subjects,
                            sessions: [],
                            longestFocusMs: 0,
                        };
                    }
                    save(st);
                    return st;
                } catch {
                    return null;
                }
            }

            function normalize(store) {
                const base = defaultStore();
                if (!store || typeof store !== 'object') return base;
                if (store.version !== 2) {
                    // 미래 버전 대비: 최소 필드만 보정
                    store.version = 2;
                }
                store.subjects = Array.isArray(store.subjects) ? store.subjects : [];
                store.settings = { ...base.settings, ...(store.settings || {}) };
                store.days = store.days && typeof store.days === 'object' ? store.days : {};
                store.meta = { ...base.meta, ...(store.meta || {}) };

                // ensure subject structure
                store.subjects = store.subjects.map(s => ({
                    id: s.id || uid('s'),
                    name: (s.name || '과목').slice(0, 24),
                    color: s.color || '#90caf9',
                    createdAt: s.createdAt || Date.now(),
                }));

                // ensure day structure
                for (const dk of Object.keys(store.days)) {
                    const d = store.days[dk];
                    if (!d || typeof d !== 'object') continue;
                    if (typeof d.totalMs !== 'number') d.totalMs = 0;
                    if (!d.subjects || typeof d.subjects !== 'object') d.subjects = {};
                    if (!Array.isArray(d.sessions)) d.sessions = [];
                    if (typeof d.longestFocusMs !== 'number') d.longestFocusMs = 0;
                }

                return store;
            }

            function load() {
                const migrated = migrateLegacyIfNeeded();
                if (migrated) return normalize(migrated);
                const raw = loadRaw(YPT_STORE_KEY_V2);
                return normalize(raw || defaultStore());
            }

            return { load, save, defaultStore };
        })();

        // ---------- Global App State ----------
        const App = {
            store: Storage.load(),
            runtime: {
                running: false,
                lastTs: 0,           // 마지막 tick 기준
                activeSubjectId: '', // 현재 선택 과목(빈 문자열 = 미분류)
                sessionStartTs: 0,   // 현재 세션 시작(과목 세그먼트 단위)
                sessionSubjectId: '',
                focusStartTs: 0,     // "최장 집중"용: 실행 시작 시각(중단까지)
                rafId: 0,
                lastUiTs: 0,
                lastSaveTs: 0,
                pendingPanelTab: null,
            }
        };

        // ---------- Data helpers ----------
        function ensureDay(dk) {
            if (!App.store.days[dk]) {
                App.store.days[dk] = { totalMs: 0, subjects: {}, sessions: [], longestFocusMs: 0 };
            }
            return App.store.days[dk];
        }

        function subjectById(id) {
            return App.store.subjects.find(s => s.id === id) || null;
        }

        function subjectName(id) {
            if (!id) return '미분류';
            const s = subjectById(id);
            return s ? s.name : '삭제된 과목';
        }

        function subjectColor(id) {
            if (!id) return 'rgba(255,255,255,0.28)';
            const s = subjectById(id);
            return s ? s.color : 'rgba(255,255,255,0.28)';
        }

        function allTimeSubjectTotalMs(subjectId) {
            let sum = 0;
            for (const dk of Object.keys(App.store.days)) {
                const d = App.store.days[dk];
                sum += (d.subjects?.[subjectId] || 0);
            }
            return sum;
        }
        //중요중요
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzh4V2v2v4mzSkQQkf49FrRjRb3pCsnx4I0T4QBgC4CA8YA9JaRJmgOYee9Tq6hCrq-/exec";

        async function sendDataToSheet(targetDate) {
            const dateKey = dateKeyLocal(targetDate);
            const dayData = App.store.days[dateKey];
            
            // 데이터가 없거나 이미 보냈다면 중단
            if (!dayData || dayData.totalMs <= 0) return;

            const payload = {
                date: dateKey,
                userName: "사용자1", // 나중에 로그인 기능이 생기면 변수로 대체
                totalMs: dayData.totalMs,
                formattedTime: fmtHMS(dayData.totalMs)
            };

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                if(response.ok) {
                    console.log(`${dateKey} 데이터 전송 성공`);
                    // 전송 성공 시 마킹 (중복 전송 방지용)
                    localStorage.setItem('last_synced_date', dateKey);
                }
            } catch (e) {
                console.error("전송 실패:", e);
            }
        }

        // 자정 체크 및 자동 전송 실행기
        function initAutoSync() {
            // 1. 페이지 접속 시 체크: 어제 기록을 아직 안 보냈다면 전송
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = dateKeyLocal(yesterday.getTime());
            
            if (localStorage.getItem('last_synced_date') !== yesterdayKey) {
                sendDataToSheet(yesterday.getTime());
            }

            // 2. 실시간 자정 체크 (1분마다 확인)
            setInterval(() => {
                const now = new Date();
                // 00시 00분대에 진입하면 실행
                if (now.getHours() === 0 && now.getMinutes() === 50) {
                    const yesterdayTs = Date.now() - 60000; // 1분 전(어제) 날짜
                    sendDataToSheet(yesterdayTs);
                }
            }, 60000);
        }
        initAutoSync();

        // ---------- Time allocation (handles midnight split) ----------
        function addTimeRange(startTs, endTs, subjectId) {
            // startTs < endTs
            let t0 = startTs;
            while (t0 < endTs) {
                const dk = dateKeyLocal(t0);
                const dayEnd = endOfDayLocal(t0);
                const t1 = Math.min(endTs, dayEnd);
                const ms = t1 - t0;

                const day = ensureDay(dk);
                day.totalMs += ms;
                if (!day.subjects[subjectId]) day.subjects[subjectId] = 0;
                day.subjects[subjectId] += ms;

                t0 = t1;
            }
        }

        function addSessionRange(startTs, endTs, subjectId) {
            let t0 = startTs;
            while (t0 < endTs) {
                const dk = dateKeyLocal(t0);
                const dayEnd = endOfDayLocal(t0);
                const t1 = Math.min(endTs, dayEnd);
                const day = ensureDay(dk);
                day.sessions.push({ start: t0, end: t1, subjectId });
                t0 = t1;
            }
        }

        function finalizeCurrentSession(endTs) {
            const rt = App.runtime;
            if (!rt.sessionStartTs) return;
            const s = rt.sessionStartTs;
            const sid = rt.sessionSubjectId || '';
            if (endTs > s) addSessionRange(s, endTs, sid);
            rt.sessionStartTs = 0;
            rt.sessionSubjectId = '';
        }

        function commitDelta(nowTs) {
            const rt = App.runtime;
            if (!rt.running || !rt.lastTs) return;
            if (nowTs <= rt.lastTs) return;

            const sid = rt.activeSubjectId || '';
            addTimeRange(rt.lastTs, nowTs, sid);
            rt.lastTs = nowTs;
        }

        function handleMidnightIfNeeded(nowTs) {
            const rt = App.runtime;
            if (!rt.running || !rt.sessionStartTs) return;
            const startKey = dateKeyLocal(rt.sessionStartTs);
            const nowKey = dateKeyLocal(nowTs);
            if (startKey === nowKey) return;

            const sid = rt.sessionSubjectId || '';
            finalizeCurrentSession(nowTs);
            rt.sessionStartTs = nowTs;
            rt.sessionSubjectId = sid;
        }

        function setRunningUI(running) {
            if (running) {
                ui.toggleBtn.classList.add('running');
                ui.toggleText.textContent = 'PAUSE';
                ui.toggleIcon.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M7 5H10V19H7V5Z" fill="var(--text-main)" style="transition: fill 0.5s;"/>
                        <path d="M14 5H17V19H14V5Z" fill="var(--text-main)" style="transition: fill 0.5s;"/>
                    </svg>`;
            } else {
                ui.toggleBtn.classList.remove('running');
                ui.toggleText.textContent = 'START';
                ui.toggleIcon.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M8 5V19L19 12L8 5Z" fill="var(--text-main)" style="transition: fill 0.5s;"/>
                    </svg>`;
            }
        }

        function startTimer() {
            const rt = App.runtime;
            if (rt.running) return;

            const nowTs = Date.now();
            rt.running = true;
            rt.lastTs = nowTs;

            rt.focusStartTs = nowTs;

            rt.sessionStartTs = nowTs;
            rt.sessionSubjectId = rt.activeSubjectId || '';

            setRunningUI(true);
            scheduleTick();
        }

        function pauseTimer() {
            const rt = App.runtime;
            if (!rt.running) return;

            const nowTs = Date.now();
            commitDelta(nowTs);
            handleMidnightIfNeeded(nowTs);
            finalizeCurrentSession(nowTs);

            if (rt.focusStartTs) {
                const focusMs = nowTs - rt.focusStartTs;
                const dk = dateKeyLocal(nowTs);
                const day = ensureDay(dk);
                day.longestFocusMs = Math.max(day.longestFocusMs || 0, focusMs);
                App.store.meta.bestFocusMs = Math.max(App.store.meta.bestFocusMs || 0, focusMs);
            }

            rt.running = false;
            rt.lastTs = 0;
            rt.focusStartTs = 0;

            setRunningUI(false);
            Storage.save(App.store);
            renderAll();
        }

        function toggleTimer() {
            if (App.runtime.running) pauseTimer();
            else startTimer();
        }

        // ---------- Subject switching ----------
        function setActiveSubject(subjectId) {
            const rt = App.runtime;
            const id = subjectId || '';
            const prev = rt.activeSubjectId || '';
            if (prev === id) return;

            const nowTs = Date.now();

            // running이면 현재까지 시간 확정 + 세션 분리
            if (rt.running) {
                commitDelta(nowTs);
                handleMidnightIfNeeded(nowTs);
                finalizeCurrentSession(nowTs);

                rt.activeSubjectId = id;

                // 새 세션 시작(끊김 없이)
                rt.sessionStartTs = nowTs;
                rt.sessionSubjectId = id;
                rt.lastTs = nowTs;
            } else {
                rt.activeSubjectId = id;
            }

            App.store.settings.lastSubjectId = id;
            Storage.save(App.store);
            renderSubjectsUI();
            renderHUD();
            // mode subject일 때 표시 즉시 반영
            if (App.store.settings.viewMode === 'subject') renderHUD();
        }

        // ---------- UI: Subjects ----------
        const COLOR_PRESETS = [
            '#90caf9', '#a5d6a7', '#f48fb1', '#ffcc80',
            '#ce93d8', '#80cbc4', '#fff59d', '#b0bec5'
        ];

        let subjectModalMode = 'add'; // 'add' | 'edit'
        let subjectModalTargetId = '';

        function openSubjectModal(mode='add', subjectId='') {
            subjectModalMode = mode;
            subjectModalTargetId = subjectId || '';

            ui.subjectModal.showModal();

            // build color dots
            ui.colorDots.innerHTML = '';
            COLOR_PRESETS.forEach(c => {
                const dot = document.createElement('button');
                dot.type = 'button';
                dot.className = 'cdot';
                dot.style.background = c;
                dot.addEventListener('click', () => {
                    ui.subjectColorInput.value = c;
                    syncColorDotActive();
                });
                ui.colorDots.appendChild(dot);
            });

            if (mode === 'add') {
                ui.subjectModalTitle.textContent = '과목 추가';
                ui.subjectModalDesc.textContent = '과목명과 색상을 정하면 과목별 누적 시간이 자동 기록됩니다.';
                ui.subjectNameInput.value = '';
                ui.subjectColorInput.value = '#90caf9';
                ui.subjectDeleteBtn.style.display = 'none';
            } else {
                const s = subjectById(subjectId);
                ui.subjectModalTitle.textContent = '과목 수정';
                ui.subjectModalDesc.textContent = '이름/색상을 바꿔도 누적 기록은 유지됩니다.';
                ui.subjectNameInput.value = s ? s.name : '';
                ui.subjectColorInput.value = s?.color || '#90caf9';
                ui.subjectDeleteBtn.style.display = 'inline-flex';
            }

            syncColorDotActive();
            setTimeout(() => ui.subjectNameInput.focus(), 0);
        }

        function closeSubjectModal() {
            ui.subjectModal.close();
            subjectModalTargetId = '';
        }

        function syncColorDotActive() {
            const val = (ui.subjectColorInput.value || '').toLowerCase();
            [...ui.colorDots.children].forEach(btn => {
                const bg = (btn.style.background || '').toLowerCase();
                btn.classList.toggle('active', tinycolor.equals(bg, val));
            });
        }

        function upsertSubject() {
            const name = (ui.subjectNameInput.value || '').trim();
            const color = (ui.subjectColorInput.value || '#90caf9').trim();
            if (!name) return;

            // name duplicate check (case-insensitive), except self
            const dup = App.store.subjects.some(s => s.name.toLowerCase() === name.toLowerCase() && s.id !== subjectModalTargetId);
            if (dup) return;

            if (subjectModalMode === 'add') {
                const id = uid('s');
                App.store.subjects.push({ id, name, color, createdAt: Date.now() });
                // auto select
                setActiveSubject(id);
            } else {
                const s = subjectById(subjectModalTargetId);
                if (s) {
                    s.name = name;
                    s.color = color;
                }
            }
            Storage.save(App.store);
            renderAll();
            closeSubjectModal();
        }

        function deleteSubject(subjectId) {
            // 과목 삭제 시: 과목 목록에서만 제거.
            // 과거 기록(subjectId 키)은 남아 있지만 UI에서는 "삭제된 과목"으로 보이게 처리.
            App.store.subjects = App.store.subjects.filter(s => s.id !== subjectId);
            if (App.runtime.activeSubjectId === subjectId) setActiveSubject('');
            if (App.store.settings.lastSubjectId === subjectId) App.store.settings.lastSubjectId = '';
            Storage.save(App.store);
            renderAll();
        }

        // ---------- UI: Panel ----------
        function openPanel(tab=null) {
            if (ui.panelSheet.classList.contains('active')) {
                closePanel(); return;
            }
            ui.panelSheet.classList.add('active');
            setPanelTab(tab || App.store.settings.panelTab || 'stats');
            renderPanel();
        }
        function closePanel() {
            ui.panelSheet.classList.remove('active');
        }

        function set_scroll_mask() {
            const sh = ui.panelScroll.scrollHeight;
            const h = ui.panelScroll.clientHeight;
            const st = ui.panelScroll.scrollTop;
            if (st === 0) ui.panelScroll.style.setProperty('--top-mask', 'black');
            else ui.panelScroll.style.setProperty('--top-mask', 'transparent');
            if (st+h >= sh-1) ui.panelScroll.style.setProperty('--bottom-mask', 'black');
            else ui.panelScroll.style.setProperty('--bottom-mask', 'transparent');
        }
        ui.panelScroll.onscroll = set_scroll_mask;

        function setPanelTab(tab) {
            const t = tab || 'stats';
            App.store.settings.panelTab = t;
            Storage.save(App.store);

            const tabs = [
                { key: 'stats', btn: ui.tabBtnStats, el: ui.tabStats, title: '통계' },
                { key: 'calendar', btn: ui.tabBtnCalendar, el: ui.tabCalendar, title: '캘린더' },
                { key: 'subjects', btn: ui.tabBtnSubjects, el: ui.tabSubjects, title: '과목' },
                { key: 'goal', btn: ui.tabBtnGoal, el: ui.tabGoal, title: '목표' },
            ];
            tabs.forEach(x => {
                x.btn.classList.toggle('active', x.key === t);
                x.el.classList.toggle('active', x.key === t);
            });
            const cur = tabs.find(x => x.key === t);
            ui.panelTitle.textContent = cur ? cur.title : '통계';
            set_scroll_mask();
            renderPanel();
        }

        // ---------- Confirm modal ----------
        let confirmResolve = null;
        function confirmDialog(title, text) {
            ui.confirmTitle.textContent = title || '확인';
            ui.confirmText.textContent = text || '';
            ui.confirmModal.showModal();
            return new Promise((resolve) => { confirmResolve = resolve; });
        }
        function closeConfirm(result=false) {
            ui.confirmModal.close();
            if (confirmResolve) confirmResolve(result);
            confirmResolve = null;
        }

        // ---------- Stats computations ----------
        function getTodayKey() { return dateKeyLocal(Date.now()); }

        function getDayTotalMs(dk) {
            const d = App.store.days[dk];
            return d ? (d.totalMs || 0) : 0;
        }

        function aggregatePeriod(period) {
            const now = Date.now();
            let keys = [];
            let label = '';

            if (period === 'today') {
                const dk = getTodayKey();
                keys = [dk];
                label = dk;
            } else if (period === 'week') {
                const ws = startOfWeekLocal(now);
                keys = Array.from({length:7}, (_,i)=> dateKeyLocal(ws + i*86400000));
                label = `${keys[0]} ~ ${keys[6]}`;
            } else { // month
                const ms = startOfMonthLocal(now);
                const dim = daysInMonthLocal(now);
                keys = Array.from({length:dim}, (_,i)=> dateKeyLocal(ms + i*86400000));
                const d = new Date(ms);
                label = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
            }

            const perSubject = {}; // id -> ms
            let total = 0;
            let studiedDays = 0;
            let longest = 0;

            keys.forEach(dk => {
                const day = App.store.days[dk];
                const t = day?.totalMs || 0;
                total += t;
                if (t > 0) studiedDays += 1;
                longest = Math.max(longest, day?.longestFocusMs || 0);
                if (day?.subjects) {
                    for (const [sid, ms] of Object.entries(day.subjects)) {
                        perSubject[sid] = (perSubject[sid] || 0) + (ms || 0);
                    }
                }
            });

            const daysCount = keys.length;
            const avgAll = total / Math.max(1, daysCount);

            return { period, label, keys, totalMs: total, perSubject, longestFocusMs: longest, avgAllMs: avgAll, studiedDays };
        }

        function renderWeekdayBars() {
            // console.log("renderWeekdayBars");

            const ws = startOfWeekLocal(Date.now());
            const labels = ['월','화','수','목','금','토','일'];
            const totals = Array.from({length:7}, (_,i)=> getDayTotalMs(dateKeyLocal(ws + i*86400000)));
            const max = Math.max(1, ...totals);

            ui.weekdayBars.innerHTML = '';
            labels.forEach((lab, i) => {
                const v = totals[i];
                const pct = Math.round((v / max) * 100);
                const wrap = document.createElement('div');
                wrap.className = 'week-bar' + (v <= 0 ? ' zero' : '');
                wrap.innerHTML = `
                    <div class="barcol"><div style="height:${pct}%"></div></div>
                    <div class="wlabel">${lab}</div>
                `;
                ui.weekdayBars.appendChild(wrap);
            });
        }

        function renderBreakdown(periodAgg) {
            // console.log("renderBreakdown");

            const total = periodAgg.totalMs || 0;
            const entries = [];

            // subjects from current list first
            App.store.subjects.forEach(s => {
                const ms = periodAgg.perSubject[s.id] || 0;
                entries.push({ id: s.id, name: s.name, ms, color: s.color, exists: true });
            });

            // include deleted subjects that still have time
            for (const sid of Object.keys(periodAgg.perSubject)) {
                if (sid === '') continue;
                if (!App.store.subjects.some(s => s.id === sid)) {
                    const ms = periodAgg.perSubject[sid] || 0;
                    if (ms > 0) entries.push({ id: sid, name: '삭제된 과목', ms, color: 'rgba(255,255,255,0.25)', exists: false });
                }
            }

            // unclassified
            const un = periodAgg.perSubject[''] || 0;
            if (un > 0) entries.push({ id: '', name: '미분류', ms: un, color: 'rgba(255,255,255,0.22)', exists: true });

            // sort
            entries.sort((a,b)=> b.ms - a.ms);

            ui.breakdownList.innerHTML = '';
            if (entries.every(e => e.ms <= 0)) {
                const empty = document.createElement('div');
                empty.className = 'item';
                empty.innerHTML = `<div class="item-row"><div class="item-name">기록이 없어요</div><div class="item-time">00:00:00</div></div>`;
                ui.breakdownList.appendChild(empty);
                return;
            }

            entries.forEach(e => {
                if (e.ms <= 0) return;
                const pct = total > 0 ? Math.min(100, (e.ms / total) * 100) : 0;
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <div class="item-row">
                        <div class="item-name" title="${escapeHtml(e.name)}">
                            <span style="display:inline-flex; align-items:center; gap:8px; min-width:0;">
                                <span class="swatch" style="width:10px;height:10px; background:${e.color};"></span>
                                <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px;">${escapeHtml(e.name)}</span>
                            </span>
                        </div>
                        <div class="item-time">${fmtHMS(e.ms)}</div>
                    </div>
                    <div class="bar"><div style="width:${pct.toFixed(1)}%; background:${e.color};"></div></div>
                `;
                ui.breakdownList.appendChild(item);
            });
        }

        function renderKPIs() {
            // console.log("renderKPIs");

            const todayAgg = aggregatePeriod('today');
            const weekAgg = aggregatePeriod('week');
            const monthAgg = aggregatePeriod('month');

            const goal = App.store.settings.dailyGoalMs || 0;
            ui.kpiToday.textContent = fmtHMS(todayAgg.totalMs);
            ui.kpiTodaySub.textContent = goal > 0
                ? `목표 ${fmtHMS(goal)} · ${Math.min(100, Math.floor((todayAgg.totalMs/goal)*100))}%`
                : '목표 없음';

            ui.kpiWeek.textContent = fmtHMS(weekAgg.totalMs);
            ui.kpiWeekSub.textContent = `평균 ${fmtHMS(weekAgg.avgAllMs)}`;

            ui.kpiMonth.textContent = fmtHMS(monthAgg.totalMs);
            ui.kpiMonthSub.textContent = `평균 ${fmtHMS(monthAgg.avgAllMs)}`;

            // focus info (overall best, and this week best)
            const bestAll = App.store.meta.bestFocusMs || 0;
            const bestWeek = weekAgg.longestFocusMs || 0;
            ui.focusInfo.textContent = `최장 집중 ${fmtHMS(Math.max(bestWeek, bestAll))}`;
        }

        function setStatsPeriod(period) {
            App.store.settings.statsPeriod = period;
            Storage.save(App.store);
            // UI button states
            ui.periodTodayBtn.classList.toggle('active', period === 'today');
            ui.periodWeekBtn.classList.toggle('active', period === 'week');
            ui.periodMonthBtn.classList.toggle('active', period === 'month');
            renderPanel();
        }

        // ---------- Calendar ----------
        function renderCalendar() {
            // console.log("renderCalendar");

            // dow header once
            if (!ui.calDow.dataset.built) {
                const dows = ['M','T','W','T','F','S','S'];
                ui.calDow.innerHTML = '';
                dows.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'cal-dow';
                    el.textContent = d;
                    ui.calDow.appendChild(el);
                });
                ui.calDow.dataset.built = '1';
            }

            const monthTs = App.store.settings.calendarMonthTs || startOfMonthLocal(Date.now());
            const d = new Date(monthTs);
            const year = d.getFullYear();
            const month = d.getMonth(); // 0-based
            ui.calTitle.textContent = `${year}-${pad2(month+1)}`;

            const first = new Date(year, month, 1);
            const firstDow = first.getDay(); // 0 Sun
            const offset = (firstDow === 0 ? 6 : firstDow - 1); // Monday=0
            const dim = new Date(year, month+1, 0).getDate();

            // grid cells
            ui.calGrid.innerHTML = '';
            const totalCells = Math.ceil((offset + dim) / 7) * 7;

            const todayKey = getTodayKey();

            for (let i = 0; i < totalCells; i++) {
                const dayNum = i - offset + 1;
                if (dayNum < 1 || dayNum > dim) {
                    const blank = document.createElement('div');
                    blank.style.opacity = '0';
                    ui.calGrid.appendChild(blank);
                    continue;
                }

                const cellDate = new Date(year, month, dayNum);
                cellDate.setHours(0,0,0,0);
                const dk = dateKeyLocal(cellDate.getTime());
                const total = getDayTotalMs(dk);

                const cell = document.createElement('button');
                cell.type = 'button';
                cell.className = 'cal-day' + (total <= 0 ? ' off' : '') + (dk === todayKey ? ' today' : '');
                cell.innerHTML = `
                    <div class="dnum">${dayNum}</div>
                    <div class="dtime">${total > 0 ? fmtHMS(total) : ''}</div>
                `;
                if (total > 0 || dk === todayKey) {
                    cell.addEventListener('click', () => openDayDetail(dk));
                } else {
                    // off day: do nothing
                }
                ui.calGrid.appendChild(cell);
            }
        }

        function openDayDetail(dk) {
            const day = ensureDay(dk);
            ui.dayDetailTitle.textContent = dk;
            ui.dayDetailSub.textContent = `총 ${fmtHMS(day.totalMs || 0)}`;

            // subject breakdown
            const entries = [];
            for (const [sid, ms] of Object.entries(day.subjects || {})) {
                if (!ms) continue;
                entries.push({ sid, ms });
            }
            entries.sort((a,b)=> b.ms - a.ms);

            ui.dayDetailList.innerHTML = '';
            if (entries.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'item';
                empty.innerHTML = `<div class="item-row"><div class="item-name">기록 없음</div><div class="item-time">00:00:00</div></div>`;
                ui.dayDetailList.appendChild(empty);
            } else {
                const total = Math.max(1, day.totalMs || 0);
                entries.forEach(e => {
                    const pct = Math.min(100, (e.ms / total) * 100);
                    const item = document.createElement('div');
                    item.className = 'item';
                    item.innerHTML = `
                        <div class="item-row">
                            <div class="item-name" title="${escapeHtml(subjectName(e.sid))}">
                                <span style="display:inline-flex; align-items:center; gap:8px; min-width:0;">
                                    <span class="swatch" style="width:10px;height:10px; background:${subjectColor(e.sid)};"></span>
                                    <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:240px;">${escapeHtml(subjectName(e.sid))}</span>
                                </span>
                            </div>
                            <div class="item-time">${fmtHMS(e.ms)}</div>
                        </div>
                        <div class="bar"><div style="width:${pct.toFixed(1)}%; background:${subjectColor(e.sid)};"></div></div>
                    `;
                    ui.dayDetailList.appendChild(item);
                });
            }

            ui.dayDetailModal.showModal();
        }

        function closeDayDetail() {
            ui.dayDetailModal.close();
        }

        // ---------- Subjects management panel ----------
        function renderSubjectsManageList() {
            // console.log("renderSubjectsManageList");

            ui.subjectsManageList.innerHTML = '';
            if (App.store.subjects.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'item';
                empty.innerHTML = `<div class="item-row"><div class="item-name">과목이 없어요</div><div class="item-time">+</div></div>`;
                ui.subjectsManageList.appendChild(empty);
                return;
            }

            App.store.subjects
                .slice()
                .sort((a,b)=> (a.createdAt||0) - (b.createdAt||0))
                .forEach(s => {
                    const total = allTimeSubjectTotalMs(s.id);
                    const row = document.createElement('div');
                    row.className = 'msub';
                    row.innerHTML = `
                        <div class="item-row">
                            <span class="swatch" style="background:${s.color}"></span>
                            <div class="msub-name" title="${escapeHtml(s.name)}">${escapeHtml(s.name)}</div>
                        </div>
                        <div class="item-row">
                            <div class="msub-time">${fmtHMS(total)}</div>
                            <button class="icon-btn" aria-label="Edit" style="width:34px;height:34px;border-radius:14px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <path d="M4 20H8L18.5 9.5C19.3 8.7 19.3 7.4 18.5 6.6L17.4 5.5C16.6 4.7 15.3 4.7 14.5 5.5L4 16V20Z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    const editBtn = row.querySelector('button[aria-label="Edit"]');
                    editBtn.addEventListener('click', () => openSubjectModal('edit', s.id));
                    ui.subjectsManageList.appendChild(row);
                });
        }

        // ---------- HUD rendering ----------
        function renderSubjectsUI() {
            // console.log("renderSubjectsUI");

            // select options
            ui.subjectSelect.innerHTML = '<option value="">미분류</option>';
            App.store.subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                ui.subjectSelect.appendChild(opt);
            });

            // selection
            const sid = App.runtime.activeSubjectId || '';
            ui.subjectSelect.value = sid;

            // chips
            ui.subjectChips.innerHTML = '';
            // 미분류 chip
            const unc = document.createElement('button');
            unc.type = 'button';
            unc.className = 'chip' + (sid === '' ? ' active' : '');
            unc.innerHTML = `<span class="dot" style="background: rgba(255,255,255,0.22)"></span><span>미분류</span>`;
            unc.addEventListener('click', () => {
                setActiveSubject('');
                if (!App.runtime.running) startTimer();
            });
            ui.subjectChips.appendChild(unc);

            App.store.subjects.forEach(s => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'chip' + (s.id === sid ? ' active' : '');
                chip.innerHTML = `<span class="dot" style="background:${s.color}"></span><span>${escapeHtml(s.name)}</span>`;
                chip.addEventListener('click', () => {
                    setActiveSubject(s.id);
                    // 열품타 느낌: 과목 선택 시 바로 측정 시작(정지 상태일 때)
                    if (!App.runtime.running) startTimer();
                });
                ui.subjectChips.appendChild(chip);
            });
            set_scroll_mask_chipbar();

            // mode subject select enable/disable
            const mode = App.store.settings.viewMode || 'total';
            ui.subjectSelect.disabled = (mode !== 'subject');
        }

        function set_scroll_mask_chipbar() {
            const sw = ui.subjectChips.scrollWidth;
            const w = ui.subjectChips.clientWidth;
            const sl = ui.subjectChips.scrollLeft;
            if (sl === 0) ui.subjectChips.style.setProperty('--left-mask', 'black');
            else ui.subjectChips.style.setProperty('--left-mask', 'transparent');
            if (sl+w >= sw-1) ui.subjectChips.style.setProperty('--right-mask', 'black');
            else ui.subjectChips.style.setProperty('--right-mask', 'transparent');
        }
        ui.subjectChips.onscroll = set_scroll_mask_chipbar;

        function getDisplayedMs() {
            // HUD 표시: total/subject 모드에 따라 "오늘" 기준
            const nowTs = Date.now();
            const todayKey = dateKeyLocal(nowTs);
            const day = ensureDay(todayKey);

            let baseMsTotal = day.totalMs || 0;
            let baseMsSubject = (day.subjects?.[App.runtime.activeSubjectId || ''] || 0);

            // 아직 commit되지 않은 pending(현재 tick 사이) 보정
            if (App.runtime.running && App.runtime.lastTs) {
                const pending = nowTs - App.runtime.lastTs;
                // pending은 현재 과목에 속함
                baseMsTotal += pending;
                baseMsSubject += pending;
            }

            const mode = App.store.settings.viewMode || 'total';
            return mode === 'total' ? baseMsTotal : baseMsSubject;
        }

        function renderGoalProgress() {
            // console.log("renderGoalProgress");

            const nowTs = Date.now();
            const dk = dateKeyLocal(nowTs);
            const day = ensureDay(dk);
            const goal = App.store.settings.dailyGoalMs || 0;
            const totalMs = (day.totalMs || 0) + (App.runtime.running && App.runtime.lastTs ? (nowTs - App.runtime.lastTs) : 0);

            if (goal > 0) {
                const pct = clamp((totalMs / goal) * 100, 0, 100);
                ui.goalBarFill.style.width = `${pct}%`;
                ui.goalProgressBar.style.width = `${pct}%`;
                ui.goalProgressText.textContent = `${Math.floor(pct)}% · ${fmtHMS(totalMs)} / ${fmtHMS(goal)}`;
                ui.kpiTodaySub.textContent = `목표 ${fmtHMS(goal)} · ${Math.min(100, Math.floor((totalMs/goal)*100))}%`;

                if (totalMs >= goal) ui.studyHud.classList.add('goal-hit');
                else ui.studyHud.classList.remove('goal-hit');
            } else {
                ui.goalBarFill.style.width = `0%`;
                ui.goalProgressBar.style.width = `0%`;
                ui.goalProgressText.textContent = '목표 없음';
                ui.studyHud.classList.remove('goal-hit');
            }

            // goal inputs
            ui.goalNow.textContent = goal > 0 ? fmtHMS(goal) : '목표 없음';
        }

        function renderHUD() {
            // console.log("renderHUD");

            ui.studyTime.textContent = fmtHMS(getDisplayedMs());
            renderGoalProgress();
        }

        // ---------- Panel render ----------
        function renderPanel() {
            // console.log("renderPanel");

            const now = Date.now();
            ui.panelSubtitle.textContent = `${getTodayKey()} · 오프라인`;

            // stats period button state
            const _p = App.store.settings.statsPeriod || 'today';
            ui.periodTodayBtn.classList.toggle('active', _p === 'today');
            ui.periodWeekBtn.classList.toggle('active', _p === 'week');
            ui.periodMonthBtn.classList.toggle('active', _p === 'month');

            renderKPIs();

            const agg = aggregatePeriod(App.store.settings.statsPeriod || 'today');
            renderBreakdown(agg);
            renderWeekdayBars();

            renderCalendar();
            renderSubjectsManageList();

            // goal inputs
            const goal = App.store.settings.dailyGoalMs || (2*60*60*1000);
            ui.goalHours.value = Math.floor(goal / 3600000);
            ui.goalMinutes.value = Math.floor((goal % 3600000) / 60000);
            ui.goalNow.textContent = fmtHMS(goal);
        }

        function renderAll() {
            // console.log("renderAll");

            renderSubjectsUI();
            renderHUD();
            renderPanel();
        }

        // ---------- Export / Reset ----------
        function exportJSON() {
            // 저장 구조가 날짜 -> 과목 -> 시간(ms) 이므로, 사용 편의를 위해 "초 단위" 요약도 함께 제공
            const payload = JSON.stringify(App.store, null, 2);
            const filename = `ypt_${getTodayKey()}.json`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(payload)
                    .then(() => {
                        // 최소 알림 (공부 방해 최소)
                        ui.panelSubtitle.textContent = `${getTodayKey()} · JSON 복사됨`;
                    })
                    .catch(() => downloadJSON(payload, filename));
            } else {
                downloadJSON(payload, filename);
            }
        }

        function downloadJSON(payload, filename) {
            const blob = new Blob([payload], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function resetToday() {
            const ok = await confirmDialog('오늘 초기화', '오늘 공부 기록을 초기화할까요? (되돌릴 수 없음)');
            if (!ok) return;
            const dk = getTodayKey();
            App.store.days[dk] = { totalMs: 0, subjects: {}, sessions: [], longestFocusMs: 0 };
            Storage.save(App.store);
            pauseTimer(); // 안전하게 중지
            renderAll();
        }

        async function resetAll() {
            const ok = await confirmDialog('전체 초기화', '모든 공부 기록/과목/설정을 초기화할까요? (되돌릴 수 없음)');
            if (!ok) return;
            App.store = Storage.defaultStore();
            Storage.save(App.store);
            App.runtime.running = false;
            App.runtime.lastTs = 0;
            App.runtime.activeSubjectId = '';
            setRunningUI(false);
            renderAll();
        }

        // ---------- Tick loop (requestAnimationFrame 기반) ----------
        function scheduleTick() {
            if (App.runtime.rafId) return;
            const tick = () => {
                App.runtime.rafId = requestAnimationFrame(tick);

                const nowTs = Date.now();

                if (App.runtime.running) {
                    // 시간 누적
                    // rAF가 느리거나 백그라운드 후 복귀해도 now-lastTs로 정확히 반영
                    commitDelta(nowTs);
                    handleMidnightIfNeeded(nowTs);

                    // save throttling (every ~2s)
                    if (nowTs - (App.runtime.lastSaveTs || 0) > 2000) {
                        App.runtime.lastSaveTs = nowTs;
                        Storage.save(App.store);
                    }
                }

                // UI update throttling (~10fps)
                if (nowTs - (App.runtime.lastUiTs || 0) > 100) {
                    App.runtime.lastUiTs = nowTs;
                    renderHUD();
                    // panel이 열려 있으면 가볍게 갱신(너무 자주 X)
                    if (ui.panelSheet.matches(':popover-open')) {
                        if (nowTs - (App.runtime.lastUiPanelTs || 0) > 500) {
                            App.runtime.lastUiPanelTs = nowTs;
                            renderPanel();
                        }
                    }
                }
            };
            App.runtime.rafId = requestAnimationFrame(tick);
        }

        // ---------- Mode switching ----------
        function setViewMode(mode) {
            const m = (mode === 'subject') ? 'subject' : 'total';
            App.store.settings.viewMode = m;
            Storage.save(App.store);

            ui.modeTotalBtn.classList.toggle('active', m === 'total');
            ui.modeSubjectBtn.classList.toggle('active', m === 'subject');
            ui.subjectSelect.disabled = (m !== 'subject');

            renderHUD();
        }

        // ---------- Goal ----------
        function saveGoalFromInputs() {
            const h = clamp(parseInt(ui.goalHours.value || '0', 10) || 0, 0, 23);
            const m = clamp(parseInt(ui.goalMinutes.value || '0', 10) || 0, 0, 59);
            const goal = (h * 60 + m) * 60000;
            App.store.settings.dailyGoalMs = goal;
            Storage.save(App.store);
            renderAll();
        }

        function resetGoalDefault() {
            App.store.settings.dailyGoalMs = 2 * 60 * 60 * 1000;
            Storage.save(App.store);
            renderAll();
        }

        // ---------- Calendar nav ----------
        function shiftCalendarMonth(delta) {
            const cur = App.store.settings.calendarMonthTs || startOfMonthLocal(Date.now());
            const d = new Date(cur);
            d.setMonth(d.getMonth() + delta);
            d.setDate(1);
            d.setHours(0,0,0,0);
            App.store.settings.calendarMonthTs = d.getTime();
            Storage.save(App.store);
            renderCalendar();
        }

        // ---------- Event wiring ----------
        // HUD interactions
        ui.modeTotalBtn.addEventListener('click', () => setViewMode('total'));
        ui.modeSubjectBtn.addEventListener('click', () => setViewMode('subject'));

        ui.subjectSelect.addEventListener('change', () => setActiveSubject(ui.subjectSelect.value));

        ui.toggleBtn.addEventListener('click', toggleTimer);

        ui.addSubjectBtn.addEventListener('click', () => openSubjectModal('add'));
        ui.openPanelBtn.addEventListener('click', () => openPanel(App.store.settings.panelTab || 'stats'));

        // Subject modal
        ui.subjectCancelBtn.addEventListener('click', closeSubjectModal);
        ui.subjectModal.addEventListener('click', (e) => {
            if (!should_dismiss_dialog(ui.subjectModal, e)) return;
            closeSubjectModal();
        });
        ui.subjectColorInput.addEventListener('input', syncColorDotActive);

        ui.subjectSaveBtn.addEventListener('click', upsertSubject);
        ui.subjectNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') upsertSubject();
            if (e.key === 'Escape') closeSubjectModal();
        });

        ui.subjectDeleteBtn.addEventListener('click', async () => {
            const sid = subjectModalTargetId;
            const ok = await confirmDialog('과목 삭제', '이 과목을 삭제할까요? (기록은 남지만 과목 목록에서 제거됨)');
            closeConfirm(false);
            if (!ok) return;
            deleteSubject(sid);
            closeSubjectModal();
        });

        // Panel open/close
        ui.closePanelBtn.addEventListener('click', closePanel);

        ui.tabBtnStats.addEventListener('click', () => setPanelTab('stats'));
        ui.tabBtnCalendar.addEventListener('click', () => setPanelTab('calendar'));
        ui.tabBtnSubjects.addEventListener('click', () => setPanelTab('subjects'));
        ui.tabBtnGoal.addEventListener('click', () => setPanelTab('goal'));

        // Stats controls
        ui.periodTodayBtn.addEventListener('click', () => setStatsPeriod('today'));
        ui.periodWeekBtn.addEventListener('click', () => setStatsPeriod('week'));
        ui.periodMonthBtn.addEventListener('click', () => setStatsPeriod('month'));
        ui.exportBtn.addEventListener('click', exportJSON);
        ui.resetTodayBtn.addEventListener('click', resetToday);
        ui.resetAllBtn.addEventListener('click', resetAll);

        // Calendar controls
        ui.calPrevBtn.addEventListener('click', () => shiftCalendarMonth(-1));
        ui.calNextBtn.addEventListener('click', () => shiftCalendarMonth(1));

        // Subjects panel
        ui.addSubjectBtn2.addEventListener('click', () => openSubjectModal('add'));

        // Goal panel
        ui.goalSaveBtn.addEventListener('click', saveGoalFromInputs);
        ui.goalResetBtn.addEventListener('click', resetGoalDefault);

        // Day detail
        ui.dayDetailCloseBtn.addEventListener('click', closeDayDetail);
        ui.dayDetailModal.addEventListener('click', (e) => {
            if (!should_dismiss_dialog(ui.dayDetailModal, e)) return;
            closeDayDetail();
        });

        // Confirm
        ui.confirmCancelBtn.addEventListener('click', () => closeConfirm(false));
        ui.confirmOkBtn.addEventListener('click', () => closeConfirm(true));

        // Visibility: background/foreground 전환 시에도 Date.now 기반으로 정확히 누적되지만,
        // 복귀 시 UI/자정 분리를 한 번 더 보정
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const nowTs = Date.now();
                if (App.runtime.running) {
                    // long sleep 보정
                    commitDelta(nowTs);
                    handleMidnightIfNeeded(nowTs);
                    Storage.save(App.store);
                }
                renderAll();
            }
        });

        // ---------- Init ----------
        // restore last subject
        App.runtime.activeSubjectId = App.store.settings.lastSubjectId || '';

        // view mode init
        setViewMode(App.store.settings.viewMode || 'total');

        // initial render
        renderAll();

        // start tick loop (always on; lightweight throttling inside)
        scheduleTick();
    </script>
</body>
</html>
