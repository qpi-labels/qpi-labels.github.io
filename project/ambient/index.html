<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sky with Audio Visualizer & Satellite</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #90caf9;
            --accent: #ffffff;
            --panel-bg: rgba(20, 20, 20, 0.85);
            
            /* Sky Variables */
            --zenith: #000;
            --horizon: #000;
            --sun-x: 50%; --sun-y: 110%;
            --moon-x: 50%; --moon-y: 110%;
            --star-opacity: 0;
            --star-rot: 0deg;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Roboto', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            position: fixed;
            top: 0; left: 0;
            overscroll-behavior: none;
        }

        /* === Layers === */
        .layer-fixed {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            pointer-events: none;
        }

        .sky {
            background: linear-gradient(to bottom, var(--zenith) 0%, var(--horizon) 100%);
            z-index: 0;
        }

        .star-field {
            top: 50%; left: 50%;
            width: 200vmax; height: 200vmax;
            transform: translate(-50%, -50%) rotate(var(--star-rot));
            z-index: 1;
            opacity: var(--star-opacity);
            transition: opacity 0.5s;
        }
        
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle var(--dur) ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Satellite Styles */
        .satellite {
            position: absolute;
            width: 2px; height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            filter: blur(0.5px);
            z-index: 2;
        }

        /* === Celestial Bodies === */
        .celestial-container { z-index: 5; }

        .sun-group {
            position: absolute; left: var(--sun-x); top: var(--sun-y);
            transform: translate(-50%, -50%); width: 0; height: 0;
        }
        .sun-glow-large {
            position: absolute; transform: translate(-50%, -50%);
            width: 150vmax; height: 150vmax;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(200, 200, 255, 0.1) 30%, transparent 70%);
            mix-blend-mode: screen;
        }
        .sun-glow-intense {
            position: absolute; transform: translate(-50%, -50%);
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(255, 250, 220, 0.8) 0%, rgba(255, 200, 50, 0.2) 40%, transparent 70%);
            mix-blend-mode: screen;
        }
        .sun-disk {
            position: absolute; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 0 20px 5px rgba(255, 255, 240, 0.9);
        }

        .moon-group {
            position: absolute; left: var(--moon-x); top: var(--moon-y);
            transform: translate(-50%, -50%); width: 0; height: 0;
        }
        .moon-glow {
            position: absolute; transform: translate(-50%, -50%);
            width: 100vmax; height: 100vmax;
            background: radial-gradient(circle, rgba(200, 225, 255, 0.25) 0%, transparent 60%);
            mix-blend-mode: screen;
        }
        .moon-disk {
            position: absolute; transform: translate(-50%, -50%);
            width: 70px; height: 70px; border-radius: 50%;
            background: #dcdcdc;
            background-image: 
                radial-gradient(circle at 30% 30%, rgba(0,0,0,0.1) 0%, transparent 20%),
                radial-gradient(circle at 60% 70%, rgba(0,0,0,0.1) 0%, transparent 30%);
            box-shadow: 0 0 30px 2px rgba(255, 255, 255, 0.6);
        }

        /* === Visualizer === */
        .visualizer-canvas {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%; height: 200px;
            z-index: 10;
            pointer-events: none;
            -webkit-mask-image: linear-gradient(to top, black 0%, transparent 100%);
            mask-image: linear-gradient(to top, black 0%, transparent 100%);
        }

        /* === UI === */
        .bottom-clock {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9);
            font-weight: 100; font-size: 14px; letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
        }

        .fab-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; z-index: 101;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.2s;
        }
        .fab-btn:hover { background: rgba(255, 255, 255, 0.25); }
        .fab-btn:active { transform: scale(0.95); }
        .fab-icon { width: 24px; height: 24px; fill: white; }

        .settings-popup {
            position: fixed; bottom: 90px; right: 30px;
            width: 280px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 20px; border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--accent); z-index: 100;
            opacity: 0; pointer-events: none;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: bottom right;
        }
        .settings-popup.active { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
        
        .popup-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .popup-label { font-size: 14px; font-weight: 300; }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; margin: 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(144, 202, 249, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-tg { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: 34px; transition: .4s; }
        .slider-tg:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-tg { background-color: var(--primary); }
        input:checked + .slider-tg:before { transform: translateX(16px); }

        .btn-viz {
            width: 100%; padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: white;
            font-family: inherit; font-size: 14px; cursor: pointer;
            transition: background 0.2s;
        }
        .btn-viz:hover { background: rgba(255,255,255,0.2); }

    </style>
</head>
<body>

    <div class="layer-fixed sky"></div>
    <div class="layer-fixed star-field" id="starField"></div>
    <div class="layer-fixed celestial-container">
        <div class="sun-group">
            <div class="sun-glow-large"></div>
            <div class="sun-glow-intense"></div>
            <div class="sun-disk"></div>
        </div>
        <div class="moon-group">
            <div class="moon-glow"></div>
            <div class="moon-disk"></div>
        </div>
    </div>
    <div id="satelliteLayer" class="layer-fixed"></div>

    <canvas id="vizCanvas" class="visualizer-canvas"></canvas>

    <div class="bottom-clock" id="clockDisplay">00:00:00</div>

    <div class="fab-btn" id="fabBtn" onclick="togglePopup()">
        <svg class="fab-icon" viewBox="0 0 24 24">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.49l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
    </div>

    <div class="settings-popup" id="settingsPanel">
        <div class="popup-row">
            <span class="popup-label">Auto Sync</span>
            <label class="switch">
                <input type="checkbox" id="autoCheck" checked>
                <span class="slider-tg"></span>
            </label>
        </div>
        <div class="popup-row">
            <span class="popup-label">Ambient Sound</span>
            <label class="switch">
                <input type="checkbox" id="soundCheck">
                <span class="slider-tg"></span>
            </label>
        </div>
        <div class="popup-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
            <span class="popup-label">Time Adjustment</span>
            <input type="range" id="timeRange" min="0" max="1440" value="720" disabled>
        </div>
        <div class="popup-row">
            <button class="btn-viz" id="btnViz">Enable Visualizer (Audio)</button>
        </div>
    </div>

    <script>
        // === 1. Init Stars ===
        const starField = document.getElementById('starField');
        for(let i=0; i<400; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            const size = Math.random() * 2 + 0.5;
            s.style.width = size + 'px';
            s.style.height = size + 'px';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 100 + '%';
            s.style.setProperty('--dur', (Math.random()*3 + 1) + 's');
            starField.appendChild(s);
        }

        // === 2. UI Variables ===
        const settingsPanel = document.getElementById('settingsPanel');
        const clockDisplay = document.getElementById('clockDisplay');
        const autoCheck = document.getElementById('autoCheck');
        const soundCheck = document.getElementById('soundCheck');
        const timeRange = document.getElementById('timeRange');
        const btnViz = document.getElementById('btnViz');
        const satelliteLayer = document.getElementById('satelliteLayer');

        let isAuto = true;
        let isSoundOn = false;
        let nowMin = 720;
        let nowSec = 0;

        function togglePopup() {
            settingsPanel.classList.toggle('active');
        }

        autoCheck.addEventListener('change', (e) => {
            isAuto = e.target.checked;
            timeRange.disabled = isAuto;
            timeRange.style.opacity = isAuto ? 0.5 : 1;
        });

        soundCheck.addEventListener('change', (e) => {
            isSoundOn = e.target.checked;
            if(isSoundOn) initAmbient();
            else stopAmbient();
        });

        // === 3. Ambient Sound Logic ===
        let audioElements = {};
        const soundTypes = ['morning', 'day', 'night'];
        
        // 저작권 무료 오디오 소스 (공용 샘플)
        const soundSources = {
            morning: 'https://assets.mixkit.co/sfx/preview/mixkit-forest-birds-ambience-1210.mp3',
            day: 'https://assets.mixkit.co/sfx/preview/mixkit-soft-wind-light-rain-ambience-2495.mp3',
            night: 'https://assets.mixkit.co/sfx/preview/mixkit-crickets-and-insects-in-the-wild-ambience-39.mp3'
        };

        function initAmbient() {
            if (Object.keys(audioElements).length === 0) {
                for (let type in soundSources) {
                    let audio = new Audio(soundSources[type]);
                    audio.loop = true;
                    audio.volume = 0;
                    audioElements[type] = audio;
                }
            }
            updateAmbientVolumes();
        }

        function stopAmbient() {
            for (let type in audioElements) {
                audioElements[type].pause();
                audioElements[type].volume = 0;
            }
        }

        function updateAmbientVolumes() {
            if (!isSoundOn) return;
            const h = nowMin / 60;
            let volumes = { morning: 0, day: 0, night: 0 };

            if (h >= 4 && h < 10) volumes.morning = 0.5;
            else if (h >= 10 && h < 17) volumes.day = 0.3;
            else volumes.night = 0.5;

            for (let type in audioElements) {
                let targetVol = volumes[type];
                if (targetVol > 0) {
                    if (audioElements[type].paused) audioElements[type].play().catch(()=>{});
                    audioElements[type].volume = targetVol;
                } else {
                    audioElements[type].volume = 0;
                }
            }
        }

        // === 4. Satellite & Starlink Logic ===
        function createSatellite(isStarlink = false) {
            const h = nowMin / 60;
            // 밤에만 등장 (태양이 지평선 아래일 때 더 잘 보임)
            const sunStart = 5, sunEnd = 19;
            if (h > sunStart + 1 && h < sunEnd - 1) return; 

            const count = isStarlink ? 12 : 1;
            const startY = Math.random() * 60 + 10;
            const speed = Math.random() * 2 + 1;
            const angle = (Math.random() - 0.5) * 0.2;
            const id = Date.now();

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const sat = document.createElement('div');
                    sat.className = 'satellite';
                    satelliteLayer.appendChild(sat);

                    let x = -10;
                    let y = startY;

                    function move() {
                        x += speed;
                        y += angle;
                        sat.style.left = x + 'vw';
                        sat.style.top = y + 'vh';
                        sat.style.opacity = Math.sin((x / 100) * Math.PI) * 0.8;

                        if (x < 110) requestAnimationFrame(move);
                        else sat.remove();
                    }
                    move();
                }, i * (isStarlink ? 400 : 0));
            }
        }

        setInterval(() => {
            if (Math.random() > 0.98) createSatellite(Math.random() > 0.8);
        }, 3000);

        // === 5. Audio Visualizer Logic (기존 유지) ===
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        let audioCtx, analyser, dataArray, source;
        let isVizRunning = false;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = 200;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        btnViz.addEventListener('click', async () => {
            if (isVizRunning) return;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                if (stream.getAudioTracks().length === 0) {
                    alert("시스템 오디오가 공유되지 않았습니다.");
                    stream.getTracks().forEach(track => track.stop());
                    return;
                }
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isVizRunning = true;
                btnViz.textContent = "Visualizer Active";
                btnViz.style.background = "rgba(100, 255, 100, 0.2)";
                animateVisualizer();
                stream.getVideoTracks()[0].onended = () => {
                    isVizRunning = false;
                    btnViz.textContent = "Enable Visualizer (Audio)";
                    btnViz.style.background = "";
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    if(audioCtx) audioCtx.close();
                };
            } catch (err) { console.error(err); }
        });

        function animateVisualizer() {
            if (!isVizRunning) return;
            requestAnimationFrame(animateVisualizer);
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barCount = dataArray.length;
            const barWidth = canvas.width / barCount;
            for (let i = 0; i < barCount; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;
                ctx.fillStyle = `rgba(255, 255, 255, ${dataArray[i]/255 * 0.8})`;
                const x = i * barWidth;
                const y = canvas.height - barHeight;
                ctx.fillRect(x, y, barWidth - 1, barHeight);
            }
        }

        // === 6. Sky Logic (기존 유지) ===
        const lerp = (a, b, t) => a + (b - a) * t;
        const lerpRGB = (c1, c2, t) => {
            const r = Math.round(lerp(c1[0], c2[0], t));
            const g = Math.round(lerp(c1[1], c2[1], t));
            const b = Math.round(lerp(c1[2], c2[2], t));
            return `rgb(${r},${g},${b})`;
        };

        const skyKeyframes = [
            { h: 0,  z: [5, 10, 25],      hz: [10, 20, 35] },
            { h: 4,  z: [5, 10, 25],      hz: [10, 20, 35] },
            { h: 5,  z: [20, 30, 60],     hz: [80, 50, 50] },
            { h: 6,  z: [40, 80, 140],    hz: [255, 150, 100] },
            { h: 8,  z: [30, 100, 200],   hz: [170, 220, 255] },
            { h: 12, z: [20, 90, 190],    hz: [180, 230, 255] },
            { h: 16, z: [30, 100, 200],   hz: [170, 220, 255] },
            { h: 18, z: [30, 50, 110],    hz: [255, 120, 50] },
            { h: 19, z: [20, 30, 70],     hz: [100, 50, 100] },
            { h: 21, z: [5, 10, 25],      hz: [10, 20, 35] },
            { h: 24, z: [5, 10, 25],      hz: [10, 20, 35] }
        ];

        function getSkyColors(hour) {
            for (let i = 0; i < skyKeyframes.length - 1; i++) {
                const start = skyKeyframes[i];
                const end = skyKeyframes[i+1];
                if (hour >= start.h && hour <= end.h) {
                    const range = end.h - start.h;
                    const progress = (hour - start.h) / range;
                    return {
                        z: lerpRGB(start.z, end.z, progress),
                        hz: lerpRGB(start.hz, end.hz, progress)
                    };
                }
            }
            return { z: 'rgb(0,0,0)', hz: 'rgb(0,0,0)' };
        }

        function update(minutes, seconds) {
            const h = minutes / 60;
            const colors = getSkyColors(h);
            document.documentElement.style.setProperty('--zenith', colors.z);
            document.documentElement.style.setProperty('--horizon', colors.hz);

            const sunStart = 5, sunEnd = 19;
            let sunAlt = -1;
            if(h >= sunStart && h <= sunEnd) {
                const prog = (h - sunStart) / (sunEnd - sunStart);
                const rad = prog * Math.PI;
                sunAlt = Math.sin(rad);
                const sx = (prog * 120) - 10; 
                const sy = 100 - (sunAlt * 90);
                document.documentElement.style.setProperty('--sun-x', sx + '%');
                document.documentElement.style.setProperty('--sun-y', sy + '%');
            } else {
                document.documentElement.style.setProperty('--sun-y', '150%');
            }

            const moonH = (h + 12) % 24;
            if(moonH >= 5 && moonH <= 19) {
                const prog = (moonH - 5) / 14;
                const rad = prog * Math.PI;
                const alt = Math.sin(rad);
                const sx = (prog * 120) - 10;
                const sy = 100 - (alt * 85);
                document.documentElement.style.setProperty('--moon-x', sx + '%');
                document.documentElement.style.setProperty('--moon-y', sy + '%');
            } else {
                document.documentElement.style.setProperty('--moon-y', '150%');
            }

            let starOp = (sunAlt > 0) ? 0 : 1;
            if(sunAlt > 0 && sunAlt < 0.2) starOp = 0;
            else if(sunAlt <= 0 && sunAlt > -0.2) starOp = Math.abs(sunAlt) * 5;
            
            document.documentElement.style.setProperty('--star-opacity', starOp);
            document.documentElement.style.setProperty('--star-rot', (minutes/4) + 'deg');

            const hh = Math.floor(h);
            const mm = Math.floor(minutes % 60);
            const ss = Math.floor(seconds);
            clockDisplay.textContent = 
                `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
            
            updateAmbientVolumes();
        }

        function loop() {
            if(isAuto) {
                const d = new Date();
                nowMin = d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
                nowSec = d.getSeconds();
                timeRange.value = nowMin;
            } else {
                nowMin = parseFloat(timeRange.value);
                nowSec = 0;
            }
            update(nowMin, nowSec);
            requestAnimationFrame(loop);
        }

        loop();

    </script>
</body>
</html>
