<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QPI Ambient</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:url" content="https://qpi.kro.kr/">
    <meta property="og:title" content="QPI Ambient">
    <meta property="og:type" content="website">
    <meta property="og:image" content="logo.ico">
<meta name="color-scheme" content="only light">
    <link rel="apple-touch-icon" href="logo-9.png">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #90caf9;
            --zenith: #000; --horizon: #000;
            --sun-x: 50%; --sun-y: 110%;
            --moon-x: 50%; --moon-y: 110%;
            --star-opacity: 0; --star-rot: 0deg;
            --ui-color: rgba(255, 255, 255, 0.4);
            color-scheme: only light !important;
            --flare-opacity: 0;
            /* 별 마스킹 제어 변수 */
            --star-mask-y: -50%;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--horizon);
            font-family: 'Roboto', sans-serif; user-select: none;
            position: fixed; top: 0; left: 0; overscroll-behavior: none;
            filter: none !important; 
        }

        .layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .sky { z-index: 0; background: linear-gradient(to bottom, var(--zenith) 0%, var(--horizon) 100%) !important; }
        
        .atmosphere {
            z-index: 1;
            background: radial-gradient(ellipse 50vmax 40vmax at var(--sun-x) var(--sun-y), rgba(255, 255, 250, 0.40) 0%, rgba(255, 248, 235, 0.32) 4%, rgba(255, 240, 215, 0.25) 8%, rgba(255, 230, 190, 0.18) 14%, rgba(255, 215, 160, 0.12) 22%, rgba(245, 195, 130, 0.07) 32%, rgba(230, 175, 110, 0.03) 45%, transparent 60%), radial-gradient(ellipse 40vmax 30vmax at calc(100% - var(--sun-x) + 50%) calc(100% - var(--sun-y) + 50%), rgba(200, 220, 255, 0.04) 0%, rgba(180, 210, 250, 0.02) 40%, transparent 65%), radial-gradient(ellipse 150% 45% at 50% 100%, rgba(255, 200, 130, 0.28) 0%, rgba(255, 215, 150, 0.20) 10%, rgba(250, 200, 145, 0.14) 22%, rgba(240, 180, 140, 0.09) 38%, rgba(220, 160, 150, 0.05) 55%, rgba(200, 150, 160, 0.02) 70%, transparent 85%), radial-gradient(ellipse 180% 80% at 50% 55%, rgba(200, 225, 255, 0.06) 0%, rgba(180, 215, 255, 0.04) 35%, rgba(160, 205, 255, 0.02) 65%, transparent 90%), radial-gradient(ellipse 170% 90% at 50% -10%, rgba(110, 170, 255, 0.09) 0%, rgba(130, 185, 255, 0.05) 30%, rgba(150, 200, 255, 0.02) 65%, transparent 90%);
            mix-blend-mode: screen; opacity: var(--atmosphere-opacity, 0); transition: opacity 2s ease;
        }
        
        .star-field { 
            top: 50%; left: 50%; width: 200vmax; height: 200vmax; z-index: 2; 
            transform: translate(-50%, -50%) rotate(var(--star-rot)); 
            opacity: var(--star-opacity); 
            transition: opacity 0.5s linear;
            /* 위에서 아래로 나타나는 마스크 효과 */
            -webkit-mask-image: linear-gradient(to bottom, #fff calc(var(--star-mask-y) - 40%), transparent calc(var(--star-mask-y) + 40%));
            mask-image: linear-gradient(to bottom, #fff calc(var(--star-mask-y) - 40%), transparent calc(var(--star-mask-y) + 40%));
        }

        .satellite { position: absolute; width: 1.5px; height: 1.5px; z-index: 3; background: #fff; border-radius: 50%; box-shadow: 0 0 3px 1px rgba(255,255,255,0.7); }

        .sun-aura { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 160vmax; height: 160vmax; z-index: 4; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, rgba(255, 220, 150, 0.08) 25%, transparent 65%) !important; mix-blend-mode: screen; }
        .sun-disk { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 60px; height: 60px; z-index: 5; transform: translate(-50%, -50%); border-radius: 50%; background: radial-gradient(circle at 45% 45%, #fffef8 0%, #fffdf5 30%, #fff9e8 60%, #ffe8c0 95%, #ffd080 100%) !important; box-shadow: inset 0 0 15px rgba(255, 240, 200, 0.8), 0 0 30px 8px rgba(255, 255, 255, 0.9), 0 0 60px 20px rgba(255, 245, 220, 0.7), 0 0 100px 35px rgba(255, 230, 180, 0.4), 0 0 150px 50px rgba(255, 210, 120, 0.2) !important; }
        .moon-aura { position: absolute; left: var(--moon-x); top: var(--moon-y); width: 120vmax; height: 120vmax; z-index: 4; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(200, 220, 240, 0.25) 0%, rgba(180, 210, 235, 0.12) 20%, transparent 50%) !important; mix-blend-mode: screen; }
        .moon-disk { position: absolute; left: var(--moon-x); top: var(--moon-y); width: 52px; height: 52px; z-index: 5; transform: translate(-50%, -50%); border-radius: 50%; background: radial-gradient(circle, #ffffff 0%, #fffef9 30%, #fffbf0 65%, #fff7e5 100%) !important; box-shadow: 0 0 28px 7px rgba(255, 255, 255, 0.85), 0 0 55px 14px rgba(245, 248, 255, 0.55), 0 0 90px 22px rgba(230, 238, 255, 0.35), 0 0 140px 35px rgba(210, 225, 250, 0.18) !important; }

        .lens-flare-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 6; pointer-events: none; mix-blend-mode: screen; opacity: var(--flare-opacity); will-change: opacity; }
        .flare-ghost { position: absolute; transform: translate(-50%, -50%); border-radius: 50%; will-change: left, top; }
        .flare-halo { width: 55vmax; height: 55vmax; background: radial-gradient(circle, transparent 69%, rgba(255, 200, 150, 0.06) 71%, rgba(255, 100, 50, 0.03) 73%, transparent 75%); filter: blur(12px); }
        .ghost-hex { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.04); clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); filter: blur(2px); }
        .sun-streak { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 100vw; height: 1px; transform: translate(-50%, -50%); background: linear-gradient(90deg, transparent, rgba(150, 200, 255, 0.15), rgba(255, 255, 255, 0.3), rgba(150, 200, 255, 0.15), transparent); filter: blur(2px); }
        .sun-spikes { position: absolute; left: var(--sun-x); top: var(--sun-y); width: 250px; height: 250px; transform: translate(-50%, -50%); background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 60%), linear-gradient(0deg, transparent 49.5%, rgba(255,255,255,0.2) 50%, transparent 50.5%), linear-gradient(90deg, transparent 49.5%, rgba(255,255,255,0.2) 50%, transparent 50.5%), linear-gradient(45deg, transparent 49.7%, rgba(255,255,255,0.1) 50%, transparent 50.3%), linear-gradient(-45deg, transparent 49.7%, rgba(255,255,255,0.1) 50%, transparent 50.3%); filter: blur(3px); }
        .ghost-rainbow { width: 180px; height: 180px; background: radial-gradient(circle, transparent 40%, rgba(255, 50, 50, 0.03) 45%, rgba(50, 255, 50, 0.03) 50%, rgba(50, 50, 255, 0.03) 55%, transparent 60%); filter: blur(8px); }
        .ghost-tiny { width: 12px; height: 12px; background: rgba(255, 255, 255, 0.3); filter: blur(1px); box-shadow: 0 0 15px 3px rgba(255, 255, 255, 0.2); }

        .viz-canvas { position: fixed; bottom: 0; left: 0; width: 100%; height: 220px; z-index: 10; pointer-events: none; mask-image: linear-gradient(to top, black 30%, transparent 100%); -webkit-mask-image: linear-gradient(to top, black 30%, transparent 100%); }
        .bottom-clock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: var(--ui-color); font-weight: 100; font-size: 15px; letter-spacing: 3px; z-index: 100; text-shadow: 0 0 15px rgba(0,0,0,0.6), 0 0 3px rgba(0,0,0,0.9); transition: color 1s ease, transform 0.2s; cursor: pointer; pointer-events: auto; }
        .bottom-clock:active { transform: translateX(-50%) scale(0.95); }

        .info-panel { position: fixed; bottom: 75px; left: 50%; transform: translateX(-50%); background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(15px); padding: 12px 24px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 11px; z-index: 105; font-weight: 300; display: flex; gap: 20px; pointer-events: none; opacity: 0; transition: 0.4s; }
        .info-panel.active { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        .info-panel b { color: var(--primary); font-weight: 400; margin-right: 4px; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: rgba(127,127,127,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(127,127,127,0.2); cursor: pointer; z-index: 110; display: flex; justify-content: center; align-items: center; }
        .popup { position: fixed; bottom: 95px; right: 30px; width: 260px; background: rgba(10,10,10,0.95); backdrop-filter: blur(25px); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: #fff; z-index: 120; opacity: 0; pointer-events: none; transform: translateY(15px); transition: 0.4s cubic-bezier(0.2, 1, 0.3, 1); }
        .popup.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; transition: opacity 0.3s ease; }
        .label { font-size: 11px; font-weight: 300; letter-spacing: 1px; color: #999; text-transform: uppercase; }
        .manual-ui.disabled { opacity: 0.15; pointer-events: none; filter: grayscale(1); }
        .speed-ctrl { display: flex; gap: 10px; align-items: center; }
        .speed-btn { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: #fff; border-radius: 6px; padding: 5px 14px; font-size: 11px; cursor: pointer; transition: 0.2s; font-family: inherit; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        .switch { position: relative; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #333; border-radius: 18px; transition: 0.4s; cursor: pointer; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }
        .btn-action { width: 100%; padding: 12px; background: rgba(144,202,249,0.1); border: 1px solid rgba(144,202,249,0.3); border-radius: 8px; color: #90caf9; font-size: 11px; cursor: pointer; margin-top: 5px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="layer sky"></div>
    <div class="layer atmosphere"></div>
    <div class="layer star-field" id="starField">
        <canvas id="starfield-stars" style="width: 100%; height: 100%;"></canvas>
    </div>
    <div id="satLayer" class="layer"></div>
    <div class="layer celestial">
        <div class="sun-disk"></div>
        <div class="moon-disk"></div>
    </div>
    <div class="lens-flare-container">
        <div class="sun-spikes"></div>
        <div class="sun-streak"></div>
        <div class="flare-ghost flare-halo" id="flare-halo"></div>
        <div class="flare-ghost ghost-rainbow" id="gh-rb"></div>
        <div class="flare-ghost ghost-hex" id="gh-1" style="width: 90px; height: 90px;"></div>
        <div class="flare-ghost ghost-hex" id="gh-2" style="width: 45px; height: 45px; background: rgba(150, 255, 200, 0.1);"></div>
        <div class="flare-ghost ghost-hex" id="gh-3" style="width: 120px; height: 120px; opacity: 0.05;"></div>
        <div class="flare-ghost ghost-tiny" id="gh-4"></div>
        <div class="flare-ghost ghost-tiny" id="gh-5" style="background: rgba(255, 100, 0, 0.4);"></div>
        <div class="flare-ghost ghost-hex" id="gh-6" style="width: 25px; height: 25px; background: rgba(100, 150, 255, 0.15);"></div>
        <div class="flare-ghost" id="gh-7" style="width: 400px; height: 400px; background: radial-gradient(circle, rgba(255,150,100,0.05), transparent); border-radius: 50%;"></div>
        <div class="flare-ghost" id="gh-8" style="width: 150px; height: 150px; background: radial-gradient(circle, rgba(100,255,200,0.03), transparent); border-radius: 50%;"></div>
    </div>

    <canvas id="vizCanvas" class="viz-canvas"></canvas>
    <div class="info-panel" id="infoPanel">
        <span><b>DATE</b> <span id="infoDate">-</span></span>
        <span><b>SUNRISE</b> <span id="infoRise">-</span></span>
        <span><b>SUNSET</b> <span id="infoSet">-</span></span>
    </div>
    <div class="bottom-clock" id="clock" onclick="toggleInfo()">00:00:00</div>
    <div class="fab" onclick="togglePopup()">
        <svg style="width:20px;height:20px;fill:var(--ui-color)" viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.47,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.53,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.53,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.47,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
    </div>

    <div class="popup" id="popup">
        <div class="row"><span class="label">시간 자동 설정</span><label class="switch"><input type="checkbox" id="autoCheck" checked onchange="handleSyncToggle()"><span class="slider"></span></label></div>
        <div id="manualSection" class="manual-ui disabled">
            <div class="row" style="flex-direction:column; align-items:flex-start; gap:8px;"><span class="label">시간 수동 설정</span><input type="range" id="timeRange" min="0" max="1439.99" step="0.01" value="720"></div>
            <div class="row" style="margin-bottom:25px;"><span class="label">속도 (<span id="speedVal">1</span>배속)</span><div class="speed-ctrl"><button class="speed-btn" onclick="adjustSpeed(0.5)">x0.5</button><button class="speed-btn" onclick="adjustSpeed(2)">x2</button></div></div>
        </div>
        <div class="row"><span class="label">배경음</span><label class="switch"><input type="checkbox" id="soundToggle"><span class="slider"></span></label></div>
        <div class="row" style="flex-direction:column; align-items:flex-start; gap:8px;">
            <span class="label">배경음 볼륨</span>
            <input type="range" id="volumeRange" min="0" max="100" step="1" value="20">
        </div>
        <button class="btn-action" id="btnViz">비주얼라이저 (PC 전용)</button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }

        const LAT = 36.5, LON = 127.2;
        function getSunTimes(date) {
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const rad = Math.PI / 180;
            const gamma = 2 * Math.PI / 365 * (dayOfYear - 1 + (date.getHours() - 12) / 24);
            const eqtime = 229.18 * (0.000075 + 0.001868 * Math.cos(gamma) - 0.032077 * Math.sin(gamma) - 0.014615 * Math.cos(2 * gamma) - 0.040849 * Math.sin(2 * gamma));
            const decl = 0.006918 - 0.399912 * Math.cos(gamma) + 0.070257 * Math.sin(gamma) - 0.006758 * Math.cos(2 * gamma) + 0.000907 * Math.sin(2 * gamma) - 0.002697 * Math.cos(3 * gamma) + 0.00148 * Math.sin(3 * gamma);
            const ha_rad = Math.acos(Math.cos(90.833 * rad) / (Math.cos(LAT * rad) * Math.cos(decl)) - Math.tan(LAT * rad) * Math.tan(decl));
            const ha = ha_rad / rad;
            const sunrise = 720 - 4 * (LON + ha) - eqtime + 540;
            const sunset = 720 - 4 * (LON - ha) - eqtime + 540;
            return { sunrise, sunset };
        }

        function formatMinutes(m) {
            const h = Math.floor(m / 60) % 24;
            const mins = Math.floor(m % 60);
            return `${h.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
        }

        function toggleInfo() {
            const panel = document.getElementById('infoPanel');
            const solar = getSunTimes(new Date());
            document.getElementById('infoDate').textContent = new Date().toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', weekday: 'short' });
            document.getElementById('infoRise').textContent = formatMinutes(solar.sunrise);
            document.getElementById('infoSet').textContent = formatMinutes(solar.sunset);
            panel.classList.toggle('active');
            setTimeout(() => panel.classList.remove('active'), 6000);
        }

        const canv = document.getElementById('starfield-stars');
        const context = canv.getContext('2d');
        let seed = 277;
        const prand = () => {
            seed = (1664525 * seed + 1013904223) % 4294967296;
            return seed/4294967296;
        };
        canv.width = canv.height = 4000;
        for(let i=0; i<8000; i++){
            const size = prand()*1.2 + 0.4;
            const x = prand()*4000;
            const y = prand()*4000;
            context.fillStyle = `rgba(255, 255, 255, ${prand()})`;
            context.beginPath(); context.arc(x, y, size, 0, 2 * Math.PI); context.fill();
        }

        const satLayer = document.getElementById('satLayer');
        let currentSunAlt = 1;

        function animateObject(isStarlink = false) {
            // 태양 고도를 루프에서 사용하는 전역 대신 수동 시간 기준으로 즉시 재계산.
            const solar = getSunTimes(new Date());
            const mG = (manualMinutes % 1440 + 1440) % 1440;
            let tempSunAlt = -1;
            if (mG >= solar.sunrise && mG <= solar.sunset) {
                const prog = (mG - solar.sunrise) / (solar.sunset - solar.sunrise);
                tempSunAlt = Math.sin(prog * Math.PI);
            }
            if (tempSunAlt > 0.05) return; 

            const side = Math.floor(Math.random() * 4);
            let sx, sy, ex, ey;
            if(side === 0) { sx = -15; sy = Math.random()*100; ex = 115; ey = Math.random()*100; }
            else if(side === 1) { sx = 115; sy = Math.random()*100; ex = -15; ey = Math.random()*100; }
            else if(side === 2) { sx = Math.random()*100; sy = -15; ex = Math.random()*100; ey = 115; }
            else { sx = Math.random()*100; sy = 115; ex = Math.random()*100; ey = -15; }
            const duration = Math.random() * 20000 + 40000;
            const count = isStarlink ? 18 : 1;
            
            for (let i = 0; i < count; i++) {
                const delay = isStarlink ? i * (700 + Math.random() * 400) : 0; 
                setTimeout(() => {
                    const sat = document.createElement('div'); sat.className = 'satellite';
                    sat.style.opacity = Math.random() * 0.5 + 0.3;
                    satLayer.appendChild(sat);
                    const startT = performance.now();
                    const move = (now) => {
                        const t = (now - startT) / duration;
                        if (t < 1) { sat.style.transform = `translate(${sx + (ex - sx) * t}vw, ${sy + (ey - sy) * t}vh)`; requestAnimationFrame(move); }
                        else { sat.remove(); }
                    };
                    requestAnimationFrame(move);
                }, delay);
            }
        }
        
        setTimeout(() => {
            const satLoop = () => { animateObject(false); setTimeout(satLoop, Math.random() * 60000 + 40000); };
            const starlinkLoop = () => { animateObject(true); setTimeout(starlinkLoop, Math.random() * 120000 + 120000); };
            satLoop(); starlinkLoop();
        }, 5000);

        let audioCtx, gainNode, isPlaying = false, audioInitialized = false;
        const audioURL = 'https://assets.mixkit.co/active_storage/sfx/2453/2453-preview.mp3';
        const audioBufferCache = { buffer: null };
        let sourceNode = null;

        async function initAudio() {
            if (audioInitialized) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            setLogVolume(document.getElementById('volumeRange').value);
            const response = await fetch(audioURL);
            const arrayBuffer = await response.arrayBuffer();
            audioBufferCache.buffer = await audioCtx.decodeAudioData(arrayBuffer);
            audioInitialized = true;
        }

        function setLogVolume(val) {
            if (!gainNode) return;
            const normalized = val / 100;
            const logVol = normalized * normalized; 
            gainNode.gain.setTargetAtTime(logVol, audioCtx.currentTime, 0.1); 
        }

        function playLoop() {
            if (!audioInitialized || !audioBufferCache.buffer) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (sourceNode) { sourceNode.stop(); }
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBufferCache.buffer;
            sourceNode.loop = true;
            sourceNode.connect(gainNode);
            sourceNode.start();
        }

        document.getElementById('soundToggle').addEventListener('change', async function() {
            if (!audioInitialized) await initAudio();
            isPlaying = this.checked;
            if (isPlaying) playLoop();
            else { if (sourceNode) sourceNode.stop(); if(audioCtx) audioCtx.suspend(); }
        });
        document.getElementById('volumeRange').addEventListener('input', (e) => setLogVolume(e.target.value));

        const canvas = document.getElementById('vizCanvas'), ctx = canvas.getContext('2d');
        let analyser, dataArray, isVizActive = false, sampleRate = 48000, smoothHeights = [];
        document.getElementById('btnViz').addEventListener('click', async () => {
            try {
                let stream = null;
                try {
                    stream = await navigator.mediaDevices.getDisplayMedia({ audio: true });
                } catch (e) {
                    alert("오디오 출력을 캡처할 수 없어 기기 마이크를 사용합니다.")
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                const aCtx = new AudioContext(); sampleRate = aCtx.sampleRate;
                const src = aCtx.createMediaStreamSource(stream);
                analyser = aCtx.createAnalyser(); src.connect(analyser);
                analyser.fftSize = 1024; analyser.smoothingTimeConstant = 0.92;
                dataArray = new Uint8Array(analyser.frequencyBinCount); isVizActive = true; drawViz();
            } catch (e) { alert(`Capture failed.\n${e}`); }
        });
        function drawViz() {
            if (!isVizActive) return; requestAnimationFrame(drawViz);
            analyser.getByteFrequencyData(dataArray);
            canvas.width = window.innerWidth; canvas.height = 200; ctx.clearRect(0, 0, canvas.width, canvas.height);
            const bw = canvas.width / 80;
            const minFreq = 80, maxFreq = 14000, nyquist = sampleRate / 2;
            for (let i = 0; i < 80; i++) {
                const freq = minFreq * Math.pow(maxFreq / minFreq, i / 79);
                const dIdx = Math.floor((freq / nyquist) * dataArray.length);
                let raw = dataArray[dIdx] || 0;
                let target = (raw / 255) * canvas.height * (0.6 + (i / 80) * 0.5);
                if (!smoothHeights[i]) smoothHeights[i] = 0;
                if (target > smoothHeights[i]) smoothHeights[i] = target; else smoothHeights[i] *= 0.94;
                const h = Math.min(smoothHeights[i], canvas.height * 0.8);
                ctx.fillStyle = uiColorGlobal.replace(/[\d.]+\)$/g, `${Math.max(0.08, raw/255 * 0.4)})`);
                ctx.fillRect(i * bw, canvas.height - h, bw - 1, h);
            }
        }

        const autoCheck = document.getElementById('autoCheck'), timeRange = document.getElementById('timeRange'), speedValDisp = document.getElementById('speedVal'), clock = document.getElementById('clock'), manualSection = document.getElementById('manualSection');
        let manualMinutes = 720, lastTimestamp = performance.now(), currentSpeed = 1, uiColorGlobal = "rgba(255,255,255,0.4)";
        
        let isCatchingUp = false, catchUpStartMinutes = 0, catchUpStartTime = 0;
        const CATCHUP_DURATION = 2000; 

        function handleSyncToggle() { 
            if (autoCheck.checked) { isCatchingUp = true; catchUpStartMinutes = manualMinutes; catchUpStartTime = performance.now(); manualSection.classList.add('disabled'); } 
            else { isCatchingUp = false; manualSection.classList.remove('disabled'); const d = new Date(); manualMinutes = d.getHours()*60 + d.getMinutes() + d.getSeconds()/60; lastTimestamp = performance.now(); } 
        }
        function adjustSpeed(f) { let n = currentSpeed * f; if (n >= 1 && n <= 512) { currentSpeed = n; speedValDisp.textContent = currentSpeed; } }
        function lerpRGB(c1, c2, t) { return [Math.round(c1[0]+(c2[0]-c1[0])*t), Math.round(c1[1]+(c2[1]-c1[1])*t), Math.round(c1[2]+(c2[2]-c1[2])*t)]; }

        function updateFlare(sxPercent, syPercent, sunAlt) {
            if (sunAlt <= 0) { document.documentElement.style.setProperty('--flare-opacity', 0); return; }
            document.documentElement.style.setProperty('--flare-opacity', Math.min(sunAlt * 1.5, 0.9));
            const cx = 50, cy = 50, sx = sxPercent, sy = syPercent;
            const setFlarePos = (id, scale) => {
                const el = document.getElementById(id);
                if(!el) return;
                const fx = sx + (50 - sx) * scale;
                const fy = sy + (50 - sy) * scale;
                el.style.left = fx + '%';
                el.style.top = fy + '%';
            };
            setFlarePos('flare-halo', 0.5); setFlarePos('gh-rb', 1.3); setFlarePos('gh-1', 1.6); setFlarePos('gh-2', 1.1); setFlarePos('gh-3', 2.0); setFlarePos('gh-4', 0.2); setFlarePos('gh-5', 2.4); setFlarePos('gh-6', 1.8); setFlarePos('gh-7', -0.3); setFlarePos('gh-8', 2.8);
        }

        function updateSky(m) {
            const mG = ((m % 1440) + 1440) % 1440;
            const hRaw = mG / 60, s = Math.round((mG * 60) % 60);
            const solar = getSunTimes(new Date());
            const dawnStart = solar.sunrise - 180, sunsetEnd = solar.sunset + 180;
            const kf = [{ m: 0, z: [5, 10, 25], hz: [10, 20, 35] }, { m: dawnStart, z: [5, 10, 25], hz: [10, 20, 35] }, { m: solar.sunrise, z: [40, 80, 140], hz: [255, 150, 100] }, { m: (solar.sunrise + solar.sunset)/2, z: [30, 100, 220], hz: [180, 230, 255] }, { m: solar.sunset, z: [30, 50, 110], hz: [255, 120, 50] }, { m: sunsetEnd, z: [5, 10, 25], hz: [10, 20, 35] }, { m: 1440, z: [5, 10, 25], hz: [10, 20, 35] }];
            let c = { z: 'rgb(5,10,25)', hz: 'rgb(10,20,35)' };
            for(let i=0; i<kf.length-1; i++){
                if(mG >= kf[i].m && mG <= kf[i+1].m){
                    const t = (mG - kf[i].m) / (kf[i+1].m - kf[i].m);
                    const zenith = lerpRGB(kf[i].z, kf[i+1].z, t);
                    const horizon = lerpRGB(kf[i].hz, kf[i+1].hz, t);
                    c = { z: `rgb(${zenith.join(',')})`, hz: `rgb(${horizon.join(',')})` };
                    const bright = (horizon[0] + horizon[1] + horizon[2]) / 3;
                    uiColorGlobal = (bright > 135) ? "rgba(10, 30, 60, 0.5)" : "rgba(255, 255, 255, 0.4)";
                    document.documentElement.style.setProperty('--ui-color', uiColorGlobal);
                    break;
                }
            }
            document.documentElement.style.setProperty('--zenith', c.z); document.documentElement.style.setProperty('--horizon', c.hz);
            
            let sx, sy;
            if(mG >= solar.sunrise && mG <= solar.sunset){
                const prog = (mG - solar.sunrise) / (solar.sunset - solar.sunrise);
                currentSunAlt = Math.sin(prog * Math.PI);
                sx = prog * 120 - 10; sy = 100 - currentSunAlt * 90;
                document.documentElement.style.setProperty('--sun-x', sx + '%');
                document.documentElement.style.setProperty('--sun-y', sy + '%');
                updateFlare(sx, sy, currentSunAlt);
                document.documentElement.style.setProperty('--atmosphere-opacity', Math.min(currentSunAlt * 1.2, 0.85));
            } else { currentSunAlt = -1; document.documentElement.style.setProperty('--sun-y', '150%'); updateFlare(0,0,-1); document.documentElement.style.setProperty('--atmosphere-opacity', 0); }
            const moonM = (mG + 720) % 1440;
            if(moonM >= solar.sunrise && moonM <= solar.sunset){
                const prog = (moonM - solar.sunrise) / (solar.sunset - solar.sunrise);
                const alt = Math.sin(prog * Math.PI);
                document.documentElement.style.setProperty('--moon-x', (prog * 120 - 10) + '%');
                document.documentElement.style.setProperty('--moon-y', (100 - alt * 85) + '%');
            } else { document.documentElement.style.setProperty('--moon-y', '150%'); }
            
            let starOpacity = 0;
            let starMaskY = -50;
            if (mG >= solar.sunset - 180 && mG <= solar.sunset + 60) {
                starOpacity = (mG - (solar.sunset - 180)) / 240; 
                starMaskY = -50 + (200 * starOpacity); 
            } else if (mG >= solar.sunrise - 60 && mG <= solar.sunrise + 180) {
                starOpacity = 1 - (mG - (solar.sunrise - 60)) / 240;
                starMaskY = 150 - (200 * (1 - starOpacity)); 
            } else if (mG > solar.sunset + 60 || mG < solar.sunrise - 60) {
                starOpacity = 1;
                starMaskY = 150;
            }
            document.documentElement.style.setProperty('--star-opacity', Math.max(0, Math.min(1, starOpacity)));
            document.documentElement.style.setProperty('--star-mask-y', starMaskY + '%');
            document.documentElement.style.setProperty('--star-rot', (mG/4)+'deg');
            clock.textContent = `${Math.floor(hRaw).toString().padStart(2,'0')}:${Math.floor(mG%60).toString().padStart(2,'0')}:${Math.floor(s).toString().padStart(2,'0')}`;
        }

        timeRange.addEventListener('input', () => { if(!autoCheck.checked) { manualMinutes = parseFloat(timeRange.value); lastTimestamp = performance.now(); } });
        
        function loop(now) {
            const deltaMs = now - lastTimestamp; lastTimestamp = now;
            let m;
            const d = new Date();
            const targetMinutes = d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
            if (autoCheck.checked) {
                if (isCatchingUp) {
                    const elapsed = now - catchUpStartTime;
                    let t = Math.min(elapsed / CATCHUP_DURATION, 1);
                    const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
                    let distance = (targetMinutes - catchUpStartMinutes + 1440) % 1440;
                    if(distance > 720) distance -= 1440;
                    m = catchUpStartMinutes + (distance * ease);
                    if (t >= 1) isCatchingUp = false;
                    timeRange.value = m % 1440;
                    manualMinutes = m;
                } else { m = targetMinutes; timeRange.value = m; manualMinutes = m; }
            } else { manualMinutes += (deltaMs / 60000) * currentSpeed; m = manualMinutes; timeRange.value = m % 1440; }
            updateSky(m);
            requestAnimationFrame(loop);
        }
        function togglePopup() { document.getElementById('popup').classList.toggle('active'); }
        requestAnimationFrame(loop);
    </script>
</body>
</html>