<!DOCTYPE html>
<html lang="ko" class="dark:bg-[#232323]">
  <head>
    <meta charset="UTF-8">
    <title>ÏøºÌÑ∞ÌååÏù¥</title>
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/logo_dark.ico" media="(prefers-color-scheme: dark)">
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico" media="(prefers-color-scheme: light)">
    <meta property="og:url" content="https://qpi.kro.kr/">
    <meta property="og:title" content="ÏøºÌÑ∞ÌååÏù¥">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/logo.png">
    <meta property="og:description" content="ÏøºÌÑ∞ÌååÏù¥ - ÏõπÍ∞úÎ∞ú ÎèôÏïÑÎ¶¨">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- JQuery + Google login -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css');
        @import url('https://fonts.cdnfonts.com/css/br-cobane');

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard Variable', 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        #login {
            position: relative;
        }

        #login-mockup {
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid #dadce0;
            display: none;
            transition: background-color 0.218s, border-color 0.218s;
            height: 100%;
            aspect-ratio: 1;
            position: absolute;
            right: 0;
            top: 0;
            align-items: center;
            justify-content: center;
        }
        #login-mockup:hover {
            border-color: #d2e3fc;
            background-color: rgba(66, 133, 244, .08)
        }
        .pfp {
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            visibility: hidden;
        }

        @media screen and (prefers-color-scheme: dark) {
            #login {
                filter: brightness(0.863) invert(1);
            }
            .pfp {
                filter: brightness(0.863) invert(1);
            }
        }

        /* Ï±ÑÌåÖ Ïä§ÌÉÄÏùº */
        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-bubble-left {
            background: #f1f3f4;
            border-radius: 18px 18px 18px 4px;
            color: #202124;
        }
        
        .chat-bubble-right {
            background: #1a73e8;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        
        @media (prefers-color-scheme: dark) {
            .chat-bubble-left {
                background: #3c4043;
                color: #e8eaed;
            }
            
            .chat-bubble-right {
                background: #8ab4f8;
                color: #202124;
            }
        }

        .message-input {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 24px;
            padding: 12px 20px;
            outline: none;
            transition: all 0.2s;
            width: 100%;
        }
        
        .message-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        @media (prefers-color-scheme: dark) {
            .message-input {
                background: #3c4043;
                border-color: #5f6368;
                color: #e8eaed;
            }
            
            .message-input:focus {
                border-color: #8ab4f8;
                box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2);
            }
        }

        .send-button {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: #1557b0;
        }
        
        .send-button:disabled {
            background: #dadce0;
            cursor: not-allowed;
        }
        
        @media (prefers-color-scheme: dark) {
            .send-button {
                background: #8ab4f8;
                color: #202124;
            }
            
            .send-button:hover:not(:disabled) {
                background: #669df6;
            }
            
            .send-button:disabled {
                background: #5f6368;
                color: #9aa0a6;
            }
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background: #34a853;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        
        @media (prefers-color-scheme: dark) {
            .online-indicator {
                border-color: #232323;
            }
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }
        
        @media (prefers-color-scheme: dark) {
            .chat-messages::-webkit-scrollbar-thumb {
                background: #5f6368;
            }
            
            .chat-messages::-webkit-scrollbar-thumb:hover {
                background: #80868b;
            }
        }

        /* Î©îÏãúÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .message-enter {
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-container {
            height: calc(100vh - 160px);
            min-height: 500px;
        }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen">
    <!-- Ìó§Îçî -->
    <header class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
      <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
              <span class="text-white font-bold text-lg">üî•</span>
            </div>
            <div>
              <h1 class="text-xl font-bold text-gray-900 dark:text-white">Î†àÎìúÎ∂à Ï±ÑÌåÖ</h1>
              <p class="text-sm text-gray-500 dark:text-gray-400">QPI ÎèôÏïÑÎ¶¨ Ï±ÑÌåÖÎ∞©</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span>Ïò®ÎùºÏù∏</span>
            </div>
            <div id="login">
              <div id="g_id_onload"
                data-client_id="1079132266010-4r209j6rtmohatvtf74cksqcq7cn4uv0.apps.googleusercontent.com"
                data-context="use"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false">
              </div>
              <div id="login-button" class="g_id_signin"
                  data-type="icon"
                  data-shape="circle"
                  data-theme="outline"
                  data-text="continue_with"
                  data-size="medium"
                  data-width="200">
              </div>
              <div id="login-mockup" class="relative">
                <img class="pfp" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWM4AwAAzgDNUwEBJAAAAABJRU5ErkJggg=="/>
                <div class="online-indicator"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="max-w-4xl mx-auto p-4">
      <div id="root"></div>
    </div>
    
    <script>
      const AUTH_URL = "https://script.google.com/macros/s/AKfycbwJkCkPJTg2AKKVNncedK7r--Txh9iexICytoDg6ajIpA2vYej7fv7AadCCuhRb9Qs9/exec"
      var storage = {}

      async function handleCredentialResponse(response) {
        const idToken = response.credential;
        $(".g_id_signin").css("visibility", "hidden");
        $("#login-mockup").css("display", "flex");
        const res = await fetch(AUTH_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ idToken })
        });

        const data = await res.json();
        if (!data.success) {
          console.error(`fail: ${JSON.stringify(data)}`);
          return;
        }
        try {
          $(".pfp").css("visibility", "visible");
          $(".pfp").attr("src",data.pfp);
        } finally {
          storage.sub = data.sub;
          storage.name = data.name;
          storage.authdate = data.date;
          storage.auth = data.auth;
        }
      }
    </script>

    <script type="text/babel">
      const { useEffect, useState, useRef } = React;

      const URL = "https://script.google.com/macros/s/AKfycbxxXzzaUsogJ1ZwgQwbfs6jUR9MY0iu51do0PWURuNlusx_Vjp0A3eqjZGFuRzMaVTl/exec"
      var aborts = new Set();

      function ChatApp() {
        const getSeoulNow = () => new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
        const formatTime = (date) => {
          const d = new Date(date);
          const hours = d.getHours().toString().padStart(2, "0");
          const minutes = d.getMinutes().toString().padStart(2, "0");
          return `${hours}:${minutes}`;
        };

        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState("");
        const [isLoading, setIsLoading] = useState(true);
        const [isSending, setIsSending] = useState(false);
        const [error, setError] = useState("");
        const [lastReload, setLastReload] = useState(new Date(0));
        
        const messagesEndRef = useRef(null);
        const chatContainerRef = useRef(null);

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        useEffect(() => {
          scrollToBottom();
        }, [messages]);

        // Î©îÏãúÏßÄ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
        useEffect(() => {
          const interval = setInterval(() => {
            if (!isSending && getSeoulNow() - lastReload > 3000) {
              fetchMessages();
            }
          }, 3000);

          return () => clearInterval(interval);
        }, [lastReload, isSending]);

        // Ï¥àÍ∏∞ Î©îÏãúÏßÄ Î°úÎìú
        useEffect(() => {
          fetchMessages();
        }, []);

        const fetchMessages = async () => {
          if (aborts.size !== 0) return;
          
          const ctrl = new AbortController();
          const signal = ctrl.signal;
          aborts.add(ctrl);

          try {
            const response = await fetch(URL, {
              signal,
              method: "GET",
              redirect: "follow"
            });
            
            const data = await response.text();
            const parsedMessages = JSON.parse(data).map((e) => ({
              id: e[0],
              sub: e[1], 
              name: e[2],
              content: e[3],
              timestamp: e[0]
            }));

            setMessages(parsedMessages);
            setIsLoading(false);
            setLastReload(getSeoulNow());
          } catch (error) {
            if (!signal.aborted) {
              console.error('Error:', error);
              setError("Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
          } finally {
            aborts.delete(ctrl);
          }
        };

        const sendMessage = async (e) => {
          e.preventDefault();
          
          if (!newMessage.trim()) return;
          
          if (!storage.sub) {
            setError("Î®ºÏ†Ä Íµ¨Í∏Ä Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
          }

          setError("");
          setIsSending(true);

          const data = {
            contents: newMessage.trim(),
            sub: storage.sub,
            name: storage.name,
            authdate: storage.authdate,
            auth: storage.auth
          };

          // ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏ - Ï¶âÏãú UIÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
          const tempMessage = {
            id: Date.now(),
            sub: storage.sub,
            name: storage.name,
            content: newMessage.trim(),
            timestamp: Date.now(),
            isTemp: true
          };

          setMessages(prev => [...prev, tempMessage]);
          setNewMessage("");

          // Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ëÎã®
          for (const controller of aborts) {
            controller.abort();
          }

          try {
            const response = await fetch(URL, {
              method: "POST",
              redirect: "follow",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              body: JSON.stringify(data),
            });

            const result = await response.text();
            
            if (result.startsWith("fail")) {
              const msg = result.substring(6).split("\n");
              setError(msg[0]);
              
              // ÏûÑÏãú Î©îÏãúÏßÄ Ï†úÍ±∞
              setMessages(prev => prev.filter(m => !m.isTemp));
              
              if (msg.length >= 2) {
                const serverMessages = JSON.parse(msg[1]).map((e) => ({
                  id: e[0],
                  sub: e[1],
                  name: e[2], 
                  content: e[3],
                  timestamp: e[0]
                }));
                setMessages(serverMessages);
              }
            } else {
              const serverMessages = JSON.parse(result).map((e) => ({
                id: e[0],
                sub: e[1],
                name: e[2],
                content: e[3], 
                timestamp: e[0]
              }));
              setMessages(serverMessages);
            }
          } catch (error) {
            console.error('Error:', error);
            setError("Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            // ÏûÑÏãú Î©îÏãúÏßÄ Ï†úÍ±∞
            setMessages(prev => prev.filter(m => !m.isTemp));
          } finally {
            setIsSending(false);
          }
        };

        const deleteMessage = async (messageId) => {
          if (!storage.sub) return;

          setError("");
          setIsSending(true);

          const data = {
            studentId: "DELETE",
            key: messageId,
            sub: storage.sub,
            authdate: storage.authdate,
            auth: storage.auth
          };

          try {
            const response = await fetch(URL, {
              method: "POST",
              redirect: "follow",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              body: JSON.stringify(data),
            });

            const result = await response.text();

            if (result.startsWith("fail")) {
              const msg = result.substring(6).split("\n");
              setError(msg[0]);
              if (msg.length >= 2) {
                const serverMessages = JSON.parse(msg[1]).map((e) => ({
                  id: e[0],
                  sub: e[1],
                  name: e[2],
                  content: e[3],
                  timestamp: e[0]
                }));
                setMessages(serverMessages);
              }
            } else {
              const serverMessages = JSON.parse(result).map((e) => ({
                id: e[0],
                sub: e[1],
                name: e[2],
                content: e[3],
                timestamp: e[0]
              }));
              setMessages(serverMessages);
            }
          } catch (error) {
            console.error('Error:', error);
            setError("Î©îÏãúÏßÄ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
          } finally {
            setIsSending(false);
          }
        };

        const groupMessagesByTime = (messages) => {
          const grouped = [];
          let currentGroup = null;
          
          messages.forEach((message, index) => {
            const messageTime = new Date(message.timestamp);
            const prevMessage = messages[index - 1];
            const prevTime = prevMessage ? new Date(prevMessage.timestamp) : null;
            
            const shouldGroup = prevMessage && 
              prevMessage.sub === message.sub && 
              prevTime &&
              (messageTime - prevTime) < 60000; // 1Î∂Ñ Ïù¥ÎÇ¥

            if (!shouldGroup) {
              if (currentGroup) grouped.push(currentGroup);
              currentGroup = {
                user: message.name,
                sub: message.sub,
                timestamp: message.timestamp,
                messages: [message]
              };
            } else {
              currentGroup.messages.push(message);
            }
          });
          
          if (currentGroup) grouped.push(currentGroup);
          return grouped;
        };

        const messageGroups = groupMessagesByTime(messages);

        return (
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden chat-container flex flex-col">
            {/* Ï±ÑÌåÖ Î©îÏãúÏßÄ ÏòÅÏó≠ */}
            <div 
              ref={chatContainerRef}
              className="chat-messages flex-1 overflow-y-auto p-6 space-y-4"
            >
              {isLoading ? (
                <div className="flex items-center justify-center h-32">
                  <div className="flex items-center gap-3 text-gray-500 dark:text-gray-400">
                    <div className="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <span>Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                  </div>
                </div>
              ) : messageGroups.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-gray-500 dark:text-gray-400">
                  <div className="text-8xl mb-6">üí¨</div>
                  <div className="text-xl font-medium mb-2">Ï±ÑÌåÖÎ∞©Ïóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!</div>
                  <div className="text-sm">Ï≤´ Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî.</div>
                </div>
              ) : (
                messageGroups.map((group, groupIndex) => (
                  <div key={groupIndex} className="space-y-2">
                    {/* ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∞è ÏãúÍ∞Ñ */}
                    <div className={`flex items-center gap-3 mb-3 ${group.sub === storage.sub ? 'justify-end' : 'justify-start'}`}>
                      {group.sub !== storage.sub && (
                        <>
                          <div className="w-8 h-8 bg-gradient-to-br from-purple-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg">
                            {group.user?.charAt(0)?.toUpperCase() || '?'}
                          </div>
                          <span className="text-sm font-semibold text-gray-700 dark:text-gray-300">
                            {group.user}
                          </span>
                        </>
                      )}
                      <span className="text-xs text-gray-500 dark:text-gray-400">
                        {formatTime(group.timestamp)}
                      </span>
                    </div>
                    
                    {/* Î©îÏãúÏßÄÎì§ */}
                    <div className={`space-y-2 ${group.sub === storage.sub ? 'flex flex-col items-end' : ''}`}>
                      {group.messages.map((message) => (
                        <div
                          key={message.id}
                          className={`group relative ${message.isTemp ? 'opacity-70' : 'message-enter'}`}
                        >
                          <div className={`chat-bubble px-4 py-3 shadow-sm ${
                            message.sub === storage.sub 
                              ? 'chat-bubble-right' 
                              : 'chat-bubble-left'
                          }`}>
                            {message.sub === -1 ? (
                              <span className="italic text-gray-400">ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄ</span>
                            ) : (
                              <span className="break-words text-sm leading-relaxed">{message.content}</span>
                            )}
                          </div>
                          
                          {/* ÏÇ≠Ï†ú Î≤ÑÌäº */}
                          {message.sub === storage.sub && message.sub !== -1 && (
                            <button
                              onClick={() => deleteMessage(message.id)}
                              className="absolute -top-8 right-0 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 text-white text-xs px-2 py-1 rounded-full hover:bg-red-600 shadow-lg"
                              disabled={isSending}
                            >
                              ÏÇ≠Ï†ú
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                ))
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* ÏóêÎü¨ Î©îÏãúÏßÄ */}
            {error && (
              <div className="mx-6 mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-400 text-sm">
                ‚ö†Ô∏è {error}
              </div>
            )}

            {/* Î©îÏãúÏßÄ ÏûÖÎ†• ÏòÅÏó≠ */}
            <div className="p-6 bg-gray-50 dark:bg-gray-700/50 border-t border-gray-200 dark:border-gray-600">
              <form onSubmit={sendMessage} className="flex items-end gap-3">
                <div className="flex-1">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={(e) => setNewMessage(e.target.value)}
                    placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                    className="message-input"
                    disabled={isSending}
                    maxLength={500}
                  />
                </div>
                <button
                  type="submit"
                  className="send-button"
                  disabled={isSending || !newMessage.trim()}
                >
                  {isSending ? (
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  ) : (
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                    </svg>
                  )}
                </button>
              </form>
              {newMessage.length > 450 && (
                <div className="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">
                  {newMessage.length}/500
                </div>
              )}
            </div>
          </div>
        );
      }
        
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<ChatApp />);
    </script>
  </body>
</html>