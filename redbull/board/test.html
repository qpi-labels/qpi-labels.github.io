<!DOCTYPE html>
<html lang="ko" class="dark:bg-[#232323]">
  <head>
    <meta charset="UTF-8">
    <title>쿼터파이</title>
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/logo_dark.ico" media="(prefers-color-scheme: dark)">
    <link rel="shortcut icon" type="image/x-icon" href="/logo.ico" media="(prefers-color-scheme: light)">
    <meta property="og:url" content="https://qpi.kro.kr/">
    <meta property="og:title" content="쿼터파이">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/logo.png">
    <meta property="og:description" content="쿼터파이 - 웹개발 동아리">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- JQuery + Google login -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css');

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard Variable', 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        #login {
            position: relative;
        }

        #login-mockup {
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid #dadce0;
            display: none;
            transition: background-color 0.218s, border-color 0.218s;
            height: 100%;
            aspect-ratio: 1;
            position: absolute;
            right: 0;
            top: 0;
            align-items: center;
            justify-content: center;
        }
        #login-mockup:hover {
            border-color: #d2e3fc;
            background-color: rgba(66, 133, 244, .08)
        }
        .pfp {
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            visibility: hidden;
        }

        @media screen and (prefers-color-scheme: dark) {
            #login {
                filter: brightness(0.863) invert(1);
            }
            .pfp {
                filter: brightness(0.863) invert(1);
            }
        }

        /* 미니멀 채팅 스타일 */
        .chat-bubble-left {
            background: #f0f0f0;
            color: #000;
            border-radius: 12px;
            padding: 10px 14px;
            max-width: 70%;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .chat-bubble-right {
            background: #007AFF;
            color: white;
            border-radius: 12px;
            padding: 10px 14px;
            max-width: 70%;
            margin-left: auto;
            word-wrap: break-word;
            word-break: normal;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        @media (prefers-color-scheme: dark) {
            .chat-bubble-left {
                background: #2C2C2E;
                color: #FFFFFF;
            }
        }

        .message-input {
            background: #f6f6f6;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 20px;
            outline: none;
            transition: all 0.2s;
            width: 100%;
            font-size: 14px;
        }
        
        .message-input:focus {
            border-color: #007AFF;
            background: #fff;
        }
        
        @media (prefers-color-scheme: dark) {
            .message-input {
                background: #2C2C2E;
                border-color: #38383A;
                color: #FFFFFF;
            }
            
            .message-input:focus {
                border-color: #007AFF;
                background: #1C1C1E;
            }
        }

        .send-button {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            background: #0051D0;
        }
        
        .send-button:disabled {
            background: #C7C7CC;
            cursor: not-allowed;
        }

        /* 스크롤바 숨기기 */
        .chat-messages {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-messages::-webkit-scrollbar {
            display: none;
        }

        .chat-container {
            height: calc(100vh - 120px);
            min-height: 400px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .logout-button {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .logout-button:hover {
            background: #d70015;
        }
    </style>
  </head>
  <body class="bg-white dark:bg-black">
    <!-- 미니멀 헤더 -->
    <header class="bg-white dark:bg-black border-b border-gray-200 dark:border-gray-800">
      <div class="max-w-2xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="text-lg font-semibold text-gray-900 dark:text-white">레드불 채팅</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">QPI 동아리 채팅방</div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 text-sm text-green-600 dark:text-green-400">
              <div class="w-2 h-2 bg-green-500 rounded-full"></div>
              <span>온라인</span>
            </div>
            <div id="login">
              <div id="g_id_onload"
                data-client_id="1079132266010-4r209j6rtmohatvtf74cksqcq7cn4uv0.apps.googleusercontent.com"
                data-context="use"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false">
              </div>
              <div id="login-button" class="g_id_signin"
                  data-type="icon"
                  data-shape="circle"
                  data-theme="outline"
                  data-text="continue_with"
                  data-size="medium"
                  data-width="200">
              </div>
              <div id="login-mockup">
                <img class="pfp" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWM4AwAAzgDNUwEBJAAAAABJRU5ErkJggg=="/>
                <button class="logout-button" onclick="logout()">로그아웃</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- 메인 컨테이너 -->
    <div class="max-w-2xl mx-auto">
      <div id="root"></div>
    </div>
    
    <script>
      const AUTH_URL = "https://script.google.com/macros/s/AKfycbwJkCkPJTg2AKKVNncedK7r--Txh9iexICytoDg6ajIpA2vYej7fv7AadCCuhRb9Qs9/exec"
      var storage = {}

      // 로컬 스토리지에서 로그인 정보 로드
      function loadUserData() {
        try {
          const savedData = localStorage.getItem('chatApp_userData');
          if (savedData) {
            const userData = JSON.parse(savedData);
            // 저장된 데이터가 24시간 이내인 경우에만 복원
            if (userData.timestamp && (Date.now() - userData.timestamp) < 24 * 60 * 60 * 1000) {
              storage = userData;
              updateLoginUI();
              return true;
            } else {
              // 24시간이 지난 데이터는 삭제
              localStorage.removeItem('chatApp_userData');
            }
          }
        } catch (error) {
          console.error('Failed to load user data:', error);
          localStorage.removeItem('chatApp_userData');
        }
        return false;
      }

      // 로컬 스토리지에 로그인 정보 저장
      function saveUserData() {
        try {
          const dataToSave = {
            ...storage,
            timestamp: Date.now()
          };
          localStorage.setItem('chatApp_userData', JSON.stringify(dataToSave));
        } catch (error) {
          console.error('Failed to save user data:', error);
        }
      }

      // 로그인 UI 업데이트
      function updateLoginUI() {
        if (storage.sub) {
          $(".g_id_signin").css("visibility", "hidden");
          $("#login-mockup").css("display", "flex");
          $(".pfp").css("visibility", "visible");
          if (storage.pfp) {
            $(".pfp").attr("src", storage.pfp);
          }
        } else {
          $(".g_id_signin").css("visibility", "visible");
          $("#login-mockup").css("display", "none");
          $(".pfp").css("visibility", "hidden");
        }
      }

      // 로그아웃 함수
      function logout() {
        storage = {};
        localStorage.removeItem('chatApp_userData');
        updateLoginUI();
        // 페이지 새로고침으로 상태 초기화
        location.reload();
      }

      async function handleCredentialResponse(response) {
        const idToken = response.credential;
        $(".g_id_signin").css("visibility", "hidden");
        $("#login-mockup").css("display", "flex");
        
        try {
          const res = await fetch(AUTH_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ idToken })
          });

          const data = await res.json();
          if (!data.success) {
            console.error(`fail: ${JSON.stringify(data)}`);
            updateLoginUI(); // 실패 시 UI 복원
            return;
          }
          
          // 로그인 정보 저장
          storage.sub = data.sub;
          storage.name = data.name;
          storage.authdate = data.date;
          storage.auth = data.auth;
          storage.pfp = data.pfp;
          
          // 로컬 스토리지에 저장
          saveUserData();
          
          // UI 업데이트
          updateLoginUI();
          
        } catch (error) {
          console.error('Login failed:', error);
          updateLoginUI(); // 실패 시 UI 복원
        }
      }

      // 페이지 로드 시 저장된 로그인 정보 복원
      document.addEventListener('DOMContentLoaded', () => {
        loadUserData();
      });
    </script>

    <script type="text/babel">
      const { useEffect, useState, useRef } = React;

      const URL = "https://script.google.com/macros/s/AKfycbxxXzzaUsogJ1ZwgQwbfs6jUR9MY0iu51do0PWURuNlusx_Vjp0A3eqjZGFuRzMaVTl/exec"
      var aborts = new Set();

      function ChatApp() {
        const getSeoulNow = () => new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
        const formatTime = (date) => {
          const d = new Date(date);
          const hours = d.getHours().toString().padStart(2, "0");
          const minutes = d.getMinutes().toString().padStart(2, "0");
          return `${hours}:${minutes}`;
        };

        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState("");
        const [isLoading, setIsLoading] = useState(true);
        const [isSending, setIsSending] = useState(false);
        const [error, setError] = useState("");
        const [lastReload, setLastReload] = useState(new Date(0));
        const [isLoggedIn, setIsLoggedIn] = useState(false);
        
        const messagesEndRef = useRef(null);

        // 로그인 상태 체크
        useEffect(() => {
          const checkLoginStatus = () => {
            setIsLoggedIn(!!storage.sub);
          };

          checkLoginStatus();
          const interval = setInterval(checkLoginStatus, 500);
          return () => clearInterval(interval);
        }, []);

        const scrollToBottom = () => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        useEffect(() => {
          scrollToBottom();
        }, [messages]);

        // 1초마다 새로고침
        useEffect(() => {
          const interval = setInterval(() => {
            if (!isSending && getSeoulNow() - lastReload > 1000) {
              fetchMessages();
            }
          }, 1000);

          return () => clearInterval(interval);
        }, [lastReload, isSending]);

        // 초기 메시지 로드
        useEffect(() => {
          fetchMessages();
        }, []);

        const fetchMessages = async () => {
          if (aborts.size !== 0) return;
          
          const ctrl = new AbortController();
          const signal = ctrl.signal;
          aborts.add(ctrl);

          try {
            const response = await fetch(URL, {
              signal,
              method: "GET",
              redirect: "follow",
              cache: "no-cache", // 캐시 방지로 최신 데이터 보장
              headers: {
                "Cache-Control": "no-cache"
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            const parsedMessages = JSON.parse(data).map((e) => ({
              id: e[0],
              sub: e[1], 
              name: e[2],
              content: e[3],
              timestamp: e[0]
            }));

            // 메시지가 실제로 변경되었을 때만 상태 업데이트
            setMessages(prevMessages => {
              if (JSON.stringify(prevMessages) !== JSON.stringify(parsedMessages)) {
                return parsedMessages;
              }
              return prevMessages;
            });
            
            if (isLoading) setIsLoading(false);
            setLastReload(getSeoulNow());
          } catch (error) {
            if (!signal.aborted) {
              console.error('Error fetching messages:', error);
              if (isLoading) {
                setError("메시지를 불러오는데 실패했습니다.");
                setIsLoading(false);
              }
            }
          } finally {
            aborts.delete(ctrl);
          }
        };

        const sendMessage = async (e) => {
          e.preventDefault();
          
          if (!newMessage.trim()) return;
          
          if (!storage.sub) {
            setError("먼저 구글 계정으로 로그인해주세요.");
            return;
          }

          setError("");
          setIsSending(true);

          const data = {
            contents: newMessage.trim(),
            sub: storage.sub,
            name: storage.name,
            authdate: storage.authdate,
            auth: storage.auth
          };

          // 낙관적 업데이트
          const tempMessage = {
            id: Date.now(),
            sub: storage.sub,
            name: storage.name,
            content: newMessage.trim(),
            timestamp: Date.now(),
            isTemp: true
          };

          setMessages(prev => [...prev, tempMessage]);
          setNewMessage("");

          // 메시지 전송 중단
          for (const controller of aborts) {
            controller.abort();
          }

          try {
            const response = await fetch(URL, {
              method: "POST",
              redirect: "follow",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              body: JSON.stringify(data),
            });

            const result = await response.text();
            
            if (result.startsWith("fail")) {
              const msg = result.substring(6).split("\n");
              setError(msg[0]);
              
              // 임시 메시지 제거
              setMessages(prev => prev.filter(m => !m.isTemp));
              
              if (msg.length >= 2) {
                const serverMessages = JSON.parse(msg[1]).map((e) => ({
                  id: e[0],
                  sub: e[1],
                  name: e[2], 
                  content: e[3],
                  timestamp: e[0]
                }));
                setMessages(serverMessages);
              }
            } else {
              const serverMessages = JSON.parse(result).map((e) => ({
                id: e[0],
                sub: e[1],
                name: e[2],
                content: e[3], 
                timestamp: e[0]
              }));
              setMessages(serverMessages);
            }
          } catch (error) {
            console.error('Error:', error);
            setError("메시지 전송에 실패했습니다.");
            // 임시 메시지 제거
            setMessages(prev => prev.filter(m => !m.isTemp));
          } finally {
            setIsSending(false);
          }
        };

        const deleteMessage = async (messageId) => {
          if (!storage.sub) return;

          const data = {
            studentId: "DELETE",
            key: messageId,
            sub: storage.sub,
            authdate: storage.authdate,
            auth: storage.auth
          };

          try {
            const response = await fetch(URL, {
              method: "POST",
              redirect: "follow",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              body: JSON.stringify(data),
            });

            const result = await response.text();

            if (result.startsWith("fail")) {
              const msg = result.substring(6).split("\n");
              setError(msg[0]);
              if (msg.length >= 2) {
                const serverMessages = JSON.parse(msg[1]).map((e) => ({
                  id: e[0],
                  sub: e[1],
                  name: e[2],
                  content: e[3],
                  timestamp: e[0]
                }));
                setMessages(serverMessages);
              }
            } else {
              const serverMessages = JSON.parse(result).map((e) => ({
                id: e[0],
                sub: e[1],
                name: e[2],
                content: e[3],
                timestamp: e[0]
              }));
              setMessages(serverMessages);
            }
          } catch (error) {
            console.error('Error:', error);
            setError("메시지 삭제에 실패했습니다.");
          }
        };

        return (
          <div className="chat-container flex flex-col">
            {/* 로그인 안내 */}
            {!isLoggedIn && (
              <div className="mx-4 mt-4 mb-2 px-4 py-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg text-blue-600 dark:text-blue-400 text-sm text-center">
                💡 우상단의 구글 로그인을 통해 채팅에 참여하세요
              </div>
            )}

            {/* 채팅 메시지 영역 */}
            <div className="chat-messages flex-1 overflow-y-auto px-4 py-6">
              {isLoading ? (
                <div className="flex items-center justify-center h-32">
                  <div className="text-gray-400 text-sm">메시지를 불러오는 중...</div>
                </div>
              ) : messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                  <div className="text-4xl mb-3">💬</div>
                  <div className="text-sm">
                    {isLoggedIn ? "첫 메시지를 보내보세요" : "로그인 후 채팅을 시작할 수 있습니다"}
                  </div>
                </div>
              ) : (
                <div className="space-y-3">
                  {messages.map((message, index) => {
                    const showAvatar = index === 0 || messages[index - 1]?.sub !== message.sub;
                    const showTime = index === messages.length - 1 || 
                      messages[index + 1]?.sub !== message.sub ||
                      (new Date(messages[index + 1]?.timestamp) - new Date(message.timestamp)) > 60000;
                    
                    return (
                      <div key={message.id}>
                        <div className={`flex gap-2 ${message.sub === storage.sub ? 'flex-row-reverse' : 'flex-row'} ${message.isTemp ? 'opacity-60' : ''}`}>
                          {/* 아바타 */}
                          <div className={`flex-shrink-0 ${showAvatar ? '' : 'invisible'}`}>
                            {message.sub !== storage.sub && (
                              <div className="user-avatar">
                                {message.name?.charAt(0)?.toUpperCase() || '?'}
                              </div>
                            )}
                          </div>
                          
                          {/* 메시지 */}
                          <div className={`flex flex-col ${message.sub === storage.sub ? 'items-end' : 'items-start'}`}>
                            {showAvatar && message.sub !== storage.sub && (
                              <div className="text-xs text-gray-500 dark:text-gray-400 mb-1 ml-1">
                                {message.name}
                              </div>
                            )}
                            
                            <div className="group relative">
                              {message.sub === -1 ? (
                                <div className="text-xs text-gray-400 italic px-3 py-2">
                                  메시지가 삭제되었습니다
                                </div>
                              ) : (
                                <div className={`${message.sub === storage.sub ? 'chat-bubble-right' : 'chat-bubble-left'}`}>
                                  <span className="text-sm leading-relaxed">{message.content}</span>
                                </div>
                              )}
                              
                              {/* 삭제 버튼 */}
                              {message.sub === storage.sub && message.sub !== -1 && (
                                <button
                                  onClick={() => deleteMessage(message.id)}
                                  className="absolute -top-6 right-0 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-red-500 hover:text-red-600"
                                >
                                  삭제
                                </button>
                              )}
                            </div>
                            
                            {showTime && (
                              <div className={`text-xs text-gray-400 mt-1 ${message.sub === storage.sub ? 'mr-1' : 'ml-1'}`}>
                                {formatTime(message.timestamp)}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* 에러 메시지 */}
            {error && (
              <div className="mx-4 mb-3 px-3 py-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm">
                {error}
              </div>
            )}

            {/* 메시지 입력 영역 */}
            <div className="px-4 py-3 border-t border-gray-200 dark:border-gray-800">
              <form onSubmit={sendMessage} className="flex items-center gap-3">
                <input
                  type="text"
                  value={newMessage}
                  onChange={(e) => setNewMessage(e.target.value)}
                  placeholder={isLoggedIn ? "메시지를 입력하세요..." : "로그인 후 메시지를 보낼 수 있습니다"}
                  className="message-input"
                  disabled={isSending || !isLoggedIn}
                />
                <button
                  type="submit"
                  className="send-button"
                  disabled={isSending || !newMessage.trim() || !isLoggedIn}
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                  </svg>
                </button>
              </form>
            </div>
          </div>
        );
      }
        
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<ChatApp />);
    </script>
  </body>
</html>